[{"categories":["2022","kubernetes","documentation"],"content":"æœ€è¿‘åœ¨æåœ¨å†…éƒ¨è‡ªç ”å¹³å°ä¸Šåšä¸€äº› NUMA æ„ŸçŸ¥è°ƒåº¦çš„å·¥ä½œï¼Œæ¶‰åŠåˆ° kubernetes èŠ‚ç‚¹èµ„æºæ‹“æ‰‘çš„å‘ç°ä»¥åŠè°ƒåº¦æ–¹é¢çš„å†…å®¹ã€‚ä½†æ˜¯æ— å¥ˆæ‰ç–å­¦æµ…ï¼Œé‡åˆ°é—®é¢˜æŸ¥é—®é¢˜ï¼Œä¸€çŸ¥åŠè§£çš„å§‹ç»ˆæŠ“ä¸åˆ°å¤´ç»ªï¼Œè°¨ä»¥æ­¤ç¯‡æ–‡ç« æ¥æ¢³ç†æ€»ç»“ã€‚ ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:0:0","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"ä¸ºå•¥éœ€è¦æ„ŸçŸ¥æ‹“æ‰‘ è¿™é‡Œ kubernetes å®˜æ–¹è¯´äº†ï¼šç›®å‰è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿåˆ©ç”¨ CPU å’Œç¡¬ä»¶åŠ é€Ÿå™¨ï¼Œæ¯”å¦‚ GPU,DPU æ¥æ”¯æŒä½å»¶è¿Ÿçš„ä»»åŠ¡ä»¥åŠé«˜ååçš„å¹¶è¡Œè®¡ç®—ä»»åŠ¡ã€‚ ä½†æ˜¯å¥½åƒåˆè¯´çš„ä¸æ¸…æ¥šï¼Œå…¶å®æœ¬è´¨åŸå› æ˜¯å†¯è¯ºä¾æ›¼æ¶æ„å¸¦æ¥çš„é—®é¢˜ã€‚è¿˜æ˜¯é‚£å¥è€è¯ï¼Œæ²¡æœ‰é“¶å¼¹ï¼Œå†¯è¯ºä¾æ›¼æ¶æ„å°†å­˜å‚¨å™¨å’Œè¿ç®—å™¨åˆ†å¼€ï¼ŒæŒ‡ä»¤å’Œæ•°æ®å‡æ”¾åœ¨å­˜å‚¨å™¨ï¼Œä¸ºç°ä»£è®¡ç®—çš„é€šç”¨æ€§å¥ å®šäº†åŸºç¡€ã€‚ä½†æ˜¯ä¹ŸåŸ‹ä¸‹äº†éšæ‚£ï¼Œé‚£å°±æ˜¯å†…å­˜å®¹é‡æŒ‡æ•°çº§æå‡åï¼ŒCPU å’Œå†…å­˜ä¹‹å‰çš„æ•°æ®ä¼ è¾“æˆä¸ºäº†ç“¶é¢ˆã€‚ç›®å‰æœåŠ¡å™¨ä¸­çš„è®¾å¤‡åŸºæœ¬éƒ½æ˜¯é€šè¿‡ PCIe æ€»çº¿è¿›è¡Œé«˜é€Ÿè¿æ¥ï¼Œè€Œä¸åŒçš„ç”¨é€”çš„æœåŠ¡å™¨å¯èƒ½å…¶æ€»çº¿å¸ƒå±€ä¹Ÿä¸ç›¸åŒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆç½‘ä¸Šæ‰¾åˆ°çš„ï¼Œéæœ¬äººæ‰€ç”»ï¼‰,å·¦å›¾ GPU é©»ç•™åœ¨ä¸åŒçš„ PCIe åŸŸä¸Šï¼ŒGPU å†…å­˜ä¹‹é—´çš„ç›´æ¥ P2P å¤åˆ¶æ˜¯ä¸å¯èƒ½çš„ï¼Œä» GPU 0 çš„å†…å­˜å¤åˆ¶åˆ° GPU 2 çš„å†…å­˜éœ€è¦é¦–å…ˆé€šè¿‡ PCIe å¤åˆ¶åˆ°è¿æ¥åˆ° CPU 0 çš„å†…å­˜ï¼Œç„¶åé€šè¿‡ QPI é“¾æ¥ä¼ è¾“åˆ° CPU 1 å¹¶å†æ¬¡é€šè¿‡ PCIe ä¼ è¾“åˆ° GPU 2ã€‚å¯ä»¥æƒ³è±¡è¿™ä¸ªè¿‡ç¨‹åœ¨å»¶è¿Ÿå’Œå¸¦å®½æ–¹é¢å¢åŠ äº†å¤§é‡çš„å¼€é”€ï¼Œè€Œå³å›¾å¯ä»¥é€šè¿‡ GPU P2P è¿æ¥å®ç°è¶…é«˜é€Ÿé€šä¿¡ã€‚ç®€å•æ€»ç»“ä¸‹ï¼Œæ‹“æ‰‘ä¼šå½±å“è®¾å¤‡é—´çš„é€šä¿¡ï¼Œé€šä¿¡å¯¹ä¸šåŠ¡é€ æˆç¨³å®šæ€§ä»¥åŠæ•ˆç‡ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µè®©ä¸šåŠ¡æ„ŸçŸ¥æ‹“æ‰‘ã€‚ PCIe Topo (figure 1) ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:1:0","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"æ‹“æ‰‘ç±»å‹ ç›®å‰æœ‰å“ªäº›æ‹“æ‰‘éœ€è¦æ„ŸçŸ¥: GPU Topology Awareness NUMA Topology Awareness ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:2:0","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"GPU Topology Manager ä¸šç•Œç›®å‰æœ‰å‡ ç§å®ç°æ–¹æ¡ˆï¼š Volcano GPU Topology Awareness ç™¾åº¦æ™ºèƒ½äº‘ GPU æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦ Volcano ç›®å‰æœªå®Œå…¨å®ç°ï¼Œæ™ºèƒ½äº‘é—­æºåªèƒ½é€šè¿‡ä¸€äº›åˆ†äº«çš„ä¿¡æ¯ï¼Œç®¡ä¸­çª¥è±¹ã€‚ Why ä¸ºä»€ä¹ˆéœ€è¦ GPU çš„æ‹“æ‰‘æ„ŸçŸ¥ï¼Œé¦–å…ˆä¸Šä¸ªå›¾ï¼Œè¿™å¼ å›¾æ¥è‡ª NVIDIA å®˜æ–¹ï¼Œæè¿°äº†ç°åœ¨ä¸»æµçš„ GPU æ˜¾å¡ V100 åœ¨æœåŠ¡å™¨ä¸­çš„æ‹“æ‰‘å…³ç³»ã€‚ GPU Topo (figure 2) æ¯å— V100 GPUæœ‰6ä¸ª NVLink é€šé“ï¼Œ8å— GPU é—´æ— æ³•åšåˆ°å…¨è¿æ¥ï¼Œ2å— GPU é—´æœ€å¤šåªèƒ½æœ‰2æ¡ NVLink è¿æ¥ã€‚å…¶ä¸­ GPU0 å’Œ GPU3ï¼ŒGPU0 å’Œ GPU4 ä¹‹é—´æœ‰2æ¡NVLink è¿æ¥ï¼ŒGPU0 å’Œ GPU1 ä¹‹é—´æœ‰ä¸€æ¡ NVLink è¿æ¥ï¼ŒGPU0 å’Œ6ä¹‹é—´æ²¡æœ‰ NVLink è¿æ¥ï¼Œæ•… GPU0 ä¸ GPU6 ä¹‹é—´ä»ç„¶éœ€è¦é€šè¿‡ PCIe è¿›è¡Œé€šä¿¡ã€‚NVlink è¿æ¥çš„å•å‘é€šä¿¡å¸¦å®½ä¸º 25 GB/sï¼ŒåŒå‘é€šä¿¡å¸¦å®½ä¸º 50 GB/sï¼ŒPCIe è¿æ¥çš„é€šä¿¡å¸¦å®½ä¸º16 GB/sã€‚æ‰€ä»¥åœ¨ GPU è®­ç»ƒè¿‡ç¨‹ä¸­å¦‚æœé”™è¯¯çš„åˆ†é…äº† GPUï¼Œ æ¯”å¦‚æŸè®­ç»ƒä»»åŠ¡ Pod ç”³è¯·äº†ä¸¤å¼ å¡ GPU0 ä¸ GPU6ï¼Œåœ¨è·¨ GPU é€šä¿¡å¯èƒ½å°±æˆä¸ºäº†è®­ç»ƒä»»åŠ¡çš„ç“¶é¢ˆã€‚ æ‹“æ‰‘ä¿¡æ¯å¯ä»¥åœ¨èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹ï¼š # nvidia-smi topo -m GPU0 GPU1 GPU2 GPU3 GPU4 GPU5 GPU6 GPU7 GPU0 X PIX PHB PHB SYS SYS SYS SYS GPU1 PIX X PHB PHB SYS SYS SYS SYS GPU2 PHB PHB X PIX SYS SYS SYS SYS GPU3 PHB PHB PIX X SYS SYS SYS SYS GPU4 SYS SYS SYS SYS X PIX PHB PHB GPU5 SYS SYS SYS SYS PIX X PHB PHB GPU6 SYS SYS SYS SYS PHB PHB X PIX GPU7 SYS SYS SYS SYS PHB PHB PIX X Legend: X = Self SYS = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI) NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node PHB = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU) PXB = Connection traversing multiple PCIe switches (without traversing the PCIe Host Bridge) PIX = Connection traversing a single PCIe switch NV# = Connection traversing a bonded set of # NVLinks How è¿™é‡Œå°±ä¸ä¸€ä¸€è§£æï¼Œæœ¬èº«ä¹Ÿæ²¡å®Œæ•´çš„å®ç°æ¥çœ‹ï¼Œå°±ä»¥æˆ‘è‡ªå·±çš„ç†è§£æ¥æ¢³ç†å‡ºä¸€äº›å¤§è‡´æ€è·¯ã€‚ ç¬¬ä¸€æ­¥å…¶å®æ˜¯æ„ŸçŸ¥ï¼Œå³é€šè¿‡ daemon ç»„ä»¶æ¥è¿›è¡Œ nvidia gpu ã€ç½‘ç»œæ‹“æ‰‘ã€NVLinkã€PCIe çš„ä¿¡æ¯ã€‚ç¬¬äºŒæ­¥åˆ™æ˜¯è°ƒåº¦å™¨ï¼Œå®šä¹‰ç­–ç•¥ã€‚ç­–ç•¥1ï¼šä¼˜å…ˆå°†åŒä¸€ä¸ª NUMA node ä¸‹ NVLink æ•°æœ€å¤šçš„ GPU è°ƒåº¦åˆ°ä¸€ä¸ª Pod ä¸Šï¼›ç­–ç•¥2ï¼šä¼˜å…ˆå°†å¤„äºåŒä¸€ä¸ª PCI switch çš„ GPU å’Œç½‘å¡åˆ†é…ç»™åŒä¸€ä¸ª Podã€‚å¤§è‡´æ•´ä½“æ€è·¯å¦‚ä¸‹ï¼š GPU-device-plugin æˆ–è€…å…¶ä»– daemon è¿›ç¨‹ï¼Œæ„é€ èŠ‚ç‚¹çš„ GPU æ‹“æ‰‘ä¿¡æ¯ CRDï¼› Pod å®šä¹‰ topo ç­–ç•¥ï¼Œæ¯”å¦‚ç­–ç•¥1æˆ–è€…ç­–ç•¥2ï¼› æ–°å®šä¹‰è°ƒåº¦å™¨ä¼šæ ¹æ® pod è°ƒåº¦çš„ç­–ç•¥ fliter ã€priorityé˜¶æ®µè¿‡æ»¤ä¸æ»¡è¶³ç­–ç•¥èŠ‚ç‚¹ï¼Œç»™æ»¡è¶³ç­–ç•¥èŠ‚ç‚¹æ‰“é«˜åˆ†ï¼› å…³äºèŠ‚ç‚¹ gpu device çš„å‘ç°æ›´æ–°äº¤ç»™ device-plugin å’Œ kubelet æ¥åš, å‚è§æ–‡ç« ã€‚ ç›®å‰ GPU æ‹“æ‰‘ä¿¡æ¯å¯ä»¥é€šè¿‡å®˜æ–¹çš„ nvml (NVIDIA Management Library) é€šè¿‡æ¥å£æŸ¥è¯¢ã€‚ ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:2:1","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"NUMA Topology Awareness Why è°ˆåˆ° NUMA æ‹“æ‰‘æ„ŸçŸ¥ï¼Œä¸€å®šè¦å…ˆè§£é‡Š NUMA æ˜¯å¹²å•¥å‘¢ï¼Œä¸ºå•¥è¦æ„ŸçŸ¥å®ƒå‘¢ï¼Ÿ NUMA Topo (figure 3) CPU Cache Latency (figure 4) ä¸Šé¢ä¸¤å¹…å›¾ç»™ä½ ç­”æ¡ˆï¼Œç°ä»£ CPU å¤šé‡‡ç”¨ NUMA æ¶æ„ï¼Œ NUMA å…¨ç§° â€œNon-Uniform Memory Accessâ€ å³éä¸€è‡´æ€§å†…å­˜è®¿é—®ã€‚ä¸ºå•¥æä¸ªéä¸€è‡´æ€§ï¼Œä¸€è‡´æ€§ä¸å¥½å—ï¼Ÿç­”æ¡ˆè‚¯å®šæ˜¯ä¸å¥½ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨ UMA å³ä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼Œéšç€åŒ—æ¡¥ä¸Šçš„ç‰©ç†æ ¸å¿ƒè¶Šæ¥è¶Šå¤šï¼ŒCPUçš„é¢‘ç‡ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œæ€»çº¿å¸¦å®½æ‰›ä¸ä½ï¼Œè®¿é—®åŒä¸€å—å†…å­˜çš„å†²çªé—®é¢˜ä¹Ÿä¼šè¶Šæ¥è¶Šä¸¥é‡ã€‚æˆ‘ä»¬å›åˆ° NUMAæ¶æ„ï¼Œæ¯ä¸ª NUMA node ä¸Šä¼šæœ‰è‡ªå·±çš„ç‰©ç†CPUå†…æ ¸ï¼Œä»¥åŠæ¯ä¸ª NUMA node ä¸Šæ ¸å¿ƒä¹‹é—´ä¹‹é—´ä¹Ÿå…±äº« L3 Cacheã€‚åŒæ—¶ï¼Œå†…å­˜ä¹Ÿåˆ†å¸ƒåœ¨æ¯ä¸ªNUMA nodeä¸Šçš„ã€‚æŸäº›å¼€å¯äº†è¶…çº¿ç¨‹çš„CPUï¼Œä¸€ä¸ªç‰©ç†CPUå†…æ ¸åœ¨æ“ä½œç³»ç»Ÿä¸Šä¼šå‘ˆç°ä¸¤ä¸ªé€»è¾‘çš„æ ¸ã€‚ å›åˆ°ä¸šåŠ¡ä¾§ï¼Œå¯¹äºä¸šåŠ¡ä¾§ï¼Œå¦‚æœç¨‹åºéƒ½è·‘åœ¨åŒä¸€ä¸ªNUMA nodeä¸Šï¼Œå¯ä»¥æ›´å¥½åœ°å»å…±äº«ä¸€äº›L3 Cacheï¼ŒL3 Cacheçš„è®¿é—®é€Ÿåº¦ä¼šå¾ˆå¿«ã€‚å¦‚æœL3 Cacheæ²¡æœ‰å‘½ä¸­ï¼Œå¯ä»¥åˆ°å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œè®¿å­˜é€Ÿåº¦ä¼šå¤§å¤§é™ä½ã€‚ åœ¨å®¹å™¨å¤§è¡Œå…¶é“çš„ä»Šå¤©ï¼Œç”±äº CPU é”™è¯¯åˆ†é…çš„é—®é¢˜å°¤ä¸ºä¸¥é‡ã€‚å› ä¸ºç°åœ¨èŠ‚ç‚¹å‡ºç°äº†è¶…å–ï¼ŒèŠ‚ç‚¹ä¸Šæœ‰å¤§é‡çš„å®¹å™¨åœ¨åŒæ—¶è¿è¡Œï¼Œå¦‚æœåŒä¸€ä¸ªè¿›è¡Œåˆ†é…äº†ä¸åŒçš„ NUMA ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜ï¼š CPU äº‰æŠ¢å¸¦æ¥é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´ï¼› é¢‘ç¹çš„è¿›ç¨‹åˆ‡æ¢å¯¼è‡´ CPU é«˜é€Ÿç¼“å­˜å¤±è´¥ï¼› è·¨ NUMA è®¿å­˜ä¼šå¸¦æ¥æ›´ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆã€‚ æ€»ç»“ä¸‹ï¼šåœ¨ç°ä»£ CPU æ¶æ„ä¸‹ï¼Œå¦‚æœä¸æ„ŸçŸ¥ NUMA æ‹“æ‰‘å…³ç³»ï¼Œé”™è¯¯çš„è¿›è¡Œ CPU çš„åˆ†é…ï¼Œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå½±å“ä¸šåŠ¡çš„ SLAã€‚ How ä¸Šä¸€ç« èŠ‚é˜è¿°äº†ä¸ºä»€ä¹ˆéœ€è¦ NUMA æ„ŸçŸ¥è°ƒåº¦ï¼Œé‚£ç›®å‰æ€ä¹ˆæ„ŸçŸ¥ NUMA æ‹“æ‰‘å‘¢ï¼Œæœ‰ä»€ä¹ˆç°æˆçš„æ–¹æ¡ˆå‘¢ï¼Ÿè¿™è¾¹æˆ‘ç®€å•åˆ—ä¸‹åœ¨ Kubernetes ç”Ÿæ€çš„é¡¹ç›®ï¼Œå„ä½çœ‹å®˜å¦‚æœæœ‰è¡¥å……ï¼Œå¯åœ¨è¯„è®ºåŒºè¯„è®ºï¼š Kubernetes Topology Manager Offical Crane NUMA æ‹“æ‰‘æ„ŸçŸ¥ Koordinator Fine-grained cpu orchestration Kubernetes Topology Manager æ‹“æ‰‘ç®¡ç†å™¨ï¼ˆTopology Managerï¼‰ æ˜¯ä¸€ä¸ª kubelet ç»„ä»¶ï¼Œæ—¨åœ¨åè°ƒè´Ÿè´£è¿™äº›ä¼˜åŒ–çš„ä¸€ç»„ç»„ä»¶ã€‚Topology Manager å…¶å®æ˜¯è§£å†³ä¸€ä¸ªå†å²é—®é¢˜ï¼ŒCPU Manager å’Œ Device Manager æ˜¯ç‹¬ç«‹å·¥ä½œçš„ï¼Œäº’ç›¸ä¸æ„ŸçŸ¥ã€‚ é¦–å…ˆæ¥çœ‹ä¸‹ Kubernetes Topology Manager çš„å®ç°ï¼Œè¿™é‡Œæˆ‘ä¹Ÿä¸æƒ³é€ è½®å­äº†ï¼Œå¯ä»¥å‚çœ‹é˜¿é‡Œçš„åŒå­¦æ€»ç»“çš„ä¸€ç¯‡å¥½æ–‡ã€‚è¿™é‡Œåšä¸€ä¸ªæ€»ç»“ï¼š æ‰¾åˆ°ä¸åŒèµ„æºçš„ topology hints å³æ‹“æ‰‘ä¿¡æ¯ï¼Œ cpu çš„é€‰æ‹©æ ‡å‡†æ˜¯åœ¨æ»¡è¶³èµ„æºç”³è¯·çš„æƒ…å†µä¸‹ï¼Œæ¶‰åŠçš„ NUMA èŠ‚ç‚¹ä¸ªæ•°æœ€å°‘å‰æä¸‹æ¶‰åŠåˆ° socket ä¸ªæ•°æœ€å°çš„ä¼˜å…ˆé€‰æ‹©ã€‚ device manager åˆ™åœ¨æ»¡è¶³èµ„æºç”³è¯·æƒ…å†µä¸‹ï¼Œæ¶‰åŠ NUMA èŠ‚ç‚¹æœ€å°ä¼˜å…ˆé€‰æ‹©ã€‚ ä¸åŒ topology ç±»å‹çš„ hints åš merge æ“ä½œï¼Œä¹Ÿå°±æ˜¯ unionï¼Œé€‰å‡ºæœ€ä¼˜ç­–ç•¥ å¦‚æœé€‰åˆ°è¿˜å¥½ï¼Œå¦‚æœæ²¡é€‰å‡ºæ¥æ€ä¹ˆåŠï¼Ÿkubernetes æä¾›äº† kubelet é…ç½®ç­–ç•¥: best-effort: kubernetes èŠ‚ç‚¹ä¹Ÿä¼šæ¥çº³è¿™ä¸ª Podï¼Œå°±æ˜¯æ•ˆæœä¸è¾¾é¢„æœŸã€‚ restrictedï¼šèŠ‚ç‚¹ä¼šæ‹’ç»æ¥çº³è¿™ä¸ª Podï¼Œå¦‚æœ Pod é­åˆ°èŠ‚ç‚¹æ‹’ç»ï¼Œå…¶çŠ¶æ€å°†å˜ä¸º Terminatedã€‚ single-NUMA-nodeï¼šèŠ‚ç‚¹ä¼šæ‹’ç»æ¥çº³è¿™ä¸ªPodï¼Œå¦‚æœ Pod é­åˆ°èŠ‚ç‚¹æ‹’ç»ï¼Œå…¶çŠ¶æ€å°†å˜ä¸ºTerminatedã€‚è¿™é‡Œæ¯” restricted è¿˜å¤šä¸€ä¸ªæ¡ä»¶æ˜¯é€‰å‡ºæ¥çš„ NUMA èŠ‚ç‚¹ä¸ªæ•°éœ€è¦æ˜¯1ä¸ªã€‚ æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ° Kubernetes Topology Manager è¿˜æ˜¯åœ¨ä»¥ NUMA ä¸ºä¸­å¿ƒæ¥è¿›è¡Œä¸åŒèµ„æºï¼ˆNIC, GPU, CPUï¼‰æ¥è¿›è¡Œ complete fair æœ€çŸ­è·¯å¾„çš„é€‰æ‹©ã€‚è€Œä¸”æ˜¯åœ¨ pod è¢«è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šå kubelet æ‰§è¡Œä¸Šè¿°çš„è¿‡ç¨‹ï¼Œè¿™æ ·ä¼šå¸¦æ¥å‡ ä¸ªé—®é¢˜ï¼š pod æœ‰å¾ˆå¤§æ¦‚ç‡ä¼š Terminated, ç”Ÿäº§ä¸Šä¸å¯ç”¨ã€‚ èŠ‚ç‚¹çš„ topology-manager-policy é…ç½®ä¸æ–¹ä¾¿ï¼Œ kubelet æ¯æ¬¡é…ç½®å‚æ•°éƒ½éœ€è¦é‡å¯ï¼Œå¦‚æœé‡åˆ°ç‰¹æ®Šçš„ç‰ˆæœ¬å¯èƒ½ä¼šé‡å¯æ‰€æœ‰èŠ‚ç‚¹ podï¼Œè¯¦è§æ–‡ç«  æ‰€ä»¥æˆ‘ä»¬ä¼šæƒ³åˆ°å‡ ä¸ªä¼˜åŒ–çš„æ–¹æ¡ˆï¼š è®©ä¸€ä¸ªç±»ä¼¼ kubelet çš„ daemon è¿›ç¨‹ï¼Œå¯ä»¥å‘ç° topo å…³ç³»ï¼Œå¹¶å‘å¤–æš´éœ²ï¼› å¯ä»¥è®©æ‹“æ‰‘æ„ŸçŸ¥æ”¾åœ¨ kube-scheduler ç»™ pod åˆ†é… node çš„æ—¶å€™å°±æ„ŸçŸ¥ï¼Œè€Œä¸”å¯ä»¥æŒ‡å¯¼è°ƒåº¦ï¼› æä¾›å£°æ˜å¼çš„çµæ´»çš„ topology manager policyã€‚ ä¸‹é¢ä»‹ç»çš„å‡ ä¸ªæ‹“æ‰‘æ„ŸçŸ¥æ–¹æ¡ˆå…¶å®å°±æ˜¯åŸºäºä¸Šé¢çš„ idea åº”è¿è€Œç”Ÿçš„ã€‚ Crane NUMA æ‹“æ‰‘æ„ŸçŸ¥ é¦–å…ˆçœ‹ä¸‹ Crane NUMA æ„ŸçŸ¥è°ƒåº¦çš„æ¶æ„å›¾ã€‚ Crane NUMA Topology Aware (figure 5) å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š Crane-Agent ä»èŠ‚ç‚¹é‡‡é›†èµ„æºæ‹“æ‰‘ï¼ŒåŒ…æ‹¬NUMAã€Socketã€è®¾å¤‡ç­‰ä¿¡æ¯ï¼Œæ±‡æ€»åˆ°NodeResourceTopologyè¿™ä¸ªè‡ªå®šä¹‰èµ„æºå¯¹è±¡ä¸­ã€‚ Crane-Scheduleråœ¨è°ƒåº¦æ—¶ä¼šå‚è€ƒèŠ‚ç‚¹çš„NodeResourceTopologyå¯¹è±¡è·å–åˆ°èŠ‚ç‚¹è¯¦ç»†çš„èµ„æºæ‹“æ‰‘ç»“æ„ï¼Œåœ¨è°ƒåº¦åˆ°èŠ‚ç‚¹çš„åŒæ—¶è¿˜ä¼šä¸ºPodåˆ†é…æ‹“æ‰‘èµ„æºï¼Œå¹¶å°†ç»“æœå†™åˆ°Podçš„annotationsä¸­ã€‚ Crane-Agentåœ¨èŠ‚ç‚¹ä¸ŠWatchåˆ°Podè¢«è°ƒåº¦åï¼Œä»Podçš„annotationsä¸­è·å–åˆ°æ‹“æ‰‘åˆ†é…ç»“æœï¼Œå¹¶æŒ‰ç…§ç”¨æˆ·ç»™å®šçš„CPUç»‘å®šç­–ç•¥è¿›è¡ŒCPUSetçš„ç»†ç²’åº¦åˆ†é…ã€‚ è¿™é‡Œå…¶å®å°±å·²ç»è§£å†³ä¸Šè¿° Kubernetes Topology Manager çš„ç¼ºé™·ã€‚ä¸è¿‡æˆ‘ä»¬å‘ç°ç­–ç•¥æ€ä¹ˆé…ç½®å‘¢ï¼Œè¿™é‡Œæä¾›ä¸¤ç§ç­–ç•¥é…ç½®æ–¹æ¡ˆ ä¸šåŠ¡ä¾§ï¼Œåœ¨ pod ä¸Šæ‰“ä¸åŒçš„æ ‡ç­¾æ¥æŒ‡å®šç­–ç•¥ï¼š noneï¼šè¯¥ç­–ç•¥ä¸è¿›è¡Œç‰¹åˆ«çš„CPUSetåˆ†é…ï¼ŒPodä¼šä½¿ç”¨èŠ‚ç‚¹CPUå…±äº«æ± ã€‚ exclusiveï¼šè¯¥ç­–ç•¥å¯¹åº”kubeletçš„staticç­–ç•¥ï¼ŒPodä¼šç‹¬å CPUæ ¸å¿ƒï¼Œå…¶ä»–ä»»ä½•Podéƒ½æ— æ³•ä½¿ç”¨ã€‚ NUMAï¼šè¯¥ç­–ç•¥ä¼šæŒ‡å®šNUMA Nodeï¼ŒPodä¼šä½¿ç”¨è¯¥NUMA Nodeä¸Šçš„CPUå…±äº«æ± ã€‚ immovableï¼šè¯¥ç­–ç•¥ä¼šå°†Podå›ºå®šåœ¨æŸäº›CPUæ ¸å¿ƒä¸Šï¼Œä½†è¿™äº›æ ¸å¿ƒå±äºå…±äº«æ± ï¼Œå…¶ä»–Podä»å¯ä½¿ç”¨ã€‚ èŠ‚ç‚¹ä¾§ ç›®å‰é»˜è®¤æ˜¯ cpu manager policy æ˜¯ static å³å…è®¸ä¸ºèŠ‚ç‚¹ä¸Šå…·æœ‰æŸäº›èµ„æºç‰¹å¾çš„ Pod èµ‹äºˆå¢å¼ºçš„ CPU äº²å’Œæ€§å’Œç‹¬å æ€§ï¼› topology manager policy æ˜¯ SingleNUMANodePodLevelã€‚ å¦‚æœèŠ‚ç‚¹æ—  topology.crane.io/topology-awareness æ ‡ç­¾ï¼Œåˆ™ topology manager policy ä¸º none è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒç‰¹åˆ«çš„åŠŸèƒ½ï¼Œé»˜è®¤ kubelet çš„ static çš„ cpu manager ç­–ç•¥ï¼Œåªå¯¹ pod qos ä¸º guranteed ä¸”èµ„æºç”³è¯·ä¸ºæ•´æ•°çš„ pod ç”Ÿæ•ˆï¼Œä¸”åˆ†é…æŒ‡å®šçš„ cpu å…¶ä»–è¿›ç¨‹æ— æ³•å ç”¨ã€‚ä½†æ˜¯é…åˆ crane-agent å’Œ Crane NUMA æ„ŸçŸ¥è°ƒåº¦å, å¯ä»¥å®ç° pod å’Œ ç»‘å®šæ ¸å¿ƒçš„ pod å…±äº«èµ„æºï¼Œå¯ä»¥åœ¨åˆ©ç”¨ç»‘æ ¸æ›´å°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ›´é«˜çš„ç¼“å­˜äº²å’Œæ€§çš„ä¼˜ç‚¹çš„å‰æä¸‹ï¼Œè¿˜èƒ½è®©å…¶ä»– workload éƒ¨ç½²å…±ç”¨ï¼Œæå‡èµ„æºåˆ©ç”¨ç‡ã€‚è€Œä¸”æ”¾æ¾äº† pod çš„è¦æ±‚ï¼Œåªéœ€è¦ä»»æ„containerçš„CPU limitå¤§äºæˆ–ç­‰äº1ä¸”ç­‰äºCPU requestå³å¯ä¸ºè¯¥containerè®¾ç½®ç»‘æ ¸ã€‚å®éªŒä¸‹ï¼š $ cat nginx apiVersion: v1 kind: Pod metadata: name: nginx annotations: topology.crane.io/topology-awareness: 'true' topology.crane.io/cpu-policy: 'immovable' spec: containers: - image: nginx imagePullPolicy: Always name: nginx resources: requests: cpu: 2 memory: 1Gi limits: cpu: 2 memory: 1Gi $ k exec -it nginx /bin/bash $ taskset -cp 1 # æŸ¥çœ‹ç»‘æ ¸ pid 1's current affinity list: 0,1 # æŸ¥çœ‹ burstable pod çš„ cpuset ä¿¡æ¯ $ cat /sys/fs/cgroup/cpuset/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod2260198d_db73_41f0_8ae3_387e09d3b9ec.slice/cri-containerd-6a5dfa37f9ce9102e1f781160d1fecb11b17dc835e5d72b9d7f573b515af86b3.scope/cpuset.cpus 0-9 # change to exclusive annotations: topology.crane.io/topology-awareness: 'true' topology.crane.io/cpu-policy: 'exclusive' $","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:2:2","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"å¼•ç”¨ è¿™é‡Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œå†æ¬¡æ„Ÿè°¢ã€‚ https://kubernetes.io/zh-cn/ https://github.com/volcano-sh/volcano/ https://mp.weixin.qq.com/s/uje27_MHBh8fMzWATusVwQ https://www.infoq.cn/article/tdfgiikxh9bcgknywl6s https://github.com/NVIDIA/go-nvml https://gocrane.io/zh-cn/docs/ https://koordinator.sh/docs/user-manuals https://www.likakuli.com/posts/kubernetes-kubelet-restart/ https://zhuanlan.zhihu.com/p/121588317 ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:3:0","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":null,"content":"å…³äºè¿œä¸œ","date":"2022-12-29","objectID":"/about/","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"},{"categories":null,"content":"æˆªæ­¢åˆ° 2024 å¹´ï¼Œæœ‰ç€è¶…è¿‡ 6 å¹´çš„ AI Infrastructure çš„ç»éªŒï¼Œå…·ä½“å¦‚ä¸‹ï¼š 2018-2021.2ï¼ˆå«å®ä¹ ï¼‰åœ¨ AI ç®—æ³•å…¬å¸ Unisound è´Ÿè´£å¤§è§„æ¨¡æ™ºèƒ½è°ƒåº¦ç³»ç»Ÿä»¥åŠé«˜æ€§èƒ½åˆ†å¸ƒå¼å­˜å‚¨ä»¥åŠå¤šçº§ç¼“å­˜ç³»ç»Ÿï¼Œæ”¯æŒ NLP ä»¥åŠ CV æ¨¡å‹è®­ç»ƒã€‚ ä»äº‹ 8 Bit è®­ç»ƒåŠæ¨ç†ä¼˜åŒ–å·¥ä½œï¼Œè½åœ°æ¨¡å‹åœ¨ NPU ä»¥åŠ NVIDIA Edge Device çš„ä¼˜åŒ–å·¥ä½œã€‚ 2021.2-2023.5 åœ¨ Tencent Cloud æ„å»ºå…¬æœ‰äº‘å¤§è§„æ¨¡ AI å¹³å°ï¼Œ ç»“åˆå…¬æœ‰äº‘å¯¹è±¡å­˜å‚¨ä»¥åŠ EKS ï¼ˆElastic Kubernetes Serviceï¼‰ æ„å»ºé«˜æ€§èƒ½ã€å¯ä¼¸ç¼©çš„å¼¹æ€§ç¦»çº¿è®­ç»ƒå¹³å°ã€‚ æ„å»º FinOps åŸºç¡€è®¾æ–½å¸®åŠ©å…¬å…±äº‘ä¸­çš„å®¢æˆ·æ›´è½»æ¾åœ°ç®¡ç†ä¼˜åŒ–äº‘æˆæœ¬ï¼Œä½†ä¹Ÿç¡®ä¿äº†åº”ç”¨ç¨‹åºçš„è´¨é‡ï¼›åŒæ—¶åœ¨å†…éƒ¨äº‘ä¸­å¤§è§„æ¨¡æ¨å‡ºé™ä½æˆæœ¬è®¡åˆ’ã€‚ 2023.5-è‡³ä»Šåœ¨åˆåˆ›å…¬å¸ Tensorchord è´Ÿè´£åœ¨ GCP ä¸Šæ„å»º Serverless Inference å¹³å° ModelZï¼Œ æä¾›æè‡´çš„å†·å¯åŠ¨ä¼˜åŒ–æ¨¡å‹æœåŠ¡æ¨ç†æœåŠ¡ã€‚ åœ¨ AWS ä¸Šæ„å»ºåŸºäº Postgres çš„å‘é‡æ•°æ®åº“çš„äº‘æœåŠ¡ PGVecto.rs Cloudã€‚ æŠ€èƒ½æ ˆï¼šKubernetes, GCP, AWS, Kubeflow, FinOps, RAG, Vector Database, Storage Accelerate, Tensorflow , Pytorch ğŸŒ± ç›®å‰ä¸“æ³¨åœ¨ MLOps ä»¥åŠ FinOps é¢†åŸŸ,è´¡çŒ®äº†ä¸€äº›å¼€æºé¡¹ç›®ï¼š fluid Fluid, elastic data abstraction and acceleration for BigData/AI applications in cloud. (Project under CNCF) crane Crane is a FinOps Platform for Cloud Resource Analytics and Economics in Kubernetes clusters. The goal is not only to help users to manage cloud cost easier but also ensure the quality of applications. crane-scheduler Crane scheduler is a Kubernetes scheduler which can schedule pod based on actual node load. creator Creator is the brain of crane project, contains crane core algorithm module and evaluation module. openmodelz One-click machine learning deployment (LLM, text-to-image and so on) at scale on any cluster (GCP, AWS, Lambda labs, your home lab, or even a single machine). clusternet [CNCF Sandbox Project] Managing your Kubernetes clusters (including public, private, edge, etc.) as easily as visiting the Internet ğŸ“« æ‚¨å¦‚æœæƒ³è”ç³»æˆ‘ï¼Œå¯ä»¥ç›´æ¥å‘é€é‚®ä»¶ï¼Œé‚®ç®±åœ°å€ xieydd@gmail.com,æˆ–è€…æ‚¨å¯ä»¥åŠ æˆ‘çš„å¾®ä¿¡ echo -n 'eGlleWRkX2hhaGEK' | base64 -d. ","date":"2022-12-29","objectID":"/about/:0:0","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"}]