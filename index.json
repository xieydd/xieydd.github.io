[{"categories":["2025","serverless","serving"],"content":"ä¹‹å‰åœ¨åš Serverless æ¨¡å‹æ¨ç† Modelzï¼Œè™½ç„¶ç°åœ¨å·²ç» pivot äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æƒ³åˆ†äº«ä¸€ä¸‹å¦‚ä½•ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨é—®é¢˜ã€‚ç”±äºæˆ‘ä»¬çš„æœåŠ¡æ˜¯åŸºäºå®¹å™¨è°ƒåº¦ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ¶‰åŠåˆ°äº†å®¹å™¨çš„å†·å¯åŠ¨é—®é¢˜ã€‚ ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:0:0","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"é—®é¢˜ é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹ Serverless æ¨¡å‹æ¨ç†ï¼Œä»ç”¨æˆ·è¯·æ±‚åˆ°æ¨¡å‹æ¨ç†çš„è¿‡ç¨‹ï¼š Click me sequenceDiagram participant User participant Cloudflare participant Ingress participant AutoScaler participant Node participant containerd User-\u003e\u003eCloudflare: Model Call Cloudflare-\u003e\u003eIngress: Request Ingress-\u003e\u003eAutoScaler: Request AutoScaler-\u003e\u003eNode: Scale Up Node-\u003e\u003econtainerd: Container Note right of containerd: 1. Pull Image \u003cbr\u003e2. Start Container\u003cbr\u003e3. Download model æ•´ä¸ªæµç¨‹çš„é“¾è·¯å¾ˆé•¿ï¼Œä½†æ˜¯çœŸæ­£è€—æ—¶çš„åœ°æ–¹åœ¨æœ€å Containerd æ‹‰å–é•œåƒå’Œå¯åŠ¨å®¹å™¨çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬å°†è¿™ä¸ªéƒ¨åˆ†è¿›ä¸€æ­¥ç»†åŒ–,è¿™é‡Œçš„æ¯ä¸ªé˜¶æ®µçš„æ—¶é—´å¤§è‡´æ¥è‡ªäºå¼•ç”¨1ï¼š Click me flowchart TD subgraph Pod Create 3A[Pull Image 3.5GB 140s] --\u003e 3B[Download Model] end subgraph GPU Node Provision 2A[VM Create 40s] --\u003e 2B[Node Initialize 45s] 2B --\u003e 2C[GPU Driver Install 25s] end subgraph AutoScaler 1A[HPA reaction 10s] --\u003e 1B[Auto Provisioning reaction 30s] --\u003e 1C[Node auto-scaling 35s] end å¦‚æœæ˜¯ 30Gï¼ˆåœ¨ AI æ¨ç†åœºæ™¯å¹¶ä¸ç¨€æœ‰ï¼‰ çš„é•œåƒï¼Œé‚£ä¹ˆæ‹‰å–æ—¶é—´å°†è¶…è¿‡ 15min, è¿™ä¸ªæ—¶é—´å¯¹äºç”¨æˆ·æ¥è¯´æ˜¯ä¸å¯æ¥å—çš„ã€‚ è€Œæ¨¡å‹ä¸‹è½½å–å†³äºæ¨¡å‹çš„å¤§å°ä»¥åŠæ¨¡å‹æ˜¯å¦å·²ç»å­˜åœ¨äº Pod ä¸­ï¼Œè¿™ä¸ªæ—¶é—´ä¹Ÿæ˜¯ä¸å¯æ§çš„ï¼Œä½†æ˜¯åæ–‡æˆ‘ä»¬ä¹Ÿä¼šé’ˆå¯¹æ€§çš„æå‡ºä¼˜åŒ–æ–¹æ¡ˆã€‚ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:1:0","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"Deep Dive ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:2:0","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"Why image is so large? ç”±ä¸Šé¢ä¸¤å¼ å›¾å¯ä»¥çœ‹åˆ° é™¤äº† NVIDIA Kernel Driver ä»¥åŠ CUDA Lib æ”¾åœ¨ Host ä¸Šï¼ŒAI åº”ç”¨ç¨‹åºä»¥åŠæ¡†æ¶æ‰€ä¾èµ–çš„åº“éƒ½æ”¾åœ¨é•œåƒä¸­ã€‚ NVIDIA çš„ç­–ç•¥å¯¼è‡´ä½ æ— æ³•å¤§å¹…ç¼©å‡ä½ çš„é•œåƒï¼Œä½ ä¸çŸ¥é“å“ªäº›åº“ä¼šè¢«ä½¿ç”¨ï¼Œæ‰€ä»¥ä½ åªèƒ½æŠŠæ‰€æœ‰çš„åº“éƒ½æ”¾åœ¨é•œåƒä¸­ã€‚ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:2:1","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"æˆ‘ä»¬å°è¯•è¿‡çš„è§£å†³æ–¹æ¡ˆ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:3:0","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"1. é¢„çƒ­ é¦–å…ˆæˆ‘ä»¬ä¼šä½¿ç”¨ cluster-proportional-autoscaler æ ¹æ®æ—¢å®šè§„åˆ™ï¼Œæ¯”å¦‚æ€»èŠ‚ç‚¹ä¸º 8 çš„æ—¶å€™è¯¥ç±»å‹ GPU èµ„æºæ‰©å®¹åˆ° 2 ä¸ªèŠ‚ç‚¹å³ä½¿æ²¡æœ‰è¯·æ±‚ï¼Œä¹Ÿæœ‰é¢„ç•™ bubble. ç„¶åæ ¹æ® image ä½¿ç”¨é¢‘ç‡ï¼Œä½¿ç”¨ kube-fledged åœ¨è¿™äº›èŠ‚ç‚¹ä¸Šåˆ›å»º ImageCacheï¼Œè¿™æ ·åœ¨çœŸæ­£è¯·æ±‚çš„æ—¶å€™ï¼Œé•œåƒå·²ç»åœ¨èŠ‚ç‚¹ä¸Šäº†ã€‚ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:3:1","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"2. Cache æ¨¡å‹ æˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ª HuggingFace çš„æ¨¡å‹ç¼“å­˜æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡ä¼šåœ¨æ¨¡å‹è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œé€šè¿‡æ¯”å¯¹æ¨¡å‹çš„ hash å€¼ï¼Œå¦‚æœæ¨¡å‹å·²ç»å­˜åœ¨ç¼“å­˜æœåŠ¡ä¸­ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ç¼“å­˜çš„æ¨¡å‹ï¼Œå¦åˆ™ä¸‹è½½æ¨¡å‹åˆ°ç¼“å­˜æœåŠ¡ä¸­ã€‚ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:3:2","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"3. GCP Image Streaming åˆ©ç”¨ GCP Image Streaming å°†è‡ªå·±ç®¡ç†çš„é•œåƒæˆ–è€…ç”¨æˆ·è‡ªå®šä¹‰çš„é•œåƒè½¬æ¢åˆ° GCP çš„ Artifact Registry ä¸­ï¼Œåœ¨èŠ‚ç‚¹æ‹‰å–é•œåƒæ—¶ï¼Œé€šè¿‡ç½‘ç»œ mount container layers åˆ°èŠ‚ç‚¹ä¸Šï¼Œè®© containerd è¯¯ä»¥ä¸ºé•œåƒå·²ç»åœ¨èŠ‚ç‚¹ä¸Šã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆæœ‰å‡ ä¸ªç¼ºç‚¹ï¼š éœ€è¦ GCP çš„æ”¯æŒ, vendor lock-in ç”¨æˆ·é•œåƒéœ€è¦ proxy è½¬æ¢åˆ° GCPï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæœ‰ä¸€å®šçš„å»¶è¿Ÿ è™½ç„¶ pod running ä½†æ˜¯ä¸æ˜¯çœŸæ­£çš„å®Œå…¨å¯è¿è¡Œï¼Œå¯èƒ½ä¼šå¯¼è‡´è¿è¡Œæ—¶ç¼“æ…¢ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:3:3","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"4. æ›´æ¢é•œåƒæ ¼å¼ å°† OCI é•œåƒæ ¼å¼è½¬æ¢æˆ nydus æ ¼å¼ï¼Œå¹¶ç»“åˆ lazy pulling æŠ€æœ¯ zran, æµ‹è¯•ä¸‹æ¥æœ‰ç€æ•°å€çš„æå‡ã€‚å°±æ˜¯éœ€è¦ä¿®æ”¹ containerd é…ç½®ï¼Œæ”¯æŒ nydusã€‚ é…åˆ Dragonfly çš„ P2P æŠ€æœ¯ï¼Œå¯ä»¥è¿›ä¸€æ­¥æå‡é•œåƒæ‹‰å–é€Ÿåº¦ã€‚ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:3:4","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"5. ä½¿ç”¨ JuiceFS æ„å»ºæ¨¡å‹ç¼“å­˜é›†ç¾¤ é€šè¿‡æ„å»ºç‹¬ç«‹ç¼“å­˜æ± ï¼Œå°†æ¨¡å‹ç¼“å­˜åˆ° JuiceFS ä¸­ã€‚é€šè¿‡ JuiceFS CSI å°†ç¼“å­˜ç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œå¦‚æœæ¨¡å‹å·²ç»å­˜åœ¨ JuiceFS ä¸­ï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨ï¼Œä¸å­˜åœ¨åˆ™ä¸‹è½½å¹¶ç›´æ¥ç¼“å­˜åˆ° JuiceFS ä¸­ã€‚è¿™å¥—æ¶æ„ä¸»è¦æ˜¯åˆ©ç”¨ JuiceFS Posix ä»¥åŠä½¿ç”¨å¯¹è±¡å­˜å‚¨çš„ä¼˜åŠ¿ï¼Œæ— éœ€å…³æ³¨ç¼“å­˜å¤§å°ã€‚è¿™é‡Œéœ€è¦å¯¹ JuiceFS çš„å‚æ•°è¿›è¡Œè°ƒä¼˜ï¼Œæ¯”å¦‚ prefetch block, buffer size ç­‰ã€‚ ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:3:5","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"åç»­å¯èƒ½çš„ä¼˜åŒ– ä½¿ç”¨ GCP çš„ image preloading åŠŸèƒ½ï¼Œé€šè¿‡secondary boot disks preload é•œåƒåˆ° node ä¸Šã€‚ In-class registry cache spegelã€‚ Parallel Downloading in Kubelet KEP 3673ã€‚ Parallel Container Layer Unpacking, è¿™é‡Œåœ¨å¼•ç”¨1ä¸­æåˆ° containerd éœ€è¦å®ç° high IO queue depth æ‰èƒ½å……åˆ†åˆ©ç”¨ EBS çš„ throughputã€‚ yetone çš„æ–¹æ¡ˆ: parse äº† Dockerfileï¼Œç„¶åè·å¾—äº† base image å’Œä¸€ç³»åˆ— argsã€env å’Œ commandsï¼Œå¹¶å°†å…¶é¡ºåºåˆå¹¶èµ·æ¥ hash äº†ä¸€ä¸‹ä½œä¸º s3 object keyï¼Œç„¶ååœ¨æˆ‘ä»¬çš„ image builder job çš„ pod çš„ container é‡Œèµ·äº† dindï¼Œç„¶ååœ¨é‡Œé¢ç”¨ base image èµ·äº†æ–°çš„ container ç„¶ååœ¨é‡Œé¢æ‰§è¡Œä¸Šä¸€æ­¥ parse å‡ºæ¥çš„ commandsï¼Œæ‰§è¡Œå®Œæ¯•åæŠŠè¿™ä¸ª container çš„ rootfs æ‰“æˆ tar åŒ…å¹¶ç”¨ zstd å‹ç¼©ç„¶åä¸Šä¼ åˆ° s3 OCI image builder å’Œ containerd remote snapshotterï¼Œåœ¨ builder ä¾§è‡ªå·±æ„å»ºé•œåƒæŠŠæ‰€æœ‰ layer åªåˆ†æˆä¸¤ä¸ª layer ï¼šç¯å¢ƒï¼ˆæå¤§ï¼‰å’Œä»£ç ï¼ˆæå°ï¼‰ï¼Œç„¶åç”¨ pzstd å’Œ s5cmd æµå¼å‹ç¼©å’Œæµå¼ä¸Šä¼ åˆ° s3ï¼Œç„¶ååœ¨ snapshotter ä¾§ç”¨ s5cmd å’Œ pzstd æµå¼ä¸‹è½½å’Œæµå¼è§£å‹ï¼Œç›´æ¥æ‰“æ»¡äº† GKE çš„ disk IOï¼ŒæŠŠ image çš„æ‹‰å–é€Ÿåº¦æå‡åˆ°äº†ä»¥å‰çš„ 4 å€å·¦å³ Modal lazying container loading Do some research on ServerlessLLM OSDI24 ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:4:0","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2025","serverless","serving"],"content":"å¼•ç”¨ https://www.youtube.com/watch?v=e6Oo2aoZPnA https://www.youtube.com/watch?v=SlkEW4C2kd4 ","date":"2025-01-08","objectID":"/improve-model-serving-cold-start/:5:0","tags":["serving","cold start","inference"],"title":"ä¼˜åŒ–æ¨¡å‹æ¨ç†çš„å†·å¯åŠ¨","uri":"/improve-model-serving-cold-start/"},{"categories":["2024","Postgres"],"content":"æœ€è¿‘åœ¨ç ”ç©¶ Postgres é«˜å¯ç”¨çš„æ–¹æ¡ˆï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚ Postgres é«˜å¯ç”¨ ","date":"2024-07-26","objectID":"/postgres-ha/:0:0","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"é«˜å¯ç”¨ç›®æ ‡ Postgres é«˜å¯ç”¨ä¸€èˆ¬æœ‰ä¸¤ä¸ªç›®æ ‡ï¼š RPOï¼ˆRecovery Point Objectiveï¼‰å³æ•°æ®æ¢å¤ç‚¹ç›®æ ‡ï¼Œä¸»è¦æŒ‡çš„æ˜¯ä¸šåŠ¡ç³»ç»Ÿæ‰€èƒ½å®¹å¿çš„æ•°æ®ä¸¢å¤±é‡ã€‚ RTOï¼ˆRecovery Time Objectiveï¼‰å³æ¢å¤æ—¶é—´ç›®æ ‡ï¼Œä¸»è¦æŒ‡çš„æ˜¯æ‰€èƒ½å®¹å¿çš„ä¸šåŠ¡åœæ­¢æœåŠ¡çš„æœ€é•¿æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ä»ç¾éš¾å‘ç”Ÿåˆ°ä¸šåŠ¡ç³»ç»Ÿæ¢å¤æœåŠ¡åŠŸèƒ½æ‰€éœ€è¦çš„æœ€çŸ­æ—¶é—´å‘¨æœŸã€‚ ç®€å•æ¥è¯´å°±æ˜¯ï¼Œåœ¨å¤šé•¿æ—¶é—´å†…æ¢å¤æ•°æ®åº“æ¢å¤åˆ°ä»€ä¹ˆçŠ¶æ€ï¼Œæ¯”å¦‚åœ¨ 5min å†…æ¢å¤åˆ°ä¸¢å¤±æ•°æ®ä¸è¶…è¿‡ 30min çš„çŠ¶æ€ã€‚å½“ç„¶æœ€å¥½çš„æƒ…å†µå°±æ˜¯ RTO \u003c 30s, RPO~=0ã€‚ ","date":"2024-07-26","objectID":"/postgres-ha/:1:0","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"åœºæ™¯ ä¸ºäº†è¾¾åˆ°ä¸Šé¢çš„è¿™ä¸ªæœ€å¥½çš„æƒ…å†µï¼Œéœ€è¦è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š å½“ Primary èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ° Standby å¹¶åœ¨ RTO çš„è¦æ±‚ä¸‹æ¢å¤åˆ° RPO ç›®æ ‡ã€‚ å½“æ•°æ®åº“å‘ç”Ÿæ•°æ®çš„æ„å¤–åˆ é™¤ã€å‡çº§å˜æ›´é”™è¯¯ã€æˆ–è€…é‡åˆ°ç¡¬ä»¶æ•…éšœç­‰ï¼Œå¯ä»¥æ¢å¤åˆ°æŒ‡å®šæ—¶é—´ç‚¹ã€‚ ","date":"2024-07-26","objectID":"/postgres-ha/:2:0","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"æ¦‚å¿µ ä¸ºäº†æ»¡è¶³ä»¥ä¸Šåœºæ™¯éœ€è¦æœ‰ä»¥ä¸‹æŠ€æœ¯æˆ–è€…æ¦‚å¿µçš„æ”¯æŒï¼š Continuous Archivingï¼šContinuous Archiving ä¸€èˆ¬æ˜¯æ˜¯å¯¹ WAL(writer ahead log) è¿›è¡Œå½’æ¡£ï¼›å¦‚æœé‡åˆ° db system crash å¯ä»¥é€šè¿‡ replay WAL æ¥è¿›è¡Œæ¢å¤ã€‚ Point-in-Time Recovery (PITR) ï¼šå¯¹äºç¡¬ä»¶æ•…éšœæ¥è¯´ï¼ŒåŸºäºç‰©ç†å¤åˆ¶çš„é«˜å¯ç”¨æ•…éšœåˆ‡æ¢å¯èƒ½ä¼šæ˜¯æœ€ä½³é€‰æ‹©ã€‚è€Œå¯¹äºæ•°æ®æŸåï¼ˆæ— è®ºæ˜¯æœºå™¨è¿˜æ˜¯äººä¸ºé”™è¯¯ï¼‰ï¼Œæ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰åˆ™æ›´ä¸ºåˆé€‚ï¼šå®ƒæä¾›äº†å¯¹æœ€åæƒ…å†µçš„å…œåº•ã€‚ Physical Replicationï¼šæ•°æ®æ–‡ä»¶å’Œäº‹åŠ¡æ—¥å¿—æ–‡ä»¶å…¨éƒ¨å¤åˆ¶ ï¼ˆPGData, pg_walsï¼‰ Logical Replicationï¼šæ ¹æ®å¤åˆ¶çš„æ ‡è®°ï¼ˆä¾‹å¦‚ä¸»é”®ï¼‰åœ¨å‘å¸ƒå’Œè®¢é˜…ä¹‹é—´è¿›è¡Œå¤åˆ¶ï¼Œä¸€èˆ¬ä¸ç”¨äºå®¹ç¾ï¼ŒFDW åœºæ™¯å±…å¤šã€‚ Streaming Replication ï¼šåŸºäº WAL æ—¥å¿—çš„æµå¤åˆ¶ï¼Œä¸»è¦ç”¨äºå®¹ç¾åœºæ™¯ã€‚å°† WAL XLOG è®°å½•è¿ç»­ä» primary ä¼ é€åˆ° standbyï¼Œ æœ‰åŒæ­¥ä»¥åŠå¼‚æ­¥ä¸¤ç§æ–¹å¼ã€‚ ","date":"2024-07-26","objectID":"/postgres-ha/:3:0","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"å·¥å…· ","date":"2024-07-26","objectID":"/postgres-ha/:4:0","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"Backup and Restore è¿™é‡Œé¦–å…ˆåˆ—ä¸¾ä¸‹å¸¸ç”¨çš„å¤‡ä»½å’Œæ¢å¤æ–¹å¼ä»¥åŠä¼˜åŠ£ï¼š 1. Pg_dump (Logical Backup) é€»è¾‘å¤‡ä»½æ˜¯é€šè¿‡ SQL å‘½ä»¤ pg_dump å°†æ•°æ®åº“ä¸­çš„æ•°æ®å¯¼å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åé€šè¿‡ SQL å‘½ä»¤å°†æ•°æ®å¯¼å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ ä¼˜åŠ¿ï¼š æ ¹æ®éœ€è¦ï¼Œé€»è¾‘å¤‡ä»½å¯ä»¥æ˜¯è¡¨çº§åˆ°æ•°æ®åº“çº§ å¤‡ä»½ä¸ä¼šé˜»æ­¢æ•°æ®åº“ä¸Šçš„è¯»/å†™æ´»åŠ¨ å¯ä»¥æ¢å¤åˆ° PostgresSQL çš„ä¸åŒä¸»è¦ç‰ˆæœ¬ï¼Œç”šè‡³ä¸åŒçš„æ“ä½œç³»ç»Ÿæ¶æ„ä¸­ åŠ£åŠ¿ï¼š é€»è¾‘å¤‡ä»½åœ¨æ¢å¤æ—¶ï¼Œéœ€è¦ replay ,å¦‚æœæ•°æ®é‡å¤§ï¼Œéœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œè€Œä¸”å¯èƒ½ä¼šé™ä½æ•´ä½“æ€§èƒ½ ä¸æ”¯æŒå…¨å±€å˜é‡çš„ dump, åªèƒ½ç”¨ pg_dumpall 2. Physical Backup ç‰©ç†å¤‡ä»½æ˜¯åœæ­¢ PostgreSQL é›†ç¾¤åè¿›è¡Œçš„ PostgreSQL ç¦»çº¿å¤‡ä»½,è¿™äº›å¤‡ä»½åŒ…å«æ•´ä¸ªé›†ç¾¤æ•°æ®ã€‚ ä¼˜åŠ¿ï¼š å¤‡ä»½å’Œæ¢å¤é€Ÿåº¦å¿« é€‚åˆå¤§å‹æ•°æ®åº“ é€‚åˆé«˜å¯ç”¨åœºæ™¯ åŠ£åŠ¿ï¼š ä¸èƒ½è·¨ç‰ˆæœ¬æ¢å¤ ä¸èƒ½è·¨æ“ä½œç³»ç»Ÿæ¢å¤ 3. Continuous Archiving and Point-in-Time Recovery (PITR) Online Backup æˆ–è€…å« Hot Backup, å…ˆè¿›è¡Œå®Œæ•´çš„å¤‡ä»½,å¯ä»¥åœ¨ä¸åœæ­¢ PostgreSQL é›†ç¾¤çš„æƒ…å†µä¸‹åœ¨çº¿è¿›è¡Œã€‚å¢é‡å¤‡ä»½ç”Ÿæˆçš„ WAL æ—¥å¿—ï¼Œç„¶åå¯ä»¥é€šè¿‡æ¢å¤ WAL æ¥æ¢å¤å­˜æ¡£/WALã€‚ ä¼˜åŠ¿ï¼š å¯ä»¥æ¢å¤åˆ°ä»»ä½•æ—¶é—´ç‚¹ ä¸ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°ä»»ä½•åœæœº åŠ£åŠ¿ï¼š å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´æ‰èƒ½ä»å­˜æ¡£ä¸­æ¢å¤æ•°æ®ï¼Œè¿™äº›ä¸»è¦ç”¨äºå®¹é‡å·¨å¤§ã€æ— æ³•è¿›è¡Œé¢‘ç¹å¤‡ä»½çš„æ•°æ®åº“ã€‚ 4. Snapshots and Cloud Backups å¿«ç…§éœ€è¦æ“ä½œç³»ç»Ÿæˆ–è€… cloud provider çš„æ”¯æŒï¼Œæœ‰rsyncç­‰å·¥å…·å¯ä»¥ç”¨æ¥æ‹æ‘„å¿«ç…§ã€‚ åŠ£åŠ¿ï¼š ä¸é€‚ç”¨äºæ•°æ®åº“å°†è¡¨ç©ºé—´å­˜å‚¨åœ¨å¤šä¸ªé©±åŠ¨å™¨å·ä¸­çš„æƒ…å†µã€‚ å¤‡ä»½éœ€è¦è€ƒè™‘å¾ˆå¤šæƒ…å†µï¼Œæ¯”å¦‚å¤‡ä»½çš„é¢‘ç‡ã€å¤‡ä»½çš„å­˜å‚¨ä½ç½®ã€å¤‡ä»½çš„æ¢å¤æ—¶é—´ã€å¤‡ä»½ä¿ç•™ç­–ç•¥ç­‰ç­‰ï¼Œæ‰€ä»¥éœ€è¦ä¸€äº›å·¥å…·è¾…åŠ©æˆ‘ä»¬æ¥è¿›è¡Œå¤‡ä»½ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„å¼€æºå·¥å…·å¦‚ä¸‹ï¼š pgbackrest EDB barman WAL-G ä»è¿™ä¸ªè®¨è®ºä¸­ï¼Œå¯ä»¥çœ‹åˆ° barman ç›¸å¯¹äº pgbackrest è¿˜æ˜¯æœ‰äº›åŠŸèƒ½çš„ç¼ºå¤±ï¼š Zstd å‹ç¼© Delta restore Encryption at rest Native postgres page checksum validation Multi repo ","date":"2024-07-26","objectID":"/postgres-ha/:4:1","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"High Availability Patroni Patroni é»˜è®¤ä½¿ç”¨çš„æ˜¯å¼‚æ­¥çš„ Streaming Replicationï¼Œè¿™æ„å‘³ç€ä¸»èŠ‚ç‚¹ä¸Šçš„äº‹åŠ¡æäº¤åï¼Œå¯èƒ½ä¼šæœ‰ä¸€æ®µæ—¶é—´æ‰ä¼šè¢«å¤åˆ¶åˆ°å¤‡èŠ‚ç‚¹ä¸Šã€‚è¿™æ®µæ—¶é—´å†…ï¼Œå¦‚æœä¸»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œå¯èƒ½ä¼šä¸¢å¤±è¿™æ®µæ—¶é—´å†…çš„æ•°æ®ã€‚ä¸ºäº†å‡å°‘è¿™ç§æ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥ä½¿ç”¨åŒæ­¥å¤åˆ¶ï¼Œä½†æ˜¯åŒæ­¥å¤åˆ¶ä¼šå½±å“ä¸»èŠ‚ç‚¹çš„æ€§èƒ½ï¼Œå› ä¸ºä¸»èŠ‚ç‚¹å¿…é¡»ç­‰å¾…æ‰€æœ‰å¤‡èŠ‚ç‚¹éƒ½å·²ç»æ¥æ”¶åˆ°å¹¶å†™å…¥ WAL æ—¥å¿—åæ‰èƒ½æäº¤äº‹åŠ¡ã€‚æ‰€ä»¥éœ€è¦åœ¨å¯ç”¨æ€§å’Œæ€§èƒ½ä¹‹é—´åšå¹³è¡¡ã€‚ Patroni çš„ maximum_lag_on_failover å’Œ pg çš„ wal_segsize çš„å¤§å°ï¼Œéœ€åœ¨å¯ç”¨æ€§å’ŒæŒä¹…æ€§ä¹‹é—´åšå¹³è¡¡ã€‚ maximum_lag_on_failover é»˜è®¤ 1MB(1048576 bytes) æ„æ€æ˜¯å¦‚æœæœ‰ä¸ªèŠ‚ç‚¹æ»åè¶…è¿‡è¿™ä¸ªå€¼ï¼Œå°±ä¸ä¼šè¢«é€‰ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚ä¸€èˆ¬é…åˆ loop_wait å’Œ ttl å‚æ•° ä¸€èµ·ä½¿ç”¨ã€‚ä¾‹å¦‚ ttl æ˜¯ 30 çš„è¯ï¼Œå¦‚æœ Patroni èŠ‚ç‚¹åœ¨ 30 ç§’å†…æœªèƒ½ä¸ Etcd æˆ– Consul ç»­çº¦ï¼Œåˆ™è¯¥èŠ‚ç‚¹å°†è¢«è®¤ä¸ºå¤±å»äº†é¢†å¯¼æƒã€‚loop_wait è®¾ç½®ä¸º 10 ç§’ï¼ŒPatroni æ¯éš” 10 ç§’æ‰§è¡Œä¸€æ¬¡å…¶ä¸»è¦æ“ä½œå¾ªç¯ï¼ŒåŒ…æ‹¬çŠ¶æ€æ£€æŸ¥å’Œå¿…è¦çš„æ“ä½œã€‚æœ€åçš„æƒ…å†µä¸‹çš„ä¸Ÿå¤±é‡ï¼šmaximum_lag_on_failover å­—èŠ‚+æœ€åçš„ TTLç§’æ—¶é—´å†…å†™å…¥çš„æ—¥å¿—é‡ã€‚å‡å°è¯¥å€¼å¯ä»¥é™ä½æ•…éšœåˆ‡æ¢æ—¶çš„æ•°æ®æŸå¤±ä¸Šé™ï¼Œä½†ä¹Ÿä¼šå¢åŠ æ•…éšœæ—¶å› ä¸ºä»åº“ä¸å¤Ÿå¥åº·ï¼ˆè½åå¤ªä¹…ï¼‰è€Œæ‹’ç»è‡ªåŠ¨åˆ‡æ¢çš„æ¦‚ç‡ã€‚ wal_segsize å‚æ•°å®šä¹‰äº†æ¯ä¸ª WAL æ—¥å¿—æ®µæ–‡ä»¶çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ 16MB ","date":"2024-07-26","objectID":"/postgres-ha/:4:2","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"æ¶æ„ ç›®å‰ Postgres é«˜å¯ç”¨æ¶æ„ç¹å¤šï¼Œè¿™é‡Œåˆ—ä¸¾ä¸¤ç§å¸¸è§çš„æ¶æ„ï¼Œåˆ†åˆ«å¯¹åº”è‡ªå»º Postgres ä»¥åŠäº‘ä¸Šæ‰˜ç®¡ Postgres çš„å…¸å‹æ¶æ„ï¼š Pigsty Cloudnative-PG HA ","date":"2024-07-26","objectID":"/postgres-ha/:5:0","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"Pigsty HA æ¶æ„ ä¸‹å›¾æ¥è‡ªäº pigsty: è‡ªä¸Šè€Œä¸‹ï¼š åº”ç”¨å±‚é€šè¿‡ DNS è§£æåˆ° vip-manager çš„ VIPï¼Œvip-manager é€šè¿‡ etcd è·å–å½“å‰ä¸»åº“çš„ IP åœ°å€ï¼Œç„¶åå°† L2 VIP ç»‘å®šåˆ°ä¸»åº“æ‰€åœ¨èŠ‚ç‚¹ï¼›é€šè¿‡ HAProxy è¿›è¡Œ L5 å±‚ç«¯å£è½¬å‘ã€‚ Patroniï¼šåŒæ­¥ä¸»èŠ‚ç‚¹ä¿¡æ¯ç»™åˆ° etcdã€‚ vip-managerï¼šè™šæ‹Ÿ ip å’ŒçŠ¶æ€ç”± etcd è¿›è¡ŒåŒæ­¥ç®¡ç†ã€‚ HAProxyï¼šæ ¹æ®ç«¯å£åˆ†åˆ«è¿›è¡Œè·¯ç”± 5433ï¼šè¿æ¥ PGBouncer è¿æ¥æ± ï¼Œè¿æ¥ primary è¿›è¡Œ read/write 5434ï¼šè¿æ¥ PGBouncer è¿æ¥æ± ï¼Œè¿æ¥ replica è¿›è¡Œ read-only 5436ï¼šç›´è¿ primaryï¼Œç®¡ç†ä½¿ç”¨ 5438ï¼šç›´è¿ replicaï¼Œç®¡ç†ä½¿ç”¨ï¼Œè¿æ¥ä¸å¤„ç†åœ¨çº¿è¯»å–æµé‡çš„ä¸“ç”¨å‰¯æœ¬ï¼Œç”¨äºETLå’Œåˆ†ææŸ¥è¯¢ã€‚ primary å’Œ replica é€šè¿‡ Streaming Replication è¿›è¡Œ WAL æ—¥å¿—çš„åŒæ­¥ï¼Œprimary é€šè¿‡ pg_receivexlog å°† WAL æ—¥å¿—å‘é€åˆ° replicaï¼Œreplica é€šè¿‡ pg_replay è¿›è¡Œ WAL æ—¥å¿—çš„é‡æ”¾ã€‚ Patroni é€šè¿‡ pgBackRest è¿›è¡Œå¤‡ä»½ï¼Œå¤‡ä»½æ•°æ®å¯å­˜å‚¨åœ¨æœ¬åœ°ï¼Œè¿œç¨‹ s3 æˆ–è€… minio å­˜å‚¨ä¸­, å¯å‚è€ƒæ–‡æ¡£ã€‚ PostgreSQL ä½¿â½¤æ ‡å‡†æµå¤åˆ¶æ­å»ºç‰©ç†ä»åº“ï¼Œä¸»åº“æ•…éšœæ—¶ç”±ä»åº“æ¥ç®¡ã€‚ Patroni è´Ÿè´£ç®¡ç† PostgreSQL æœåŠ¡å™¨è¿›ç¨‹ï¼Œå¤„ç†é«˜å¯ç”¨ç›¸å…³äº‹å®œã€‚ Etcd æä¾›åˆ†å¸ƒå¼é…ç½®å­˜å‚¨ï¼ˆDCSï¼‰èƒ½åŠ›ï¼Œå¹¶ç”¨äºæ•…éšœåçš„é¢†å¯¼è€…é€‰ä¸¾ Patroni ä¾èµ– Etcd è¾¾æˆé›†ç¾¤é¢†å¯¼è€…å…±è¯†ï¼Œå¹¶å¯¹å¤–æä¾›å¥åº·æ£€æŸ¥æ¥å£ã€‚ HAProxy å¯¹å¤–æš´éœ²é›†ç¾¤æœåŠ¡ï¼Œå¹¶åˆ©â½¤ Patroni å¥åº·æ£€æŸ¥æ¥å£ï¼Œè‡ªåŠ¨åˆ†å‘æµé‡è‡³å¥åº·èŠ‚ç‚¹ã€‚ vip-manager æä¾›ä¸€ä¸ªå¯é€‰çš„äºŒå±‚ VIPï¼Œä» Etcd ä¸­è·å–é¢†å¯¼è€…ä¿¡æ¯ï¼Œå¹¶å°† VIP ç»‘å®šåœ¨é›†ç¾¤ä¸»åº“æ‰€åœ¨èŠ‚ç‚¹ä¸Šã€‚ åœ¨ä¸»ä»æ¶æ„+æ•…éšœè‡ªåŠ¨åˆ‡æ¢+åŒæ­¥ streaming replication +pgBackRest å¤‡ä»½çš„æƒ…å†µä¸‹ RTO åœ¨ 1min å†…ä¸” RPO ä¸º 0ï¼Œå³åœ¨ä¸ä¸¢å¤±æ•°æ®çš„æƒ…å†µä¸‹ 1min æ¢å¤ã€‚ ","date":"2024-07-26","objectID":"/postgres-ha/:5:1","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"Cloudnative-PG HA æ¶æ„ æ ¹æ® Kubernetes å®¹å™¨ç¼–æ’çš„ç‰¹ç‚¹ï¼ŒCloudnative-PG HA æ¶æ„é‡‡ç”¨äº†æ›´åŠ ç°ä»£åŒ–çš„æ¶æ„ï¼š å¤š region éƒ¨ç½² Kubernetes å¤šå¯ç”¨åŒºï¼ˆå¤§äºç­‰äº3ï¼‰éƒ¨ç½² PostgreSQL èŠ‚ç‚¹ Primary-Standby é‡‡ç”¨åŒæ­¥æˆ–è€…å¼‚æ­¥ Streaming Replication PostgreSQL å®ä¾‹ä¸å…±äº«èµ„æº,ç‹¬å èŠ‚ç‚¹èµ„æºï¼Œåœ¨ä¸åŒçš„ Kubernetes å·¥ä½œèŠ‚ç‚¹ï¼Œä½¿ç”¨æœ¬åœ°å· åº”ç”¨å±‚æä¾› rwã€roã€r ä¸‰ç§æœåŠ¡ï¼Œåˆ†åˆ«æœåŠ¡è¿æ¥ä¸»èŠ‚ç‚¹ã€åªè¯»å·¥ä½œè´Ÿè½½çš„çƒ­å¤‡ç”¨å‰¯æœ¬ã€ä»»æ„åªè¯»å·¥ä½œè´Ÿè½½ã€åœ¨å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æ›´æ–°æœåŠ¡ä»¥æŒ‡å‘å‡çº§çš„æœåŠ¡ï¼Œç¡®ä¿æ¥è‡ªåº”ç”¨ç¨‹åºçš„æµé‡æ— ç¼é‡å®šå‘ã€‚ æä¾› Pooler å¯¹è±¡ï¼Œåˆ›å»º PGBouncer è¿æ¥æ± ï¼Œç”¨äºè¿æ¥ä¸»èŠ‚ç‚¹å’Œåªè¯»èŠ‚ç‚¹ é€šè¿‡ Replica Cluster è·¨å¤šä¸ª Kubernetes é›†ç¾¤éƒ¨ç½² PostgreSQL é€šè¿‡å°† PostgreSQL å¤‡ä»½æ•°æ®å­˜å‚¨åœ¨å¤šä¸ª locationã€region å¹¶å¯èƒ½ä½¿ç”¨ä¸åŒçš„æä¾›å•†ï¼ˆç¾éš¾æ¢å¤ï¼‰æ¥å‡å°‘å…¨å±€æ¢å¤ç‚¹ç›®æ ‡ (RPO) é€šè¿‡åˆ©ç”¨ä¸» Kubernetes é›†ç¾¤ä¹‹å¤–çš„ PostgreSQL å¤åˆ¶æ¥å‡å°‘å…¨å±€æ¢å¤æ—¶é—´ç›®æ ‡ (RTO)ï¼ˆé«˜å¯ç”¨æ€§ï¼‰ æŒ‡å®šçš„ä¸»é›†ç¾¤å¯ä»¥éšæ—¶å‡çº§ï¼Œä½¿å‰¯æœ¬é›†ç¾¤æˆä¸ºèƒ½å¤Ÿæ¥å—å†™è¿æ¥çš„ä¸»é›†ç¾¤ã€‚ WAL é€šè¿‡ s3 è¿›è¡Œå½’æ¡£ é€šè¿‡ barman è¿›è¡Œå¤‡ä»½ï¼Œå¯ä»¥å¤‡ä»½åˆ°äº‘å¯¹è±¡å­˜å‚¨ä¾‹å¦‚ s3 æˆ–è€…ä½¿ç”¨ Volume Snapshot è¿›è¡Œå¤‡ä»½ åœ¨ä¸Šè¿°æ¶æ„ä¸‹å¯ä¸ºè·¨åŒºåŸŸç¾éš¾æ¢å¤æä¾›æœ€å¤šå¤§çº¦ 5 åˆ†é’Ÿçš„ RPOï¼Œå¦‚æœä½¿ç”¨åŒæ­¥ Streaming Replication å¯ä»¥è¾¾åˆ° 0 RPO, ä¸”å…·å¤‡æä½çš„ RTOã€‚ ","date":"2024-07-26","objectID":"/postgres-ha/:5:2","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"Supabase Backup Click me ```mermaid graph TD; A(Supabase Backup)---\u003eB(Pro); B(Pro)---\u003eE(Database Size 0-40GB); B(Pro)---\u003eF(Database Size 40GB+); B(Pro)---\u003eG(PITR); B(Pro)---\u003eH(Read Replica); E(Database Size 0-40GB)---\u003eI(Logical Backup); F(Database Size 40GB+)---\u003eJ(Physical Backup); G(PITR)---\u003eJ(Physical Backup); H(Read Replica)---\u003eJ(Physical Backup); A(Supabase Backup)---\u003eC(Team); C(Team)---\u003eK(Database Size 0-40GB); C(Team)---\u003eL(Database Size 40GB+); C(Team)---\u003eM(PITR); C(Team)---\u003eN(Read Replica); K(Database Size 0-40GB)---\u003eI(Logical Backup); L(Database Size 40GB+)---\u003eJ(Physical Backup); M(PITR)---\u003eJ(Physical Backup); N(Read Replica)---\u003eJ(Physical Backup); A(Supabase Backup)---\u003eD(Enterprise); D(Enterprise)---\u003eO(Database Size 0-40GB); D(Enterprise)---\u003eP(Database Size 40GB+); D(Enterprise)---\u003eQ(PITR); D(Enterprise)---\u003eR(Read Replica); O(Database Size 0-40GB)---\u003eJ(Physical Backup); P(Database Size 40GB+)---\u003eJ(Physical Backup); Q(PITR)---\u003eJ(Physical Backup); R(Read Replica)---\u003eJ(Physical Backup); ``` Click me ```mermaid graph TD; A(Supabase Backup)--\u003eB(Pro); A(Supabase Backup)--\u003eC(Team); A(Supabase Backup)--\u003eD(Enterprise); B(Pro)--\u003eE(Daily Backup, Retain 7 days); E--\u003eH(pg_dumpall logical backupï¼Œ when database size \u003e 40GB will use physical backup); C(Team)--\u003eF(Daily Backup, Retain 2 weeks); F--\u003eH(pg_dumpall logical backupï¼Œ when database size \u003e 40GB will use physical backup); D(Enterprise)--\u003eG(Daily Backup, Retain 1 month); D--\u003eJ(physical backup); ``` ç”¨æˆ·å¯ä»¥è®¿é—®æ¯ä¸€å¤©ç”Ÿæˆçš„ logical backup çš„ sql æ–‡ä»¶è¿›è¡Œ restoreã€‚ Click me ```mermaid graph LR; A(Supabase PITR)--\u003eB(WAL-G, archiving Write Ahead Log files, default 2 min or certain file size threshold and physical backups); B--\u003eC(2 minutes RPO); C--\u003eD(show database restore available from and latest restore available at); ``` Click me ```mermaid graph LR; A(PGVecto.rs Cloud PITR)--\u003eB(barman-cloud-wal-archive archiving Write Ahead Log files, default 5 min or certain file size threshold and barman-cloud-backup for physical backups); B--\u003eC(5 minutes RPO); C--\u003eD(show database restore available from and latest restore available at); D--\u003eE(delete cluster will delete all wal and physical backups); ``` ","date":"2024-07-26","objectID":"/postgres-ha/:5:3","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2024","Postgres"],"content":"å¼•ç”¨ https://pigsty.io/ https://cloudnative-pg.io/ https://www.cnblogs.com/xianghuaqiang/p/14792001.html https://docs.pgbarman.org/release/3.10.1/ https://github.com/cloudnative-pg/cloudnative-pg/discussions/3145 https://supabase.com/blog/postgresql-physical-logical-backups ","date":"2024-07-26","objectID":"/postgres-ha/:6:0","tags":["High Availability","Postgres"],"title":"Postgres é«˜å¯ç”¨","uri":"/postgres-ha/"},{"categories":["2022","kubernetes","documentation"],"content":"æœ€è¿‘åœ¨æåœ¨å†…éƒ¨è‡ªç ”å¹³å°ä¸Šåšä¸€äº› NUMA æ„ŸçŸ¥è°ƒåº¦çš„å·¥ä½œï¼Œæ¶‰åŠåˆ° kubernetes èŠ‚ç‚¹èµ„æºæ‹“æ‰‘çš„å‘ç°ä»¥åŠè°ƒåº¦æ–¹é¢çš„å†…å®¹ã€‚ä½†æ˜¯æ— å¥ˆæ‰ç–å­¦æµ…ï¼Œé‡åˆ°é—®é¢˜æŸ¥é—®é¢˜ï¼Œä¸€çŸ¥åŠè§£çš„å§‹ç»ˆæŠ“ä¸åˆ°å¤´ç»ªï¼Œè°¨ä»¥æ­¤ç¯‡æ–‡ç« æ¥æ¢³ç†æ€»ç»“ã€‚ ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:0:0","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"ä¸ºå•¥éœ€è¦æ„ŸçŸ¥æ‹“æ‰‘ è¿™é‡Œ kubernetes å®˜æ–¹è¯´äº†ï¼šç›®å‰è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿåˆ©ç”¨ CPU å’Œç¡¬ä»¶åŠ é€Ÿå™¨ï¼Œæ¯”å¦‚ GPU,DPU æ¥æ”¯æŒä½å»¶è¿Ÿçš„ä»»åŠ¡ä»¥åŠé«˜ååçš„å¹¶è¡Œè®¡ç®—ä»»åŠ¡ã€‚ ä½†æ˜¯å¥½åƒåˆè¯´çš„ä¸æ¸…æ¥šï¼Œå…¶å®æœ¬è´¨åŸå› æ˜¯å†¯è¯ºä¾æ›¼æ¶æ„å¸¦æ¥çš„é—®é¢˜ã€‚è¿˜æ˜¯é‚£å¥è€è¯ï¼Œæ²¡æœ‰é“¶å¼¹ï¼Œå†¯è¯ºä¾æ›¼æ¶æ„å°†å­˜å‚¨å™¨å’Œè¿ç®—å™¨åˆ†å¼€ï¼ŒæŒ‡ä»¤å’Œæ•°æ®å‡æ”¾åœ¨å­˜å‚¨å™¨ï¼Œä¸ºç°ä»£è®¡ç®—çš„é€šç”¨æ€§å¥ å®šäº†åŸºç¡€ã€‚ä½†æ˜¯ä¹ŸåŸ‹ä¸‹äº†éšæ‚£ï¼Œé‚£å°±æ˜¯å†…å­˜å®¹é‡æŒ‡æ•°çº§æå‡åï¼ŒCPU å’Œå†…å­˜ä¹‹å‰çš„æ•°æ®ä¼ è¾“æˆä¸ºäº†ç“¶é¢ˆã€‚ç›®å‰æœåŠ¡å™¨ä¸­çš„è®¾å¤‡åŸºæœ¬éƒ½æ˜¯é€šè¿‡ PCIe æ€»çº¿è¿›è¡Œé«˜é€Ÿè¿æ¥ï¼Œè€Œä¸åŒçš„ç”¨é€”çš„æœåŠ¡å™¨å¯èƒ½å…¶æ€»çº¿å¸ƒå±€ä¹Ÿä¸ç›¸åŒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆç½‘ä¸Šæ‰¾åˆ°çš„ï¼Œéæœ¬äººæ‰€ç”»ï¼‰,å·¦å›¾ GPU é©»ç•™åœ¨ä¸åŒçš„ PCIe åŸŸä¸Šï¼ŒGPU å†…å­˜ä¹‹é—´çš„ç›´æ¥ P2P å¤åˆ¶æ˜¯ä¸å¯èƒ½çš„ï¼Œä» GPU 0 çš„å†…å­˜å¤åˆ¶åˆ° GPU 2 çš„å†…å­˜éœ€è¦é¦–å…ˆé€šè¿‡ PCIe å¤åˆ¶åˆ°è¿æ¥åˆ° CPU 0 çš„å†…å­˜ï¼Œç„¶åé€šè¿‡ QPI é“¾æ¥ä¼ è¾“åˆ° CPU 1 å¹¶å†æ¬¡é€šè¿‡ PCIe ä¼ è¾“åˆ° GPU 2ã€‚å¯ä»¥æƒ³è±¡è¿™ä¸ªè¿‡ç¨‹åœ¨å»¶è¿Ÿå’Œå¸¦å®½æ–¹é¢å¢åŠ äº†å¤§é‡çš„å¼€é”€ï¼Œè€Œå³å›¾å¯ä»¥é€šè¿‡ GPU P2P è¿æ¥å®ç°è¶…é«˜é€Ÿé€šä¿¡ã€‚ç®€å•æ€»ç»“ä¸‹ï¼Œæ‹“æ‰‘ä¼šå½±å“è®¾å¤‡é—´çš„é€šä¿¡ï¼Œé€šä¿¡å¯¹ä¸šåŠ¡é€ æˆç¨³å®šæ€§ä»¥åŠæ•ˆç‡ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µè®©ä¸šåŠ¡æ„ŸçŸ¥æ‹“æ‰‘ã€‚ PCIe Topo (figure 1) ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:1:0","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"æ‹“æ‰‘ç±»å‹ ç›®å‰æœ‰å“ªäº›æ‹“æ‰‘éœ€è¦æ„ŸçŸ¥: GPU Topology Awareness NUMA Topology Awareness ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:2:0","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"GPU Topology Manager ä¸šç•Œç›®å‰æœ‰å‡ ç§å®ç°æ–¹æ¡ˆï¼š Volcano GPU Topology Awareness ç™¾åº¦æ™ºèƒ½äº‘ GPU æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦ Volcano ç›®å‰æœªå®Œå…¨å®ç°ï¼Œæ™ºèƒ½äº‘é—­æºåªèƒ½é€šè¿‡ä¸€äº›åˆ†äº«çš„ä¿¡æ¯ï¼Œç®¡ä¸­çª¥è±¹ã€‚ Why ä¸ºä»€ä¹ˆéœ€è¦ GPU çš„æ‹“æ‰‘æ„ŸçŸ¥ï¼Œé¦–å…ˆä¸Šä¸ªå›¾ï¼Œè¿™å¼ å›¾æ¥è‡ª NVIDIA å®˜æ–¹ï¼Œæè¿°äº†ç°åœ¨ä¸»æµçš„ GPU æ˜¾å¡ V100 åœ¨æœåŠ¡å™¨ä¸­çš„æ‹“æ‰‘å…³ç³»ã€‚ GPU Topo (figure 2) æ¯å— V100 GPUæœ‰6ä¸ª NVLink é€šé“ï¼Œ8å— GPU é—´æ— æ³•åšåˆ°å…¨è¿æ¥ï¼Œ2å— GPU é—´æœ€å¤šåªèƒ½æœ‰2æ¡ NVLink è¿æ¥ã€‚å…¶ä¸­ GPU0 å’Œ GPU3ï¼ŒGPU0 å’Œ GPU4 ä¹‹é—´æœ‰2æ¡NVLink è¿æ¥ï¼ŒGPU0 å’Œ GPU1 ä¹‹é—´æœ‰ä¸€æ¡ NVLink è¿æ¥ï¼ŒGPU0 å’Œ6ä¹‹é—´æ²¡æœ‰ NVLink è¿æ¥ï¼Œæ•… GPU0 ä¸ GPU6 ä¹‹é—´ä»ç„¶éœ€è¦é€šè¿‡ PCIe è¿›è¡Œé€šä¿¡ã€‚NVlink è¿æ¥çš„å•å‘é€šä¿¡å¸¦å®½ä¸º 25 GB/sï¼ŒåŒå‘é€šä¿¡å¸¦å®½ä¸º 50 GB/sï¼ŒPCIe è¿æ¥çš„é€šä¿¡å¸¦å®½ä¸º16 GB/sã€‚æ‰€ä»¥åœ¨ GPU è®­ç»ƒè¿‡ç¨‹ä¸­å¦‚æœé”™è¯¯çš„åˆ†é…äº† GPUï¼Œ æ¯”å¦‚æŸè®­ç»ƒä»»åŠ¡ Pod ç”³è¯·äº†ä¸¤å¼ å¡ GPU0 ä¸ GPU6ï¼Œåœ¨è·¨ GPU é€šä¿¡å¯èƒ½å°±æˆä¸ºäº†è®­ç»ƒä»»åŠ¡çš„ç“¶é¢ˆã€‚ æ‹“æ‰‘ä¿¡æ¯å¯ä»¥åœ¨èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹ï¼š # nvidia-smi topo -m GPU0 GPU1 GPU2 GPU3 GPU4 GPU5 GPU6 GPU7 GPU0 X PIX PHB PHB SYS SYS SYS SYS GPU1 PIX X PHB PHB SYS SYS SYS SYS GPU2 PHB PHB X PIX SYS SYS SYS SYS GPU3 PHB PHB PIX X SYS SYS SYS SYS GPU4 SYS SYS SYS SYS X PIX PHB PHB GPU5 SYS SYS SYS SYS PIX X PHB PHB GPU6 SYS SYS SYS SYS PHB PHB X PIX GPU7 SYS SYS SYS SYS PHB PHB PIX X Legend: X = Self SYS = Connection traversing PCIe as well as the SMP interconnect between NUMA nodes (e.g., QPI/UPI) NODE = Connection traversing PCIe as well as the interconnect between PCIe Host Bridges within a NUMA node PHB = Connection traversing PCIe as well as a PCIe Host Bridge (typically the CPU) PXB = Connection traversing multiple PCIe switches (without traversing the PCIe Host Bridge) PIX = Connection traversing a single PCIe switch NV# = Connection traversing a bonded set of # NVLinks How è¿™é‡Œå°±ä¸ä¸€ä¸€è§£æï¼Œæœ¬èº«ä¹Ÿæ²¡å®Œæ•´çš„å®ç°æ¥çœ‹ï¼Œå°±ä»¥æˆ‘è‡ªå·±çš„ç†è§£æ¥æ¢³ç†å‡ºä¸€äº›å¤§è‡´æ€è·¯ã€‚ ç¬¬ä¸€æ­¥å…¶å®æ˜¯æ„ŸçŸ¥ï¼Œå³é€šè¿‡ daemon ç»„ä»¶æ¥è¿›è¡Œ nvidia gpu ã€ç½‘ç»œæ‹“æ‰‘ã€NVLinkã€PCIe çš„ä¿¡æ¯ã€‚ç¬¬äºŒæ­¥åˆ™æ˜¯è°ƒåº¦å™¨ï¼Œå®šä¹‰ç­–ç•¥ã€‚ç­–ç•¥1ï¼šä¼˜å…ˆå°†åŒä¸€ä¸ª NUMA node ä¸‹ NVLink æ•°æœ€å¤šçš„ GPU è°ƒåº¦åˆ°ä¸€ä¸ª Pod ä¸Šï¼›ç­–ç•¥2ï¼šä¼˜å…ˆå°†å¤„äºåŒä¸€ä¸ª PCI switch çš„ GPU å’Œç½‘å¡åˆ†é…ç»™åŒä¸€ä¸ª Podã€‚å¤§è‡´æ•´ä½“æ€è·¯å¦‚ä¸‹ï¼š GPU-device-plugin æˆ–è€…å…¶ä»– daemon è¿›ç¨‹ï¼Œæ„é€ èŠ‚ç‚¹çš„ GPU æ‹“æ‰‘ä¿¡æ¯ CRDï¼› Pod å®šä¹‰ topo ç­–ç•¥ï¼Œæ¯”å¦‚ç­–ç•¥1æˆ–è€…ç­–ç•¥2ï¼› æ–°å®šä¹‰è°ƒåº¦å™¨ä¼šæ ¹æ® pod è°ƒåº¦çš„ç­–ç•¥ fliter ã€priorityé˜¶æ®µè¿‡æ»¤ä¸æ»¡è¶³ç­–ç•¥èŠ‚ç‚¹ï¼Œç»™æ»¡è¶³ç­–ç•¥èŠ‚ç‚¹æ‰“é«˜åˆ†ï¼› å…³äºèŠ‚ç‚¹ gpu device çš„å‘ç°æ›´æ–°äº¤ç»™ device-plugin å’Œ kubelet æ¥åš, å‚è§æ–‡ç« ã€‚ ç›®å‰ GPU æ‹“æ‰‘ä¿¡æ¯å¯ä»¥é€šè¿‡å®˜æ–¹çš„ nvml (NVIDIA Management Library) é€šè¿‡æ¥å£æŸ¥è¯¢ã€‚ ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:2:1","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"NUMA Topology Awareness Why è°ˆåˆ° NUMA æ‹“æ‰‘æ„ŸçŸ¥ï¼Œä¸€å®šè¦å…ˆè§£é‡Š NUMA æ˜¯å¹²å•¥å‘¢ï¼Œä¸ºå•¥è¦æ„ŸçŸ¥å®ƒå‘¢ï¼Ÿ NUMA Topo (figure 3) CPU Cache Latency (figure 4) ä¸Šé¢ä¸¤å¹…å›¾ç»™ä½ ç­”æ¡ˆï¼Œç°ä»£ CPU å¤šé‡‡ç”¨ NUMA æ¶æ„ï¼Œ NUMA å…¨ç§° â€œNon-Uniform Memory Accessâ€ å³éä¸€è‡´æ€§å†…å­˜è®¿é—®ã€‚ä¸ºå•¥æä¸ªéä¸€è‡´æ€§ï¼Œä¸€è‡´æ€§ä¸å¥½å—ï¼Ÿç­”æ¡ˆè‚¯å®šæ˜¯ä¸å¥½ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨ UMA å³ä¸€è‡´æ€§å†…å­˜è®¿é—®ï¼Œéšç€åŒ—æ¡¥ä¸Šçš„ç‰©ç†æ ¸å¿ƒè¶Šæ¥è¶Šå¤šï¼ŒCPUçš„é¢‘ç‡ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œæ€»çº¿å¸¦å®½æ‰›ä¸ä½ï¼Œè®¿é—®åŒä¸€å—å†…å­˜çš„å†²çªé—®é¢˜ä¹Ÿä¼šè¶Šæ¥è¶Šä¸¥é‡ã€‚æˆ‘ä»¬å›åˆ° NUMAæ¶æ„ï¼Œæ¯ä¸ª NUMA node ä¸Šä¼šæœ‰è‡ªå·±çš„ç‰©ç†CPUå†…æ ¸ï¼Œä»¥åŠæ¯ä¸ª NUMA node ä¸Šæ ¸å¿ƒä¹‹é—´ä¹‹é—´ä¹Ÿå…±äº« L3 Cacheã€‚åŒæ—¶ï¼Œå†…å­˜ä¹Ÿåˆ†å¸ƒåœ¨æ¯ä¸ªNUMA nodeä¸Šçš„ã€‚æŸäº›å¼€å¯äº†è¶…çº¿ç¨‹çš„CPUï¼Œä¸€ä¸ªç‰©ç†CPUå†…æ ¸åœ¨æ“ä½œç³»ç»Ÿä¸Šä¼šå‘ˆç°ä¸¤ä¸ªé€»è¾‘çš„æ ¸ã€‚ å›åˆ°ä¸šåŠ¡ä¾§ï¼Œå¯¹äºä¸šåŠ¡ä¾§ï¼Œå¦‚æœç¨‹åºéƒ½è·‘åœ¨åŒä¸€ä¸ªNUMA nodeä¸Šï¼Œå¯ä»¥æ›´å¥½åœ°å»å…±äº«ä¸€äº›L3 Cacheï¼ŒL3 Cacheçš„è®¿é—®é€Ÿåº¦ä¼šå¾ˆå¿«ã€‚å¦‚æœL3 Cacheæ²¡æœ‰å‘½ä¸­ï¼Œå¯ä»¥åˆ°å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œè®¿å­˜é€Ÿåº¦ä¼šå¤§å¤§é™ä½ã€‚ åœ¨å®¹å™¨å¤§è¡Œå…¶é“çš„ä»Šå¤©ï¼Œç”±äº CPU é”™è¯¯åˆ†é…çš„é—®é¢˜å°¤ä¸ºä¸¥é‡ã€‚å› ä¸ºç°åœ¨èŠ‚ç‚¹å‡ºç°äº†è¶…å–ï¼ŒèŠ‚ç‚¹ä¸Šæœ‰å¤§é‡çš„å®¹å™¨åœ¨åŒæ—¶è¿è¡Œï¼Œå¦‚æœåŒä¸€ä¸ªè¿›è¡Œåˆ†é…äº†ä¸åŒçš„ NUMA ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜ï¼š CPU äº‰æŠ¢å¸¦æ¥é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´ï¼› é¢‘ç¹çš„è¿›ç¨‹åˆ‡æ¢å¯¼è‡´ CPU é«˜é€Ÿç¼“å­˜å¤±è´¥ï¼› è·¨ NUMA è®¿å­˜ä¼šå¸¦æ¥æ›´ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆã€‚ æ€»ç»“ä¸‹ï¼šåœ¨ç°ä»£ CPU æ¶æ„ä¸‹ï¼Œå¦‚æœä¸æ„ŸçŸ¥ NUMA æ‹“æ‰‘å…³ç³»ï¼Œé”™è¯¯çš„è¿›è¡Œ CPU çš„åˆ†é…ï¼Œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå½±å“ä¸šåŠ¡çš„ SLAã€‚ How ä¸Šä¸€ç« èŠ‚é˜è¿°äº†ä¸ºä»€ä¹ˆéœ€è¦ NUMA æ„ŸçŸ¥è°ƒåº¦ï¼Œé‚£ç›®å‰æ€ä¹ˆæ„ŸçŸ¥ NUMA æ‹“æ‰‘å‘¢ï¼Œæœ‰ä»€ä¹ˆç°æˆçš„æ–¹æ¡ˆå‘¢ï¼Ÿè¿™è¾¹æˆ‘ç®€å•åˆ—ä¸‹åœ¨ Kubernetes ç”Ÿæ€çš„é¡¹ç›®ï¼Œå„ä½çœ‹å®˜å¦‚æœæœ‰è¡¥å……ï¼Œå¯åœ¨è¯„è®ºåŒºè¯„è®ºï¼š Kubernetes Topology Manager Offical Crane NUMA æ‹“æ‰‘æ„ŸçŸ¥ Koordinator Fine-grained cpu orchestration Kubernetes Topology Manager æ‹“æ‰‘ç®¡ç†å™¨ï¼ˆTopology Managerï¼‰ æ˜¯ä¸€ä¸ª kubelet ç»„ä»¶ï¼Œæ—¨åœ¨åè°ƒè´Ÿè´£è¿™äº›ä¼˜åŒ–çš„ä¸€ç»„ç»„ä»¶ã€‚Topology Manager å…¶å®æ˜¯è§£å†³ä¸€ä¸ªå†å²é—®é¢˜ï¼ŒCPU Manager å’Œ Device Manager æ˜¯ç‹¬ç«‹å·¥ä½œçš„ï¼Œäº’ç›¸ä¸æ„ŸçŸ¥ã€‚ é¦–å…ˆæ¥çœ‹ä¸‹ Kubernetes Topology Manager çš„å®ç°ï¼Œè¿™é‡Œæˆ‘ä¹Ÿä¸æƒ³é€ è½®å­äº†ï¼Œå¯ä»¥å‚çœ‹é˜¿é‡Œçš„åŒå­¦æ€»ç»“çš„ä¸€ç¯‡å¥½æ–‡ã€‚è¿™é‡Œåšä¸€ä¸ªæ€»ç»“ï¼š æ‰¾åˆ°ä¸åŒèµ„æºçš„ topology hints å³æ‹“æ‰‘ä¿¡æ¯ï¼Œ cpu çš„é€‰æ‹©æ ‡å‡†æ˜¯åœ¨æ»¡è¶³èµ„æºç”³è¯·çš„æƒ…å†µä¸‹ï¼Œæ¶‰åŠçš„ NUMA èŠ‚ç‚¹ä¸ªæ•°æœ€å°‘å‰æä¸‹æ¶‰åŠåˆ° socket ä¸ªæ•°æœ€å°çš„ä¼˜å…ˆé€‰æ‹©ã€‚ device manager åˆ™åœ¨æ»¡è¶³èµ„æºç”³è¯·æƒ…å†µä¸‹ï¼Œæ¶‰åŠ NUMA èŠ‚ç‚¹æœ€å°ä¼˜å…ˆé€‰æ‹©ã€‚ ä¸åŒ topology ç±»å‹çš„ hints åš merge æ“ä½œï¼Œä¹Ÿå°±æ˜¯ unionï¼Œé€‰å‡ºæœ€ä¼˜ç­–ç•¥ å¦‚æœé€‰åˆ°è¿˜å¥½ï¼Œå¦‚æœæ²¡é€‰å‡ºæ¥æ€ä¹ˆåŠï¼Ÿkubernetes æä¾›äº† kubelet é…ç½®ç­–ç•¥: best-effort: kubernetes èŠ‚ç‚¹ä¹Ÿä¼šæ¥çº³è¿™ä¸ª Podï¼Œå°±æ˜¯æ•ˆæœä¸è¾¾é¢„æœŸã€‚ restrictedï¼šèŠ‚ç‚¹ä¼šæ‹’ç»æ¥çº³è¿™ä¸ª Podï¼Œå¦‚æœ Pod é­åˆ°èŠ‚ç‚¹æ‹’ç»ï¼Œå…¶çŠ¶æ€å°†å˜ä¸º Terminatedã€‚ single-NUMA-nodeï¼šèŠ‚ç‚¹ä¼šæ‹’ç»æ¥çº³è¿™ä¸ªPodï¼Œå¦‚æœ Pod é­åˆ°èŠ‚ç‚¹æ‹’ç»ï¼Œå…¶çŠ¶æ€å°†å˜ä¸ºTerminatedã€‚è¿™é‡Œæ¯” restricted è¿˜å¤šä¸€ä¸ªæ¡ä»¶æ˜¯é€‰å‡ºæ¥çš„ NUMA èŠ‚ç‚¹ä¸ªæ•°éœ€è¦æ˜¯1ä¸ªã€‚ æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ° Kubernetes Topology Manager è¿˜æ˜¯åœ¨ä»¥ NUMA ä¸ºä¸­å¿ƒæ¥è¿›è¡Œä¸åŒèµ„æºï¼ˆNIC, GPU, CPUï¼‰æ¥è¿›è¡Œ complete fair æœ€çŸ­è·¯å¾„çš„é€‰æ‹©ã€‚è€Œä¸”æ˜¯åœ¨ pod è¢«è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šå kubelet æ‰§è¡Œä¸Šè¿°çš„è¿‡ç¨‹ï¼Œè¿™æ ·ä¼šå¸¦æ¥å‡ ä¸ªé—®é¢˜ï¼š pod æœ‰å¾ˆå¤§æ¦‚ç‡ä¼š Terminated, ç”Ÿäº§ä¸Šä¸å¯ç”¨ã€‚ èŠ‚ç‚¹çš„ topology-manager-policy é…ç½®ä¸æ–¹ä¾¿ï¼Œ kubelet æ¯æ¬¡é…ç½®å‚æ•°éƒ½éœ€è¦é‡å¯ï¼Œå¦‚æœé‡åˆ°ç‰¹æ®Šçš„ç‰ˆæœ¬å¯èƒ½ä¼šé‡å¯æ‰€æœ‰èŠ‚ç‚¹ podï¼Œè¯¦è§æ–‡ç«  æ‰€ä»¥æˆ‘ä»¬ä¼šæƒ³åˆ°å‡ ä¸ªä¼˜åŒ–çš„æ–¹æ¡ˆï¼š è®©ä¸€ä¸ªç±»ä¼¼ kubelet çš„ daemon è¿›ç¨‹ï¼Œå¯ä»¥å‘ç° topo å…³ç³»ï¼Œå¹¶å‘å¤–æš´éœ²ï¼› å¯ä»¥è®©æ‹“æ‰‘æ„ŸçŸ¥æ”¾åœ¨ kube-scheduler ç»™ pod åˆ†é… node çš„æ—¶å€™å°±æ„ŸçŸ¥ï¼Œè€Œä¸”å¯ä»¥æŒ‡å¯¼è°ƒåº¦ï¼› æä¾›å£°æ˜å¼çš„çµæ´»çš„ topology manager policyã€‚ ä¸‹é¢ä»‹ç»çš„å‡ ä¸ªæ‹“æ‰‘æ„ŸçŸ¥æ–¹æ¡ˆå…¶å®å°±æ˜¯åŸºäºä¸Šé¢çš„ idea åº”è¿è€Œç”Ÿçš„ã€‚ Crane NUMA æ‹“æ‰‘æ„ŸçŸ¥ é¦–å…ˆçœ‹ä¸‹ Crane NUMA æ„ŸçŸ¥è°ƒåº¦çš„æ¶æ„å›¾ã€‚ Crane NUMA Topology Aware (figure 5) å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š Crane-Agent ä»èŠ‚ç‚¹é‡‡é›†èµ„æºæ‹“æ‰‘ï¼ŒåŒ…æ‹¬NUMAã€Socketã€è®¾å¤‡ç­‰ä¿¡æ¯ï¼Œæ±‡æ€»åˆ°NodeResourceTopologyè¿™ä¸ªè‡ªå®šä¹‰èµ„æºå¯¹è±¡ä¸­ã€‚ Crane-Scheduleråœ¨è°ƒåº¦æ—¶ä¼šå‚è€ƒèŠ‚ç‚¹çš„NodeResourceTopologyå¯¹è±¡è·å–åˆ°èŠ‚ç‚¹è¯¦ç»†çš„èµ„æºæ‹“æ‰‘ç»“æ„ï¼Œåœ¨è°ƒåº¦åˆ°èŠ‚ç‚¹çš„åŒæ—¶è¿˜ä¼šä¸ºPodåˆ†é…æ‹“æ‰‘èµ„æºï¼Œå¹¶å°†ç»“æœå†™åˆ°Podçš„annotationsä¸­ã€‚ Crane-Agentåœ¨èŠ‚ç‚¹ä¸ŠWatchåˆ°Podè¢«è°ƒåº¦åï¼Œä»Podçš„annotationsä¸­è·å–åˆ°æ‹“æ‰‘åˆ†é…ç»“æœï¼Œå¹¶æŒ‰ç…§ç”¨æˆ·ç»™å®šçš„CPUç»‘å®šç­–ç•¥è¿›è¡ŒCPUSetçš„ç»†ç²’åº¦åˆ†é…ã€‚ è¿™é‡Œå…¶å®å°±å·²ç»è§£å†³ä¸Šè¿° Kubernetes Topology Manager çš„ç¼ºé™·ã€‚ä¸è¿‡æˆ‘ä»¬å‘ç°ç­–ç•¥æ€ä¹ˆé…ç½®å‘¢ï¼Œè¿™é‡Œæä¾›ä¸¤ç§ç­–ç•¥é…ç½®æ–¹æ¡ˆ ä¸šåŠ¡ä¾§ï¼Œåœ¨ pod ä¸Šæ‰“ä¸åŒçš„æ ‡ç­¾æ¥æŒ‡å®šç­–ç•¥ï¼š noneï¼šè¯¥ç­–ç•¥ä¸è¿›è¡Œç‰¹åˆ«çš„CPUSetåˆ†é…ï¼ŒPodä¼šä½¿ç”¨èŠ‚ç‚¹CPUå…±äº«æ± ã€‚ exclusiveï¼šè¯¥ç­–ç•¥å¯¹åº”kubeletçš„staticç­–ç•¥ï¼ŒPodä¼šç‹¬å CPUæ ¸å¿ƒï¼Œå…¶ä»–ä»»ä½•Podéƒ½æ— æ³•ä½¿ç”¨ã€‚ NUMAï¼šè¯¥ç­–ç•¥ä¼šæŒ‡å®šNUMA Nodeï¼ŒPodä¼šä½¿ç”¨è¯¥NUMA Nodeä¸Šçš„CPUå…±äº«æ± ã€‚ immovableï¼šè¯¥ç­–ç•¥ä¼šå°†Podå›ºå®šåœ¨æŸäº›CPUæ ¸å¿ƒä¸Šï¼Œä½†è¿™äº›æ ¸å¿ƒå±äºå…±äº«æ± ï¼Œå…¶ä»–Podä»å¯ä½¿ç”¨ã€‚ èŠ‚ç‚¹ä¾§ ç›®å‰é»˜è®¤æ˜¯ cpu manager policy æ˜¯ static å³å…è®¸ä¸ºèŠ‚ç‚¹ä¸Šå…·æœ‰æŸäº›èµ„æºç‰¹å¾çš„ Pod èµ‹äºˆå¢å¼ºçš„ CPU äº²å’Œæ€§å’Œç‹¬å æ€§ï¼› topology manager policy æ˜¯ SingleNUMANodePodLevelã€‚ å¦‚æœèŠ‚ç‚¹æ—  topology.crane.io/topology-awareness æ ‡ç­¾ï¼Œåˆ™ topology manager policy ä¸º none è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒç‰¹åˆ«çš„åŠŸèƒ½ï¼Œé»˜è®¤ kubelet çš„ static çš„ cpu manager ç­–ç•¥ï¼Œåªå¯¹ pod qos ä¸º guranteed ä¸”èµ„æºç”³è¯·ä¸ºæ•´æ•°çš„ pod ç”Ÿæ•ˆï¼Œä¸”åˆ†é…æŒ‡å®šçš„ cpu å…¶ä»–è¿›ç¨‹æ— æ³•å ç”¨ã€‚ä½†æ˜¯é…åˆ crane-agent å’Œ Crane NUMA æ„ŸçŸ¥è°ƒåº¦å, å¯ä»¥å®ç° pod å’Œ ç»‘å®šæ ¸å¿ƒçš„ pod å…±äº«èµ„æºï¼Œå¯ä»¥åœ¨åˆ©ç”¨ç»‘æ ¸æ›´å°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ›´é«˜çš„ç¼“å­˜äº²å’Œæ€§çš„ä¼˜ç‚¹çš„å‰æä¸‹ï¼Œè¿˜èƒ½è®©å…¶ä»– workload éƒ¨ç½²å…±ç”¨ï¼Œæå‡èµ„æºåˆ©ç”¨ç‡ã€‚è€Œä¸”æ”¾æ¾äº† pod çš„è¦æ±‚ï¼Œåªéœ€è¦ä»»æ„containerçš„CPU limitå¤§äºæˆ–ç­‰äº1ä¸”ç­‰äºCPU requestå³å¯ä¸ºè¯¥containerè®¾ç½®ç»‘æ ¸ã€‚å®éªŒä¸‹ï¼š $ cat nginx apiVersion: v1 kind: Pod metadata: name: nginx annotations: topology.crane.io/topology-awareness: 'true' topology.crane.io/cpu-policy: 'immovable' spec: containers: - image: nginx imagePullPolicy: Always name: nginx resources: requests: cpu: 2 memory: 1Gi limits: cpu: 2 memory: 1Gi $ k exec -it nginx /bin/bash $ taskset -cp 1 # æŸ¥çœ‹ç»‘æ ¸ pid 1's current affinity list: 0,1 # æŸ¥çœ‹ burstable pod çš„ cpuset ä¿¡æ¯ $ cat /sys/fs/cgroup/cpuset/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod2260198d_db73_41f0_8ae3_387e09d3b9ec.slice/cri-containerd-6a5dfa37f9ce9102e1f781160d1fecb11b17dc835e5d72b9d7f573b515af86b3.scope/cpuset.cpus 0-9 # change to exclusive annotations: topology.crane.io/topology-awareness: 'true' topology.crane.io/cpu-policy: 'exclusive' $","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:2:2","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2022","kubernetes","documentation"],"content":"å¼•ç”¨ è¿™é‡Œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œå†æ¬¡æ„Ÿè°¢ã€‚ https://kubernetes.io/zh-cn/ https://github.com/volcano-sh/volcano/ https://mp.weixin.qq.com/s/uje27_MHBh8fMzWATusVwQ https://www.infoq.cn/article/tdfgiikxh9bcgknywl6s https://github.com/NVIDIA/go-nvml https://gocrane.io/zh-cn/docs/ https://koordinator.sh/docs/user-manuals https://www.likakuli.com/posts/kubernetes-kubelet-restart/ https://zhuanlan.zhihu.com/p/121588317 ","date":"2022-12-29","objectID":"/kubernetes-topo-aware-all-you-need-know/:3:0","tags":["kubernetes","topo aware"],"title":"å…³äº Kubernetes ä¸­ï¼Œæ‹“æ‰‘æ„ŸçŸ¥ä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡","uri":"/kubernetes-topo-aware-all-you-need-know/"},{"categories":["2024","vector search","Postgres"],"content":"åŠ å…¥ Tensorchord å·²ç»ä¸€å¹´æœ‰ä½™ï¼Œä¸€ç›´ä¹Ÿæ²¡æœ‰æ—¶é—´é™ä¸‹å¿ƒæ¥å†™ä¸€äº›æ–‡ç« ã€‚ä¸»è¦æ˜¯æœ‰äº†å½¤å½¤å¥³å„¿åï¼Œäº‹æƒ…å¤šäº†å¾ˆå¤šã€‚ä¸­é—´ä¹Ÿç»å†è¿‡ä¸šåŠ¡ä» Serverless æ¨¡å‹æ¨ç† Modelz pivot åˆ°å‘é‡æœç´¢é¢†åŸŸ VectorChord çš„è¿‡ç¨‹ã€‚Pivot çš„ç»å†æˆ–è®¸å¯ä»¥åœ¨ä¹‹åçš„æ–‡ç« ä¸­å’Œå¤§å®¶åˆ†äº«ï¼Œæ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥ç›´æ¥è”ç³»æˆ‘ã€‚æœ€è¿‘åŠå¹´ä¸€ç›´åœ¨å¼€å‘ VectorChord Cloud, æ‰€ä»¥åœ¨è¿™é‡Œè¾¹å­¦è¾¹æ€»ç»“å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“ã€‚ ","date":"2024-07-13","objectID":"/vector-search/:0:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"1. ä»€ä¹ˆæ˜¯å‘é‡ å‘é‡åœ¨ç‰©ç†ï¼Œæ•°å­¦ï¼Œä»¥åŠè®¡ç®—æœºç§‘å­¦ç­‰é¢†åŸŸçš„å«ä¹‰éƒ½æœ‰æ‰€ä¸åŒã€‚è¿™é‡Œçš„å‘é‡ä¸»è¦æŒ‡çš„æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„å‘é‡ï¼Œä¹Ÿå°±æ˜¯ä¸€ç»„æœ‰åºçš„æ•°å€¼ã€‚åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå‘é‡é€šå¸¸ç”¨æ¥è¡¨ç¤ºæ•°æ®ï¼Œæ¯”å¦‚åœ¨æœºå™¨å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°†ä¸€å¼ å›¾ç‰‡è½¬æ¢æˆä¸€ä¸ªå‘é‡ï¼Œæˆ–è€…å°†ä¸€æ®µæ–‡å­— tokenizer ä¹‹åè½¬æ¢æˆä¸€ä¸ªå‘é‡ï¼Œç„¶åå†è¿›è¡Œè®­ç»ƒã€‚åœ¨å‘é‡æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°†ä¸€å¼ å›¾ç‰‡ï¼Œä¸€æ®µæ–‡æœ¬ï¼Œæˆ–è€…ä¸€æ®µéŸ³é¢‘é€šè¿‡ embedding æ¨¡å‹è½¬æ¢æˆä¸€ä¸ªå‘é‡ï¼Œç„¶åå†è¿›è¡Œå­˜å‚¨å’Œæ£€ç´¢ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬é€šè¿‡ all-MiniLM-L6-v2 æ¨¡å‹å°†ä¸€æ®µæ–‡æœ¬è½¬æ¢æˆä¸€ä¸ªå‘é‡ã€‚all-MiniLM-L6-v2 å°†å¥å­å’Œæ®µè½æ˜ å°„åˆ° 384 ç»´ dense vectorï¼Œå¹¶å¯ç”¨äºèšç±»æˆ–è¯­ä¹‰æœç´¢ç­‰ä»»åŠ¡ã€‚ from sentence_transformers import SentenceTransformer # åˆå§‹åŒ–æ¨¡å‹ model = SentenceTransformer('all-MiniLM-L6-v2') # è¦åµŒå…¥çš„æ–‡æœ¬ç¤ºä¾‹ sentences = [ \"Hugging Face is creating a tool that democratizes AI.\", \"I love natural language processing.\", \"Transformers are state-of-the-art models for NLP tasks.\" ] # ç”ŸæˆåµŒå…¥ embeddings = model.encode(sentences) # æ‰“å°åµŒå…¥ for sentence, embedding in zip(sentences, embeddings): print(f\"Sentence: {sentence}\") print(f\"Embedding: {embedding}\\n\") æ€»ç»“ä¸€ä¸‹,å‘é‡å…¶å®æ˜¯çœŸå®ä¸–ç•Œçš„å®ä½“å’Œè®¡ç®—æœºä¸–ç•Œçš„æ¡¥æ¢, è®¡ç®—æœºé€šè¿‡å‘é‡æ¥ç†è§£å’Œå¤„ç†çœŸå®ä¸–ç•Œçš„æ•°æ®ã€‚ ","date":"2024-07-13","objectID":"/vector-search/:1:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"2. ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“ ä¸–ç•Œæœ¬æ²¡æœ‰å‘é‡æ•°æ®åº“ï¼Œåªæ˜¯å‘é‡å¤šäº†ï¼Œå°±æˆäº†å‘é‡æ•°æ®åº“ï¼Œå¼€ä¸ªç©ç¬‘hhã€‚è¿™é‡Œæˆ‘ç»™ä¸ªç®€å•çš„å®šä¹‰ï¼šèƒ½å¤Ÿç´¢å¼•å¹¶å­˜å‚¨ vectorï¼Œä»¥å®ç°å¿«é€Ÿæ£€ç´¢å’Œç›¸ä¼¼æ€§æœç´¢åŠŸèƒ½çš„æ•°æ®åº“ã€‚ç½‘ç»œä¸Šå¾ˆå¤šäººå°†å‘é‡æ•°æ®åº“å®šä¹‰ä¸ºä¸“æ³¨äºå¤„ç†å‘é‡æ•°æ®çš„æ•°æ®åº“ï¼Œè¿™ä¸ªå®šä¹‰æ˜¯ä¸å‡†ç¡®çš„ã€‚å‡†ç¡®çš„è¯´å‘é‡ä¸å‘é‡æœç´¢æ˜¯ä¸€ç§æ–°çš„æ•°æ®ç±»å‹å’ŒæŸ¥è¯¢å¤„ç†æ–¹æ³•ï¼Œå’Œä¼ ç»Ÿæ•°æ®åº“çš„ç±»ä¼¼å’Œç´¢å¼•æ–¹æ³•å¹¶æ— æœ¬è´¨åŒºåˆ«ã€‚ ","date":"2024-07-13","objectID":"/vector-search/:2:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"3. ä»€ä¹ˆæ˜¯å‘é‡æœç´¢ å‘é‡æœç´¢ä¹Ÿå«å‘é‡æ£€ç´¢ï¼Œæ˜¯ä¸€ç§ Information Retrieval çš„æŠ€æœ¯ï¼Œç”¨äºåœ¨é«˜ç»´å‘é‡ç©ºé—´ä¸­æŸ¥æ‰¾ä¸ç»™å®šæŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚ä¸ºäº†è¡¡é‡ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæ¬§æ°è·ç¦»ï¼Œæ›¼å“ˆé¡¿è·ç¦»ç­‰ã€‚ä¸ºäº†åŠ é€Ÿå‘é‡æœç´¢ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨ç´¢å¼•ç»“æ„ï¼Œæ¯”å¦‚ KD-Treeï¼ŒIVF(Inverted File Index)ï¼ŒHNSW(Hierarchical Navigable Small World)ç­‰ã€‚å‘é‡æœç´¢åœ¨å¾ˆå¤šé¢†åŸŸéƒ½æœ‰åº”ç”¨ï¼Œæ¯”å¦‚åœ¨æ¨èç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘é‡æœç´¢æ¥æŸ¥æ‰¾ä¸ç”¨æˆ·å†å²è¡Œä¸ºæœ€ç›¸ä¼¼çš„å•†å“ï¼Œç„¶åæ¨èç»™ç”¨æˆ·ï¼›åœ¨å›¾åƒæ£€ç´¢ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘é‡æœç´¢æ¥æŸ¥æ‰¾ä¸ç»™å®šå›¾ç‰‡æœ€ç›¸ä¼¼çš„å›¾ç‰‡ï¼›åœ¨ RAGï¼ˆRetrieval Augmented Generationï¼‰ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘é‡æœç´¢æ¥æŸ¥æ‰¾ä¸ç»™å®šé—®é¢˜æœ€ç›¸ä¼¼çš„æ–‡æœ¬ï¼Œå¢å¼ºå¤§æ¨¡å‹çš„ Context ä»è€Œæé«˜ç”Ÿæˆç­”æ¡ˆçš„è´¨é‡ã€‚ ","date":"2024-07-13","objectID":"/vector-search/:3:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"3.1 å‘é‡æœç´¢åº”ç”¨åœºæ™¯ 3.1.1 æ¨èç³»ç»Ÿ å¦‚ Qdrant å…³äº Video Content-based Recommendation çš„ On-premise æ¡ˆä¾‹ï¼Œé€šè¿‡ multilingual universal sentence encoder æ¥å¯¹ä¸Šä¼ è§†é¢‘æ—¶å€™çš„è„šæœ¬è¿›è¡ŒåµŒå…¥ã€‚è¿™é‡Œä¸æ˜¯ç®€å•çš„å¯¹è§†é¢‘è¿›è¡ŒæŠ½å¸§ï¼Œæ›´å¤šçš„ä¿¡æ¯æ¥è‡ªäºä¸Šä¼ æ—¶å€™çš„è§†é¢‘æ ‡é¢˜ï¼Œæè¿°ï¼Œè‡ªåŠ¨æ£€æµ‹æ ‡ç­¾ä»¥åŠé€šè¿‡ whisper è¯­éŸ³è¯†åˆ«çš„å†…å®¹ã€‚æ‰€ä»¥ç›®å‰é‡åˆ°çš„é—®é¢˜æ˜¯å¦‚æœè§†é¢‘æ˜¯æ— éŸ³é¢‘ï¼Œè¢«è¿«ä½¿ç”¨æ ‡é¢˜ä»¥åŠæè¿°è¿›è¡Œæ¨èï¼Œè¿™æ ·å¯¹äºå®¡æ ¸å›¢é˜Ÿæ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æŒ‘æˆ˜ã€‚è¿™é‡Œæåˆ°äº†æ¨èé¢†åŸŸçš„ call start issues, ä¹Ÿå°±æ˜¯ç”¨æˆ·åœ¨åˆšå¼€å§‹ä½¿ç”¨çš„æ—¶å€™ï¼Œæ¨èç³»ç»Ÿçš„æ¨èè´¨é‡ä¸é«˜ï¼Œè¿™ä¸ªæ—¶å€™ç”¨æˆ·ä½“éªŒä¼šå¾ˆå·®ã€‚åœ¨éå³æ—¶æ›´æ–°çš„åä½œæ¨èå™¨ä»¥åŠå…ƒæ•°æ®æ¨èå™¨çš„åŸºç¡€ä¸Šï¼Œå¢åŠ åŸºäºå†…å®¹çš„æ¨èå™¨ï¼Œå¯ä»¥å¤§å¤§ä¼˜åŒ– call start issuesã€‚ 3.1.2 å›¾åƒæ£€ç´¢ immich æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼€æº self-hosted å›¾åƒä»¥åŠè§†é¢‘ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚è¯•æƒ³å½“ä½ æŠŠä½ æ‰€æœ‰çš„è§†é¢‘å’Œå›¾ç‰‡éƒ½ä¸Šä¼ åˆ° immich ä¹‹åï¼Œä½ å¾ˆéš¾åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…æ‰¾åˆ°ä½ æƒ³è¦çš„å›¾ç‰‡æˆ–è€…è§†é¢‘ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€ä¸ªé«˜æ•ˆçš„å›¾åƒæ£€ç´¢ç³»ç»Ÿ smart searchï¼Œé€šè¿‡å‘é‡æœç´¢æŠ€æœ¯ï¼Œä½ å¯ä»¥é€šè¿‡æ–‡æœ¬æè¿°ä»¥åŠé¢å¤–çš„è¿‡æ»¤å™¨ï¼ˆæ ‡ç­¾ï¼Œæ—¥æœŸç­‰ï¼‰æ¥å¿«é€Ÿç²¾å‡†çš„æ‰¾åˆ°ä½ æƒ³è¦çš„å›¾ç‰‡æˆ–è€…è§†é¢‘ã€‚ å›¾ç‰‡æ¥è‡ªäº immich 3.1.3 RAG RAGï¼ˆRetrieval Augmented Generationï¼‰ä¸»è¦è§£å†³åœ¨ LLM åº”ç”¨ä¸­çš„å‡ ä¸ªé—®é¢˜ï¼š LLM è®­ç»ƒæ¨¡å‹çš„æ•°æ®ä¸æ˜¯å³æ—¶çš„ï¼Œæ¢å¥è¯è¯´æ˜¯é™æ€çš„æ•°æ®ï¼Œè·å–æœ€æ–°æ•°æ®é‡æ–°è¿›è¡Œè®­ç»ƒçš„æˆæœ¬å¤ªå¤§ã€‚ LLM ç¼ºä¹ç‰¹å®šé¢†åŸŸçš„çŸ¥è¯†ï¼Œå› ä¸º LLM çš„è®­ç»ƒè¯­æ–™å¤§éƒ½æ˜¯ç½‘ç»œä¸Šé€šç”¨çš„æ•°æ®é›†ã€‚è€Œåœ¨æ¯”å¦‚é‡‘èï¼ŒåŒ»ç–—ï¼Œæ³•å¾‹ç­‰é¢†åŸŸï¼Œç§åŸŸä¸­çš„æ•°æ®æˆ–è®¸æ˜¯æœ€é‡è¦çš„ï¼Œç¼ºä¹é¢†åŸŸå†…æ•°æ®ä¼šè®© LLM å‡ºç°å¹»è§‰é—®é¢˜ã€‚ LLM çš„é»‘åŒ£å­é—®é¢˜ï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“ LLM æ˜¯å¦‚ä½•ç”Ÿæˆç­”æ¡ˆçš„ï¼Œå…¶ç­”æ¡ˆçš„æ¥æºæ¥è‡ªä½•å¤„ã€‚ è¿™é‡Œå€Ÿç”¨ Paul lusztin å’Œ Aurimas Griciunas çš„ä¸¤å¼ å›¾æ¥è§£é‡Š RAG çš„å·¥ä½œåŸç†ï¼š è·å–é‡‘èæ–°é—»çš„æµå¼å³æ—¶æ•°æ®ï¼Œä»¥åŠå†å²æ•°æ® å°†æ•°æ®è¿›è¡Œ chunking è½¬æ¢æˆ embedding æ¨¡å‹çš„è¾“å…¥ï¼Œç„¶åå°† embedding å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ä¸­ ç”¨æˆ·æé—® é€šè¿‡å‘é‡æœç´¢æ‰¾åˆ°æœ€ç›¸ä¼¼çš„æ–°é—» chunksï¼Œç„¶åå°†ç”¨æˆ·å†å²çš„ chat ä¿¡æ¯å’Œæ–°é—» chunks è¿›è¡Œ Prompt composition è¾“å…¥åˆ° LLM ä¸­ç”Ÿæˆç­”æ¡ˆã€‚ å°†ç­”æ¡ˆè¿”å›ç»™ç”¨æˆ· å°†æ–°çš„ chat ä¿¡æ¯å­˜å‚¨åˆ°ç”¨æˆ·å†å²æ•°æ®ä¸­ ç§åŸŸä¸­çš„æ•°æ®ï¼Œä¾‹å¦‚ Notion, Jira,æœ¬åœ° pdf æ–‡ä»¶ç­‰ç­‰è¿›åœº chunking è½¬æ¢æˆ embedding æ¨¡å‹çš„è¾“å…¥ å°† chunk è¾“å…¥åˆ° embedding æ¨¡å‹ä¸­ï¼Œç„¶åå°† embedding å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ä¸­ Vector Database æ„å»º Index ç”¨æˆ·æé—®, è¾“å…¥åˆ° embedding æ¨¡å‹ embedding è¾“å‡º query çš„ embedding vector å°† 5 ä¸­çš„ vector ä½œä¸º Query vector è¾“å…¥åˆ°å‘é‡æ•°æ®åº“ä¸­ å‘é‡æ•°æ®åº“é€šè¿‡ ANNsï¼ˆApproximate Nearest Neighbors Searchï¼‰æ‰¾åˆ°æœ€ç›¸ä¼¼çš„ chunks å°†æœç´¢åˆ°çš„ chunks å’Œ query æ„å»º Prompt è¾“å…¥åˆ° LLM ä¸­ç”Ÿæˆç­”æ¡ˆ ","date":"2024-07-13","objectID":"/vector-search/:3:1","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"3.2 ç›¸ä¼¼åº¦æŒ‡æ ‡ 3.2.1 ä½™å¼¦ç›¸ä¼¼åº¦ ä½™å¼¦ç›¸ä¼¼åº¦æ˜¯ä¸€ç§ç”¨äºè¡¡é‡ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§çš„æ–¹æ³•ï¼Œå®ƒæ˜¯é€šè¿‡è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å¤¹è§’æ¥è¡¡é‡çš„ã€‚ä½™å¼¦ç›¸ä¼¼åº¦çš„å–å€¼èŒƒå›´æ˜¯[-1, 1]ï¼Œå…¶ä¸­1è¡¨ç¤ºä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å¤¹è§’ä¸º0åº¦ï¼Œè¡¨ç¤ºä¸¤ä¸ªå‘é‡å®Œå…¨ç›¸åŒï¼›-1è¡¨ç¤ºä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å¤¹è§’ä¸º180åº¦ï¼Œè¡¨ç¤ºä¸¤ä¸ªå‘é‡å®Œå…¨ç›¸åï¼›0è¡¨ç¤ºä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å¤¹è§’ä¸º90åº¦ï¼Œè¡¨ç¤ºä¸¤ä¸ªå‘é‡ä¹‹é—´æ²¡æœ‰ç›¸ä¼¼æ€§ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š è¿™ä¸ªå…¬å¼è®¡ç®—äº†å‘é‡ ğ´ å’Œ ğµ ä¹‹é—´çš„å¤¹è§’ä½™å¼¦å€¼ã€‚ 3.2.2 æ¬§æ°è·ç¦» æ¬§æ°è·ç¦»æ˜¯ä¸€ç§ç”¨äºè¡¡é‡ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§çš„æ–¹æ³•ï¼Œå®ƒæ˜¯é€šè¿‡è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è·ç¦»æ¥è¡¡é‡çš„ã€‚æ¬§æ°è·ç¦»çš„å–å€¼èŒƒå›´æ˜¯[0, âˆ]ï¼Œå…¶ä¸­0è¡¨ç¤ºä¸¤ä¸ªå‘é‡å®Œå…¨ç›¸åŒï¼Œ æ•°å€¼è¶Šå¤§åˆ™è¡¨ç¤ºä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å·®å¼‚è¶Šå¤§ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š è¿™ä¸ªå…¬å¼è®¡ç®—äº†å‘é‡ ğ´ å’Œ ğµ ä¹‹é—´çš„æ¬§æ°è·ç¦», æœ‰äº›ç›´æ¥ä¸å¼€æ ¹å·å…¶åªæ˜¯æ•°å€¼ä¸åŒï¼Œå¹¶æ— æœ¬è´¨åŒºåˆ«ã€‚ 3.2.3 è´Ÿå†…ç§¯ è´Ÿå†…ç§¯ï¼ˆNegative inner productï¼‰ï¼Œå®ƒæ˜¯é€šè¿‡è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å†…ç§¯æ¥è¡¡é‡çš„ã€‚æ•°å€¼è¶Šå¤§åˆ™è¡¨ç¤ºä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›¸ä¼¼æ€§è¶Šé«˜ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š 3.2.4 æ›¼å“ˆé¡¿è·ç¦» æ›¼å“ˆé¡¿è·ç¦»ï¼ˆtaxicab distanceï¼‰ï¼Œå®ƒæ˜¯é€šè¿‡è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è·ç¦»æ¥è¡¡é‡çš„ã€‚æ›¼å“ˆé¡¿è·ç¦»çš„å–å€¼èŒƒå›´æ˜¯[0, âˆ]ï¼Œå…¶ä¸­0è¡¨ç¤ºä¸¤ä¸ªå‘é‡å®Œå…¨ç›¸åŒï¼Œ æ•°å€¼è¶Šå¤§åˆ™è¡¨ç¤ºä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å·®å¼‚è¶Šå¤§ã€‚è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š ","date":"2024-07-13","objectID":"/vector-search/:3:2","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"3.3 å‘é‡æœç´¢ç®—æ³• ç›´è§‰ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡éå†æ‰€æœ‰çš„å‘é‡æ¥æ‰¾åˆ°ä¸ç»™å®šæŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ã€‚å½“å‘é‡çš„æ•°é‡å¾ˆå¤§æ—¶ï¼Œè¿™ç§æ–¹æ³•æ˜¯ä¸å¯è¡Œçš„ï¼Œå¯¹äºä½ çš„åº”ç”¨å»¶è¿Ÿä¸å¯æ¥å—ã€‚ä¸ºäº†åŠ é€Ÿå‘é‡æœç´¢ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨ç´¢å¼•ç»“æ„ï¼Œæ¯”å¦‚ IVF(Inverted File Index)ï¼ŒHNSW(Hierarchical Navigable Small World)ç­‰ã€‚é€šè¿‡ ANNs (Approximate Nearest Neighbors Search) ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ›´ä½çš„æ—¶é—´å¤æ‚åº¦ï¼Œæ¯”å¦‚ O(log(n))ï¼Œæ‰¾åˆ°ä¸ç»™å®šæŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚ 3.3.1 LSH (Locality Sensitive Hashing) å±€éƒ¨æ•æ„Ÿå“ˆå¸Œ (LSH) çš„å·¥ä½œåŸç†æ˜¯é€šè¿‡å“ˆå¸Œå‡½æ•°å¤„ç†æ¯ä¸ªå‘é‡ï¼Œå°†å‘é‡åˆ†ç»„åˆ°å­˜å‚¨æ¡¶ä¸­ï¼Œä»è€Œæœ€å¤§åŒ–å“ˆå¸Œå†²çªï¼Œè€Œä¸æ˜¯åƒé€šå¸¸çš„å“ˆå¸Œå‡½æ•°é‚£æ ·æœ€å°åŒ–å†²çªã€‚ è¿™é‡Œå¼•ç”¨ Pinecone çš„ä¸€å¼ å›¾ï¼š LSH çš„å…·ä½“ç»†èŠ‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Shinglingï¼šä½¿ç”¨ k-shingling ä»¥åŠ one-hot encoding å°†æ–‡æœ¬è½¬æ¢æˆç¨€ç–å‘é‡ k-shingling çš„æ„æ€æ˜¯ä»¥çª—å£å¤§å°ä¸º k çš„æ»‘åŠ¨çª—å£ï¼Œåœ¨æ–‡æœ¬ä¸­æå– k ä¸ªè¿ç»­çš„å­—ç¬¦ one-shot encoding çš„æ„æ€æ˜¯ï¼Œå°† k-shingling çš„ç»“æœå’Œè¯æ±‡è¡¨è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå­˜åœ¨åˆ™åœ¨è¯æ±‡è¡¨è¡¨ç¤ºä¸º1ï¼Œä¸å­˜åœ¨åˆ™ä¸º0 åä½¿ç”¨ MinHash åˆ›å»ºâ€œç­¾åâ€ åˆ›å»º [1â€¦len(voc)+1] çš„éšæœºæ’åˆ— éšæœºæ’åˆ—ä¸­ä»ä¸Šåˆ°ä¸‹çš„å€¼ä½œä¸º index ï¼Œå¦‚æœåŸå§‹ç¨€ç– vector çš„ index-1 ä½ç½®ä¸º1åˆ™å–éšæœºæ’åˆ—çš„ index-1 ä½ç½®æ•°ä¸ºç­¾åå€¼ é‡å¤ n æ¬¡å¾—åˆ° n ç»´åº¦ç¨ å¯†å‘é‡ Band and Hash å°† n ç»´åº¦çš„ç­¾åå‘é‡åˆ†æˆ b ç»„ï¼Œæ¯ç»„ r ä¸ª å¯¹æ¯ç»„è¿›è¡Œ hashï¼Œå¾—åˆ° b ä¸ª hash å€¼ å¦‚æœä¸¤ä¸ªå‘é‡çš„ hash å€¼ç›¸åŒï¼Œåˆ™å°†è¿™ä¸¤ä¸ªå‘é‡æ”¾åˆ°åŒä¸€ä¸ªæ¡¶ä¸­ å¦‚æœåœ¨åŒä¸€ä¸ªæ¡¶ä¸­ï¼Œåˆ™è®¤ä¸ºå…¶ä¸ºå€™é€‰å¯¹ è¿™é‡Œéšç€ b çš„å¢å¤§è¿”å›æ›´å¤šçš„å€™é€‰å¯¹ï¼Œè¿™è‡ªç„¶ä¼šå¯¼è‡´æ›´å¤šçš„è¯¯æŠ¥ è¿™æ„å‘³ç€éšç€çº¬åº¦çš„å¢åŠ ï¼Œè¯¯æŠ¥çš„å¯èƒ½æ€§è¶Šå¤§ï¼Œè€Œä¸”ç»´æ•°å¢å¤§åéœ€è¦ç»´æŠ¤æ›´å¤šçš„ hash æ¡¶ï¼Œå­˜å‚¨çš„å¼€é”€ä¹Ÿä¼šå¢å¤§ã€‚æ‰€ä»¥ LSH æ›´é€‚åˆä½ç»´åº¦çš„å‘é‡æœç´¢ï¼Œä¸æ˜¯ç›®å‰çš„ä¸»æµå‘é‡æœç´¢ç®—æ³•ã€‚ 3.3.2 IVFï¼ˆInverted File Indexï¼‰ å€’æ’ç´¢å¼•ç®—æ³•æ˜¯ä¸€ä¸ªç®€å•ã€æ˜“æ‡‚è€Œä¸”éå¸¸å®¹æ˜“å®ç°çš„ç®—æ³•ï¼Œè€Œä¸”æœ‰ç€ä¸é”™çš„æœç´¢é€Ÿåº¦ï¼Œä½†æ˜¯æœç´¢çš„ç²¾åº¦è¾ƒ HNSW è¾ƒå·®äº›ï¼Œä½†æ˜¯å†…å­˜æ¶ˆè€—ç›¸å¯¹ HNSW æ›´å°‘ã€‚ æ„å»º IVF ç´¢å¼•çš„æ ¸å¿ƒåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š é€šè¿‡èšç±»ç®—æ³•å°†å‘é‡åˆ†æˆ nlist ä¸ªç°‡ å°†å‘é‡åˆ†é…åˆ°å¯¹åº”çš„ç°‡ä¸­ æœç´¢æ—¶å€™ï¼Œè®¾å®šéœ€è¦æœç´¢çš„èšç±»ä¸ªæ•° nprobe è¿™é‡Œå‚æ•°çš„å½±å“æ˜¯ï¼š å¢å¤§ nlist ä¼šé™ä½æ„å»ºç´¢å¼•çš„é€Ÿåº¦ï¼Œå› ä¸ºåœ¨èšç±»è¿‡ç¨‹ä¸­å‘é‡éœ€è¦è·Ÿæ›´å¤šçš„ä¸­å¿ƒç‚¹è¿›è¡Œè®¡ç®—ï¼›åŒæ—¶ä¼šé™ä½æœç´¢æ—¶é—´ï¼Œå› ä¸ºå¯¹åº”ä¸­å¿ƒç‚¹çš„å‘é‡æ›´å°‘äº†ï¼Œåš knn çš„æ—¶å€™æ›´å¿«ã€‚ å¢å¤§ nprobe ä¼šæé«˜å¬å›ç‡ä½†æ˜¯ä¼šé™ä½æœç´¢é€Ÿåº¦ï¼Œå› ä¸ºéœ€è¦æœç´¢æ›´å¤šçš„å•å…ƒæ ¼ã€‚ 3.3.3 HNSW (Hierarchical Navigable Small World) HNSW ç»“åˆäº† NSW ä»¥åŠ Skip List çš„ä¼˜ç‚¹ï¼Œæ˜¯ä¸€ç§é«˜æ•ˆçš„å‘é‡æœç´¢ç®—æ³•ã€‚HNSW çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æ„å»ºä¸€ä¸ªå¤šå±‚çš„å›¾ï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªå°ä¸–ç•Œï¼Œé€šè¿‡åœ¨æ¯ä¸€å±‚ä¸­æœç´¢æœ€è¿‘çš„èŠ‚ç‚¹ï¼Œç„¶ååœ¨ä¸‹ä¸€å±‚ä¸­æœç´¢æœ€è¿‘çš„èŠ‚ç‚¹ï¼Œæœ€ç»ˆæ‰¾åˆ°ä¸ç»™å®šæŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚ NSW æ˜¯å»ºç«‹åœ¨ä¸€ä¸ªç†è®ºçš„åŸºç¡€ä¸Šï¼ŒNSW ä¸Šçš„ç‚¹åˆ°ä»»æ„ç‚¹çš„è·ç¦»éƒ½æ˜¯æœ‰é™çš„ï¼Œè€Œä¸”æ˜¯é€šè¿‡å¾ˆå°‘çš„å‡ æ¬¡è·³è·ƒå°±èƒ½æ‰¾åˆ°çš„ã€‚ NSW çš„æ„é€ è¿‡ç¨‹ï¼š éšæœºé€‰æ‹©ä¸€ä¸ªç‚¹ä½œä¸ºæ’å…¥ç‚¹ æŸ¥æ‰¾ä¸æ’å…¥ç‚¹æœ€è¿‘çš„ m ä¸ªç‚¹ å°†æ’å…¥ç‚¹ä¸ m ä¸ªç‚¹ç›¸è¿ è¿™é‡Œçš„éšæœºæ€§ä¼šè®©å‰æœŸçš„å›¾ä¸­é•¿è¿æ¥çº¿å¢å¤šï¼ŒåŠ é€Ÿæœç´¢ï¼Œå¯ä»¥ç†è§£æˆâ€œé«˜é€Ÿå…¬è·¯â€ï¼Œä¸‹å›¾ä¸­çš„çº¢è‰²çº¿å°±æ˜¯é•¿è¿æ¥çº¿ï¼š NSW çš„æœç´¢è¿‡ç¨‹å¦‚ä¸‹ï¼Œè¿™é‡Œå€Ÿç”¨çŸ¥ä¹ç½‘å‹â€œå·¥ç‰Œå‚ç¨‹åºçŒ¿â€çš„ä¸€å¼ å›¾ï¼š åˆå§‹åŒ–ä¸‰ä¸ªé›†åˆï¼Œåˆ†åˆ«æ˜¯ visitedï¼Œcandidateï¼Œresultï¼ˆå®šé•¿ï¼‰ï¼›éšæœºé€‰æ‹©åˆå§‹ç‚¹è¿›å…¥ï¼Œå¹¶åŠ å…¥ visited ä»¥åŠ candidate é›†åˆ, candidate ä¿å­˜å’Œ query ç‚¹çš„è·ç¦» å¯»æ‰¾åˆå§‹ç‚¹çš„ n æœ€è¿‘é‚»ç‚¹ï¼ŒåŠ å…¥åˆ° visited é›†åˆï¼Œæ³¨æ„å¦‚æœå‹ç‚¹åœ¨ visited é›†åˆä¸­åˆ™åºŸå¼ƒï¼Œï¼Œå¯¹ n ä¸ªè¿‘é‚»ç‚¹å¹¶è¡Œè®¡ç®—å’Œ query çš„è·ç¦»ï¼Œè¿›è¡Œå‡åºæ’åºï¼ˆç”±è¿‘åˆ°è¿œï¼‰åŠ å…¥ candidate é›†åˆ å¯»æ‰¾ candidate é›†åˆä¸­çš„ n ä¸ªè¿‘é‚»ç‚¹ï¼ŒåŠ å…¥ visited é›†åˆï¼Œå¦‚æœå·²ç»å­˜åœ¨ visited é›†åˆä¸­åºŸå¼ƒï¼›è¿™é‡ŒæŸ¥è¯¢çš„æ˜¯ C ç‚¹ï¼Œåªæœ‰ D ç‚¹æ²¡è®¿é—®è¿‡ï¼Œå› ä¸º D ç‚¹è·ç¦» query ç‚¹è·ç¦»å°äº C åˆ° query ç‚¹è·ç¦»ï¼Œæ‰€ä»¥ result ä¸­å°† C æ¢æˆ D ç‚¹ï¼Œcandidate ä¸­å°† C æ¢æˆ D ç‚¹ é‡å¤ 3 æ­¥éª¤ï¼Œå¯»æ‰¾ D çš„ n å“¥æœ€è¿‘é‚»ï¼ŒåŠ å…¥ visited é›†åˆï¼Œå¦‚æœå·²ç»å­˜åœ¨ visited é›†åˆä¸­åºŸå¼ƒï¼›è¿™é‡ŒæŸ¥è¯¢çš„æ˜¯ E ç‚¹å’Œ G ç‚¹ï¼Œå› ä¸º E ç‚¹è·ç¦» query ç‚¹è·ç¦»å°äº result é›†åˆä¸­çš„æœ€å¤§è·ç¦»ï¼Œæ‰€ä»¥ result ä¸­å°† H æ¢æˆ E ç‚¹ï¼Œcandidate ä¸­å°† E ç‚¹å‰”é™¤ é‡å¤ 3 candidate é›†åˆä¸­è·ç¦» query æœ€å°è·ç¦»çš„ç‚¹ H çš„è·ç¦»æ¯” result é›†åˆä¸­è·ç¦» query æœ€å¤§çš„ç‚¹ E çš„è·ç¦»è¿˜å¤§ï¼Œåˆ™åœæ­¢æŸ¥è¯¢ Skip List æ˜¯ä¸€ç§é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥åœ¨ O(log(n)) çš„æ—¶é—´å¤æ‚åº¦å†…æ‰¾åˆ°ä¸ç»™å®šæŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚Skip List çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æ„å»ºä¸€ä¸ªå¤šå±‚çš„é“¾è¡¨ï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ï¼Œé€šè¿‡åœ¨æ¯ä¸€å±‚ä¸­æœç´¢æœ€è¿‘çš„èŠ‚ç‚¹ï¼Œç„¶ååœ¨ä¸‹ä¸€å±‚ä¸­æœç´¢æœ€è¿‘çš„èŠ‚ç‚¹ï¼Œæœ€ç»ˆæ‰¾åˆ°ä¸ç»™å®šæŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„å‘é‡ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„ HNSW çš„å‡ ä¸ªç‚¹ï¼š éœ€è¦æ§åˆ¶ HNSW æ¯ä¸€å±‚çš„ç‚¹æœ€å¤§è¿æ¥æ•° Max, åœ¨éšæœºï¼ˆè¶Šåº•å±‚æ¦‚ç‡è¶Šå¤§ï¼‰æ’å…¥èŠ‚ç‚¹æ—¶ï¼Œå¦‚æœæœ‰é‚»å±…èŠ‚ç‚¹ N çš„è¿æ¥æ•°å¤§äº Maxï¼Œåˆ™å¯¹ N è¿›è¡Œ KNN æœç´¢é‡æ–°ä¸æ–°çš„é‚»å±…å»ºç«‹è¿æ¥ã€‚ å¯å‘å¼é€‰è¾¹ç­–ç•¥ï¼šåœ¨æ¯ä¸€å±‚æœç´¢ä¸æ’å…¥ç‚¹æœ€é‚»è¿‘çš„ M ä¸ªèŠ‚ç‚¹çš„æ—¶å€™ï¼Œå®ƒæ˜¯å…ˆå¬å›äº† efConstruction ä¸ªï¼Œç„¶åå†é€‰æ‹©å‡º M ä¸ª(efConstruction \u003e= M)ï¼Œé€‰æ‹© M çš„è¿‡ç¨‹å¯ä»¥ç›´æ¥é€‰æ‹© Top-M ä½†æ˜¯å¯èƒ½ä¼šé™ä½æ•´ä½“çš„è¿é€šæ€§ï¼Œâ€œå·¥ç‰Œå‚ç¨‹åºçŒ¿â€ çš„æ–‡ç« å…·ä½“åˆ—ä¸¾äº†è¿™ä¸ª case: è¿™é‡Œçš„ efConstruction æ˜¯ 4ï¼ŒM æ˜¯ 2ï¼Œå¦‚æœç›´æ¥é€‰æ‹© Top-M çš„è¯ï¼Œä¸€å®šä¼šé€‰æ‹© A å’Œ B, è¿™æ · ABQ å’Œ CD çš„è¿é€šæ€§å°±é™ä½äº†ï¼Œè¿™é‡Œåœ¨é€‰æ‹© A åå¯»æ‰¾ç¬¬äºŒä¸ªæœ€è¿‘é‚»çš„æ—¶å€™æ£€æµ‹ QA å’Œ AB è·ç¦»ï¼Œå¦‚æœ QA \u003e AB åˆ™å†å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ€è¿‘é‚»ï¼ŒçŸ¥é“å¤§äº QA ä¸ºæ­¢,è¿™é‡Œæ‰¾åˆ° C ç‚¹æ—¶ AC \u003e AQã€‚ High degree vertex è¶Šé è¿‘æœ€ä¸Šå±‚ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æœç´¢è·¯å¾„ï¼Œæé«˜æœç´¢æ•ˆç‡ æ„å»ºå‚æ•°ï¼š efConstruction: å›¾æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå‚æ•°ï¼Œç”¨æ¥æ§åˆ¶åœ¨ä¸ºæ¯ä¸ªèŠ‚ç‚¹å»ºç«‹è¿æ¥æ—¶ï¼Œè€ƒè™‘çš„æœ€è¿‘é‚»å€™é€‰èŠ‚ç‚¹çš„æ•°é‡ã€‚è¯¥å‚æ•°å…·ä½“å½±å“çš„æ˜¯å›¾åœ¨æ„å»ºè¿‡ç¨‹ä¸­èŠ‚ç‚¹ä¹‹é—´è¿æ¥çš„è´¨é‡ã€‚è¾ƒé«˜çš„ efConstruction å€¼æ„å‘³ç€åœ¨ä¸ºä¸€ä¸ªèŠ‚ç‚¹é€‰æ‹©é‚»å±…æ—¶ä¼šè€ƒè™‘æ›´å¤šçš„å€™é€‰èŠ‚ç‚¹ï¼Œä»è€Œç”Ÿæˆæ›´ä¼˜è´¨çš„å›¾ç»“æ„ã€‚ä½†æ˜¯ï¼Œè¾ƒé«˜çš„ efConstruction å€¼ä¼šå¢åŠ æ„å»ºå›¾çš„æ—¶é—´å’Œç©ºé—´å¤æ‚åº¦ï¼Œè€Œä¸”åœ¨æœç´¢æ—¶ä¹Ÿä¼šå¢åŠ æœç´¢æ—¶é—´ã€‚ m: æ¯ä¸ªé¡¶ç‚¹æ·»åŠ çš„æœ€å¤§é‚»å±…æ•°ï¼Œåˆ†ä¸º m_0=2m ä»¥åŠ m_max=m, å‚çœ‹ä»£ç . æœç´¢å‚æ•°ï¼š efSearch: åœ¨æœç´¢æ—¶ï¼Œç”¨æ¥æ§åˆ¶æœç´¢çš„è´¨é‡ã€‚è¾ƒé«˜çš„ efSearch å€¼æ„å‘³ç€æœç´¢æ—¶ä¼šè€ƒè™‘æ›´å¤šçš„å€™é€‰èŠ‚ç‚¹ï¼Œä»è€Œæé«˜æœç´¢çš„è´¨é‡ã€‚ä½†æ˜¯ï¼Œè¾ƒé«˜çš„ efSearch å€¼ä¼šå¢åŠ æœç´¢æ—¶é—´ã€‚ HNSW ç”±äºæ£€ç´¢è¿‡ç¨‹ä¸­æ¶‰åŠå¹³å‡å•æ¡æŸ¥è¯¢ä¼šäº§ç”Ÿæ•°ç™¾ä¸ªè¯»ç£ç›˜æ“ä½œï¼Œéœ€è¦ä¸åœçš„å¯»æ‰¾ä¸‹ä¸€ä¸ªéšæœºç‚¹ï¼Œæ”¾åˆ° SSD ä¼šå¯¼è‡´æé«˜çš„æ—¶å»¶ï¼Œæ‰€ä»¥æ˜¯å…¨å†…å­˜çš„ã€‚ NSG (Navigating Spreading-out Graph) NSG å›´ç»•å›¾çš„è¿é€šæ€§ã€å‡å°‘å¹³å‡å‡ºåº¦ï¼Œç¼©çŸ­æœç´¢è·¯å¾„ä»¥åŠå›¾çš„å¤§å°ç­‰æ–¹é¢è¿›è¡Œäº†ä¼˜åŒ–ï¼Œ æå‡ºæ–°çš„å›¾ç»“æ„ Monotonic Relative Neighborhood Graph (MRNG)ã€‚ å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š æ„å»º K-nearest-neighbor-graph (KNNG) ä½œä¸ºæ„å›¾åŸºå‡† éšæœºé€‰æ‹©ä¸€ä¸ªç‚¹ä½œä¸º Navigation Pointï¼Œåç»­æ‰€æœ‰æ–°æ’å…¥çš„èŠ‚ç‚¹åœ¨é€‰è¾¹æ—¶éƒ½ä¼šå°†Navigation PointåŠ å…¥å€™é€‰é›†åˆ åœ¨å»ºå›¾è¿‡ç¨‹ä¸­ï¼Œé€æ¸ä¼šå°†å­å›¾éƒ½å’Œ Navigation point ç›¸è¿æ¥ï¼Œè¿™æ ·å…¶ä»–çš„èŠ‚ç‚¹åªéœ€ä¿æŒå¾ˆå°‘çš„è¾¹å³å¯ï¼Œä»è€Œå‡å°‘äº†å›¾çš„å¤§å° æ¯æ¬¡æœç´¢ä» Navigation Point å‡ºå‘èƒ½å¤ŸæŒ‡å‘å…·ä½“çš„å­å›¾ï¼Œä»è€Œå‡å°‘æ— æ•ˆæœç´¢ï¼Œè·å¾—æ›´å¥½æœç´¢æ€§èƒ½ã€‚ NSG é€‰è¾¹è·Ÿ HNSW é€‰æ‹©æœ€å°è¾¹ç­–ç•¥ä¸åŒã€‚ä»¥ç‚¹ r ä¸ºä¾‹ï¼Œå½“ r ä¸ p å»ºç«‹è¿æ¥æ—¶ï¼Œä»¥ r å’Œ p ä¸ºåœ†å¿ƒï¼Œr å’Œ p çš„è·ç¦»ä¸ºåŠå¾„ï¼Œåˆ†åˆ«åšåœ†ï¼Œå¦‚æœä¸¤ä¸ªåœ†çš„äº¤é›†å†…æ²¡æœ‰å…¶ä»–ä¸ p ç›¸è¿æ¥çš„ç‚¹ï¼Œåˆ™ r ä¸ p ç›¸è¿ã€‚åœ¨è¿æ¥ç‚¹ s æ—¶ï¼Œç”±äºä»¥ s å’Œ p è·ç¦»ä¸ºåŠå¾„çš„äº¤é›†åœ†å†…ï¼Œå·²æœ‰ç‚¹ r ä¸ p ç›¸è¿ï¼Œæ‰€ä»¥ s å’Œ p ä¸ç›¸è¿ã€‚tç‚¹å› ä¸ºsç‚¹å·²ç»æ’é™¤ï¼Œæ‰€ä»¥ä¿ç•™,ä¸‹å›¾ä¸­æœ€ç»ˆä¸ç‚¹ p ç›¸è¿çš„ç‚¹åªæœ‰r, t å’Œ qï¼Œè¿™æ ·å‡å°‘äº†å†—ä½™è¾¹ï¼Œå‡å°‘äº†å¹³å‡å‡ºåº¦ã€‚ 3.3.4 DiskANN DiskANN ç³»åˆ—æœ‰ä¸‰ç¯‡æ–‡ç« ï¼ŒDiskANNï¼ŒFreshDiskANNï¼ŒFilterDiskANNï¼Œ ä»æœ¬è´¨ä¸Šæ˜¯å¯¹ HNSWæˆ–è€…è¯´ NSG ç®—æ³•çš„ä¼˜åŒ–ã€‚ DiskANN é€šè¿‡å¼•å…¥ SSD å‹å¥½å‹çš„å›¾ç®—æ³• Vamana,æœ€å°åŒ–","date":"2024-07-13","objectID":"/vector-search/:3:3","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"3.4 å‘é‡æœç´¢ç®—æ³•ä¼˜åŒ– é€šè¿‡å‡å°‘ Vector å¤§å°ï¼Œæˆ–è€…é€šè¿‡é™ç»´è®©æœç´¢æ›´å¿«ï¼Œè¿™é‡Œåˆ—ä¸¾äº†ä¸€äº›å¸¸è§çš„å‘é‡æœç´¢ç®—æ³•ä¼˜åŒ–æ–¹æ³•ã€‚ 3.4.1 PQï¼ˆProduct Quantizationï¼‰ è¿™é‡Œå€Ÿç”¨çŸ¥ä¹ç½‘å‹çš„ä¸€å¼ å›¾ï¼Œæ²¡åŠæ³•ï¼Œç½‘å‹çš„å›¾ç”»çš„å¤ªå¥½äº†ï¼š æ„å»ºé˜¶æ®µï¼š é¦–å…ˆå°†Nä¸ªåŸå§‹å‘é‡ï¼Œå„è‡ªåˆ‡åˆ†ä¸ºå¤šä¸ªå­å‘é‡ã€‚æ¯”å¦‚256ç»´å‘é‡ï¼Œåˆ‡åˆ†ä¸º8ä¸ª32ç»´å­å‘é‡ ç„¶ååœ¨æ¯ä¸ªå­å‘é‡ç©ºé—´å†…è¿›è¡Œèšç±»ï¼Œå¯ä»¥é‡‡ç”¨KMeansç­‰èšç±»ç®—æ³•ã€‚å‡è®¾æ¯ä¸ªå­ç©ºé—´æœ‰1024ä¸ªèšç±»ï¼Œå¯¹æ¯ä¸ªèšç±»ä¸­å¿ƒç¼–ç ï¼Œå¾—åˆ°1024ä¸ªID å°†åŸå§‹å‘é‡ç¼–ç æˆæœ€è¿‘çš„èšç±»ä¸­å¿ƒIDï¼Œæœ€ååšæ‹¼æ¥ æ£€ç´¢é˜¶æ®µï¼š æ£€ç´¢å‘é‡è¿›è¡Œåˆ‡åˆ† åˆ‡åˆ†çš„å­ç©ºé—´å’Œè®¡ç®—æ¯ä¸ªèšç±»ä¸­å¿ƒçš„è·ç¦»ï¼Œåšæˆè·ç¦»è¡¨ åˆ©ç”¨è·ç¦»è¡¨è®¡ç®—queryå’Œå€™é€‰æ ·æœ¬åœ¨æ¯ä¸ªå­ç©ºé—´çš„è·ç¦»ï¼Œç´¯åŠ åå– top-k å…¶ä¸­æ¶‰åŠåˆ°åˆ‡åˆ†éƒ½å¯ä»¥ä½¿ç”¨å¹¶è¡Œæ±‚è§£ï¼Œè¿™é‡Œä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨ PQ å› ä¸ºä¾æ—§éœ€è¦å¾ˆå¤šçš„è·ç¦»è®¡ç®—ï¼Œè¿™é‡Œä¸€èˆ¬å…ˆè¿›è¡Œ IVF æ‰¾åˆ°æœ€æœ‰å¸Œæœ›çš„top-k cluster ç„¶åå†è¿›è¡Œ PQã€‚ 3.4.2 SQï¼ˆScalar Quantizationï¼‰ SQ æ¯”è¾ƒç®€å• ç¼–ç ï¼š scalar = (max-min)/255, floor(value-min/scaler) å¦‚æœå°äº0 åˆ™å– 0ï¼Œå¤§äº 255 åˆ™å– 255ï¼Œè¿™æ ·å°±å°†å‘é‡å‹ç¼©åˆ° 0-255 ä¹‹é—´ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å‘é‡çš„å¤§å°ï¼Œä½†æ˜¯ä¼šæŸå¤±ä¸€äº›ä¿¡æ¯ã€‚ è§£ç ï¼švalue = min + (code + 0.5)*(max-min)/255 3.4.3 RabitQ RabitQ æ¥æºäºè®ºæ–‡ RaBitQ: Quantizing High-Dimensional Vectors with a Theoretical Error Bound for Approximate Nearest Neighbor Search, å…·ä½“ç†è®ºç»†èŠ‚å¯ä»¥å‚è€ƒ RabitQ çš„ä½œè€… Jianyang Gao çš„ blogã€‚ RabitQ æŒ‡å‡ºç°é˜¶æ®µ PQ ç®—æ³•çš„ä¸¤ä¸ªé—®é¢˜ï¼š ç”¨ kmeans çš„è´¨å¿ƒä½œä¸º codebookï¼Œ æ„å»ºæ—¶å¯å‘å¼çš„è¿‘ä¼¼ä¼°è®¡ï¼Œæ²¡æœ‰ç†è®ºä¿è¯ è·ç¦»ä¼°è®¡ï¼Œç”¨é‡åŒ–åçš„å‘é‡å’Œ queryå‘é‡çš„è·ç¦»ä¼°è®¡åŸå§‹å‘é‡å’Œ query å‘é‡çš„è·ç¦»ï¼Œç¼ºä¹è¿‘ä¼¼è¯¯å·®èŒƒå›´ ä¸Šè¿°çš„ä¸¤ä¸ªé—®é¢˜å°±å¯¼è‡´ PQ å¯èƒ½åœ¨ä¸€äº›æ•°æ®é›†æˆ–è€…çœŸå®åœºæ™¯ä¸‹çš„è¯¯å·®éå¸¸å¤§ã€‚ å¦‚ä½•è§£å†³ä¸Šè¿°é—®é¢˜ï¼š codebook æ„å»ºé˜¶æ®µ é¦–å…ˆå¯¹æ•°æ®å‘é‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä»¥ä¾¿å°†å®ƒä»¬å¯¹é½åœ¨å•ä½è¶…çƒé¢ä¸ŠDç»´ç©ºé—´ æ„å»ºä¸€ç»„ $2^{D}$ åæ ‡ä¸ºçš„åŒå€¼å‘é‡ $âˆ’1/\\sqrt{D}$æˆ–è€… $+1/\\sqrt{D}$ï¼ˆå³ï¼Œè¯¥é›†åˆç”±è¶…ç«‹æ–¹ä½“çš„é¡¶ç‚¹ç»„æˆï¼Œè¿™äº›é¡¶ç‚¹å‡åŒ€åœ°åˆ†å¸ƒåœ¨å•ä½è¶…çƒé¢ä¸Šï¼‰ é€šè¿‡å°†æ¯ä¸ªåŒå€¼å‘é‡ä¹˜ä»¥éšæœºæ­£äº¤çŸ©é˜µæ¥éšæœºæ—‹è½¬åŒå€¼å‘é‡ï¼ˆå³æ‰§è¡Œä¸€ç§ Johnson-Lindenstrauss å˜æ¢)ï¼Œä¸ºäº†æ¶ˆé™¤ç¡®å®šæ€§ç æœ¬å¯¹ç‰¹å®šå‘é‡çš„åå¥½ å¯¹äºæ¯ä¸ªå‘é‡ï¼Œå°†å…¶ä¸ç æœ¬æœ€æ¥è¿‘çš„å‘é‡ä½œä¸ºé‡åŒ–å‘é‡ï¼Œ æœ€å°åŒ–å†…ç§¯ã€‚ ç”±äºæ¯ä¸ªé‡åŒ–å‘é‡éƒ½æ˜¯æ—‹è½¬çš„ D ç»´åŒå€¼å‘é‡ï¼Œæˆ‘ä»¬å°†å…¶é‡åŒ–ç è¡¨ç¤ºä¸ºé•¿åº¦çš„ä½ä¸²Dï¼Œå…¶ä¸­ 0 å’Œ 1 è¡¨ç¤ºä¸¤ä¸ªä¸åŒçš„å€¼ã€‚ ç æœ¬æ„é€ çš„åŸºæœ¬åŸç†æ˜¯å®ƒå…·æœ‰æ¸…æ™°çš„å‡ ä½•è§£é‡Šï¼ˆå³ç æœ¬ä¸­çš„å‘é‡æ˜¯å•ä½è¶…çƒé¢ä¸Šçš„ä¸€ç»„éšæœºæ—‹è½¬å‘é‡ï¼‰ ä½¿å¾—å¯ä»¥æ˜ç¡®åœ°åˆ†ææ•°æ®å‘é‡ã€å®ƒä»¬çš„é‡åŒ–å‘é‡å’ŒæŸ¥è¯¢å‘é‡ä¹‹é—´çš„å‡ ä½•å…³ç³»ã€‚ è·ç¦»ä¼°è®¡ æ ¹æ®ä¸Šè¿°å‡ ä½•å…³ç³»ä»”ç»†è®¾è®¡äº†æ•°æ®å‘é‡å’ŒæŸ¥è¯¢å‘é‡ä¹‹é—´è·ç¦»çš„ä¼°è®¡å™¨ï¼Œå¹¶è¯æ˜è¿™ä¸ªä¼°è®¡å™¨æ˜¯æ— åçš„ï¼Œè€Œä¸”æä¾›äº†è¯¯å·®èŒƒå›´ã€‚ äºæ­¤åŒæ—¶åœ¨ä¼°è®¡è·ç¦»æ—¶ï¼Œå³ä½¿ä½¿ç”¨è¾ƒçŸ­çš„é‡åŒ–ä»£ç ï¼Œä¹Ÿèƒ½ä»¥è¾ƒå°çš„ç»éªŒè¯¯å·®ä¼°è®¡å‡ºå¤§çº¦ä¸€åŠçš„ä¼˜åŠ¿ RaBitQâ€™s distance estimatorï¼š å•ä¸ª data vector ä½¿ç”¨ bitwise æŒ‰ä½æ“ä½œ æ‰¹é‡æ•°æ®ä½¿ç”¨ SIMD åŠ é€Ÿ ä½¿ç”¨éšæœº codebook é¿å…åŒå€¼ codebook åœ¨ä¸€äº›ç‰¹å®šå‘é‡è¡¨ç°ä¸ä½³ï¼Œæ¯”å¦‚ ($1/\\sqrt{D}$â€¦ $âˆ’1/\\sqrt{D}$) å’Œ (1, 0, 0, 0) çš„é‡åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨éšæœºæ­£äº¤çŸ©é˜µå»ä¹˜è¿™ä¸ª codebook, è®© codebook å•ä½å‘é‡æœ‰ç›¸åŒçš„æ¦‚ç‡æ—‹è½¬åˆ°å•ä½è¶…çƒé¢ä¸Šçš„ä»»æ„ä½ç½® è¿™é‡Œä½¿ç”¨é€šä¿—çš„è¯è®²è§£ä¸‹ RabitQ çš„æ ¸å¿ƒæ€æƒ³ï¼š ç»ˆæè§£è¯´ï¼šé«˜ç»´ç©ºé—´ä¸­çš„é—ªç”µæœå›¾æœ¯ (RaBiT-Q ç®—æ³•) æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºä¸–ç•Œä¸Šæœ€å¤§çš„å›¾ç‰‡åˆ†äº«ç½‘ç«™ï¼ˆæ¯”å¦‚Instagramæˆ–Pinterestï¼‰æ„å»ºä¸€ä¸ªâ€œä»¥å›¾æœå›¾â€çš„åŠŸèƒ½ã€‚è¿™æ„å‘³ç€ï¼Œå½“ç”¨æˆ·ä¸Šä¼ ä¸€å¼ â€œæ²™æ»©ä¸Šçš„æŸ¯åŸºçŠ¬â€çš„ç…§ç‰‡æ—¶ï¼Œæˆ‘ä»¬è¦èƒ½ä»åŒ…å«æ•°åäº¿å¼ å›¾ç‰‡çš„æ•°æ®åº“é‡Œï¼Œç¬é—´æ‰¾å‡ºæ‰€æœ‰å…¶ä»–â€œæ²™èˆä¸Šçš„æŸ¯åŸºçŠ¬â€æˆ–è€…ç±»ä¼¼çš„å›¾ç‰‡ã€‚ è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„æŒ‘æˆ˜ã€‚è®¡ç®—æœºæ˜¯å¦‚ä½•â€œçœ‹æ‡‚â€å¹¶æ¯”è¾ƒå›¾ç‰‡çš„å‘¢ï¼Ÿ ç¬¬ä¸€æ­¥ï¼šæŠŠå›¾ç‰‡å˜æˆâ€œæ•°å­—æŒ‡çº¹â€â€”â€”å‘é‡åŒ– è®¡ç®—æœºæ— æ³•ç›´æ¥ç†è§£å›¾ç‰‡ã€‚å®ƒé¦–å…ˆéœ€è¦é€šè¿‡ä¸€ä¸ªå¤æ‚çš„ç¥ç»ç½‘ç»œï¼ˆæ¯”å¦‚ ResNetï¼‰ï¼Œå°†æ¯ä¸€å¼ å›¾ç‰‡éƒ½è½¬æ¢æˆä¸€ä¸ªç”±å¾ˆå¤šæ•°å­—ç»„æˆçš„â€œåˆ—è¡¨â€ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå‘é‡ (Vector)ã€‚è¿™ä¸ªå‘é‡å°±æ˜¯è¿™å¼ å›¾ç‰‡çš„â€œæ•°å­—æŒ‡çº¹â€ï¼Œå®ƒæ•æ‰äº†å›¾ç‰‡çš„æ ¸å¿ƒç‰¹å¾ã€‚ å°ç™½ç†è§£ï¼š å°±åƒæˆ‘ä»¬ç»™äººåŠèº«ä»½è¯ï¼Œé™¤äº†ç…§ç‰‡ï¼Œè¿˜ä¼šè®°å½•èº«é«˜ã€ä½“é‡ã€è¡€å‹ç­‰ä¿¡æ¯ã€‚è¿™é‡Œçš„â€œå‘é‡â€å°±æ˜¯ä¸€å¼ å›¾ç‰‡çš„â€œæ•°å­—èº«ä»½è¯â€ï¼ŒåŒ…å«äº†æˆç™¾ä¸Šåƒä¸ªæè¿°å®ƒçš„â€œç‰¹å¾å€¼â€ã€‚ ä¸“ä¸šè¯´æ˜ï¼š æˆ‘ä»¬ä½¿ç”¨é¢„è®­ç»ƒçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆå¦‚CNNï¼‰æå–å›¾åƒçš„é«˜ç»´ç‰¹å¾åµŒå…¥ï¼ˆEmbeddingï¼‰ã€‚ä¾‹å¦‚ï¼Œä¸€å¼ å›¾ç‰‡å¯ä»¥è¢«è¡¨ç¤ºä¸ºä¸€ä¸ª128ç»´æˆ–æ›´é«˜ç»´åº¦çš„æµ®ç‚¹æ•°å‘é‡ o_rã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼Œå¯¹äºä¸€ä¸ªæŸ¥è¯¢å‘é‡ q_rï¼Œæ‰¾åˆ°æ•°æ®åº“ä¸­ä¸å®ƒæ¬§å‡ é‡Œå¾—è·ç¦» ||o_r - q_r|| æœ€å°çš„é‚£äº› o_rã€‚ ç¬¬äºŒæ­¥ï¼šæ•°æ®å¤§æ‰«é™¤â€”â€”å½’ä¸€åŒ– ç›´æ¥æ¯”è¾ƒè¿™äº›åŸå§‹çš„â€œæ•°å­—æŒ‡çº¹â€æ—¢æ…¢åˆå›°éš¾ã€‚æ•°æ®å¯èƒ½å­˜åœ¨æ•´ä½“çš„åç§»ï¼Œè€Œä¸”æ¯ä¸ªå‘é‡çš„â€œé•¿åº¦â€ï¼ˆæ•°å€¼å¤§å°çš„ç»¼åˆä½“ç°ï¼‰ä¹Ÿå„ä¸ç›¸åŒï¼Œä¼šå¹²æ‰°æˆ‘ä»¬å¯¹â€œæ–¹å‘â€ï¼ˆå†…å®¹ç›¸ä¼¼åº¦ï¼‰çš„åˆ¤æ–­ã€‚ æ“ä½œï¼š ä¸­å¿ƒåŒ– (Centering): æ‰¾åˆ°æ‰€æœ‰å›¾ç‰‡å‘é‡çš„â€œå¹³å‡ä½ç½®â€ï¼ˆå³è´¨å¿ƒ cï¼‰ï¼Œç„¶åè®©æ¯ä¸ªå‘é‡éƒ½å‡å»è¿™ä¸ªä¸­å¿ƒã€‚è¿™ç›¸å½“äºæŠŠæ•´ä¸ªåæ ‡ç³»çš„åŸç‚¹â€œæ¬â€åˆ°äº†æ•°æ®ä¸­å¿ƒã€‚ å½’ä¸€åŒ– (Normalization): å°†æ¯ä¸ªä¸­å¿ƒåŒ–åçš„å‘é‡ï¼Œéƒ½é™¤ä»¥å®ƒè‡ªèº«çš„é•¿åº¦ã€‚ ç»“æœï¼š ç»è¿‡è¿™ä¸€æ­¥ï¼Œæ‰€æœ‰çš„â€œæ•°å­—æŒ‡çº¹â€éƒ½å‘ç”Ÿäº†ä¸¤ä¸ªå˜åŒ–ï¼š å®ƒä»¬ä¸å†æ˜¯æ•£ä¹±çš„ï¼Œè€Œæ˜¯éƒ½å›´ç»•ç€åŒä¸€ä¸ªä¸­å¿ƒã€‚ å®ƒä»¬çš„â€œé•¿åº¦â€éƒ½å˜æˆäº† 1ã€‚å®ƒä»¬ç°åœ¨éƒ½â€œè¶´â€åœ¨ä¸€ä¸ªå·¨å¤§çš„ã€é«˜ç»´çš„â€œå•ä½çƒâ€çš„çƒé¢ä¸Šã€‚è¿™ä¸ªæ“ä½œä¿ç•™äº†å‘é‡çš„æ–¹å‘ï¼ˆä»£è¡¨å›¾ç‰‡å†…å®¹ï¼‰ï¼Œè€Œèˆå¼ƒäº†å…¶åŸå§‹çš„é•¿åº¦ã€‚ å°ç™½ç†è§£ï¼š æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰äººçš„èº«é«˜éƒ½ç»Ÿä¸€æ‹‰ä¼¸æˆ–å‹ç¼©åˆ°1ç±³8ï¼Œä½†ä¿æŒä»–ä»¬é«˜çŸ®èƒ–ç˜¦çš„â€œæ¯”ä¾‹â€ä¸å˜ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¤§å®¶å°±éƒ½ç«™åœ¨äº†åŒä¸€ä¸ªèµ·è·‘çº¿ä¸Šï¼Œæ¯”è¾ƒèµ·æ¥æ›´å…¬å¹³ã€‚ ä¸“ä¸šè¯´æ˜ï¼š æˆ‘ä»¬å°†æ¬§æ°è·ç¦»çš„è®¡ç®—é—®é¢˜ï¼Œé€šè¿‡ ||o_r - q_r||Â² = ||o_r - c||Â² + ||q_r - c||Â² - 2 Â· ||o_r - c|| Â· ||q_r - c|| Â· \u003cq, o\u003e è¿™ä¸ªå…¬å¼ï¼Œè½¬åŒ–ä¸ºäº†ä¸€ä¸ªæ±‚è§£å½’ä¸€åŒ–åçš„å•ä½å‘é‡ q å’Œ o ä¹‹é—´å†…ç§¯ \u003cq, o\u003e çš„é—®é¢˜ã€‚||o_r - c|| å¯ä»¥åœ¨ç´¢å¼•æ—¶é¢„è®¡ç®—ï¼Œ||q_r - c|| åœ¨æŸ¥è¯¢æ—¶è®¡ç®—ä¸€æ¬¡å³å¯ã€‚é—®é¢˜çš„æ ¸å¿ƒå˜æˆäº†å¦‚ä½•å¿«é€Ÿä¼°ç®— \u003cq, o\u003eã€‚ ç¬¬ä¸‰æ­¥ï¼šå»ºç«‹â€œå®‡å®™åæ ‡ç³»â€â€”â€”ç æœ¬æ„å»ºä¸éšæœºåŒ– å³ä½¿æ‰€æœ‰å‘é‡éƒ½åœ¨å•ä½çƒé¢ä¸Šï¼Œå®ƒä»¬çš„æ•°é‡ä¾ç„¶æ˜¯æµ·é‡çš„ã€‚é€ä¸€æ¯”è¾ƒå†…ç§¯è¿˜æ˜¯å¤ªæ…¢ã€‚æˆ‘ä»¬éœ€è¦ä¸€å¥—â€œå‚è€ƒåæ ‡ç³»â€æ¥å¿«é€Ÿç»™å‘é‡å®šä½ã€‚ æ“ä½œï¼š ç æœ¬ (Codebook): æˆ‘ä»¬åœ¨çƒé¢ä¸Šå»ºç«‹ä¸€å¥—â€œå‚è€ƒç‚¹â€ã€‚ä¸€ä¸ªç»å¦™çš„æ–¹æ³•æ˜¯ï¼Œåœ¨çƒå†…éƒ¨åµŒå…¥ä¸€ä¸ªè¶…ç«‹æ–¹ä½“ (Hypercube)ï¼Œå®ƒçš„æ‰€æœ‰é¡¶ç‚¹æ­£å¥½è½åœ¨çƒé¢ä¸Šã€‚è¿™äº›é¡¶ç‚¹éå¸¸å‡åŒ€ã€å¯¹ç§°åœ°åˆ†å¸ƒï¼Œæ˜¯ç†æƒ³çš„å‚è€ƒç‚¹ã€‚è¿™äº›é¡¶ç‚¹çš„é›†åˆï¼Œå°±æ˜¯æˆ‘ä»¬çš„â€œç æœ¬â€ã€‚ éšæœºåŒ– (Randomization): ä¸€ä¸ªå›ºå®šçš„ç æœ¬æœ‰å…¶â€œç›²åŒºâ€ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸ä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„ç«‹æ–¹ä½“ï¼Œè€Œæ˜¯å°†å®ƒè¿›è¡Œéšæœºæ—‹è½¬ã€‚æˆ‘ä»¬ç”ŸæˆMä¸ªï¼ˆæ¯”å¦‚16ä¸ªï¼‰ä¸åŒçš„éšæœºæ—‹è½¬ï¼Œå¾—åˆ°Mä¸ªå§¿æ€å„å¼‚çš„â€œç æœ¬â€ã€‚ å°ç™½ç†è§£ï¼š ä¸ºäº†å¿«é€Ÿæ‰¾åˆ°åœ°çƒä¸Šçš„æŸä¸ªåŸå¸‚ï¼Œæˆ‘ä»¬ä¸ä¼šå»æ‹¿å°ºå­é‡ã€‚æˆ‘ä»¬ä¼šå…ˆçœ‹å®ƒå±äºå“ªä¸ªå¤§æ´²ï¼ˆäºšæ´²ã€æ¬§æ´²â€¦ï¼‰ã€‚è¿™é‡Œçš„â€œç æœ¬â€å°±æ˜¯â€œä¸ƒå¤§æ´²â€çš„åˆ’åˆ†ã€‚ä½†å›ºå®šçš„ä¸ƒå¤§æ´²åˆ’åˆ†å¯èƒ½å¯¹æŸäº›è¾¹ç•ŒåŸå¸‚ä¸å‹å¥½ã€‚äºæ˜¯æˆ‘ä»¬å¹²è„†è®¾è®¡äº†Må¥—ä¸åŒçš„ã€éšæœºçš„â€œå¤§æ´²åˆ’åˆ†æ³•â€ï¼Œä»å¤šä¸ªè§’åº¦æ¥ç»™åŸå¸‚å®šä½ã€‚ ä¸“ä¸šè¯´æ˜ï¼š ç æœ¬ç”±è¶…ç«‹æ–¹ä½“çš„é¡¶ç‚¹ {-1, 1}^D æ„æˆã€‚æˆ‘ä»¬ç”ŸæˆMä¸ªéšæœºæ­£äº¤æ—‹è½¬çŸ©é˜µ R_1, ..., R_Mã€‚è¿™æ ·æˆ‘ä»¬å°±æ‹¥æœ‰äº†Mä¸ªç æœ¬ C_1, ..., C_Mï¼Œå…¶ä¸­ C_i æ˜¯ç”± R_i æ—‹è½¬åçš„è¶…ç«‹æ–¹ä½“é¡¶ç‚¹ç»„æˆã€‚ ç¬¬å››æ­¥ï¼šç»™æ¯å¼ å›¾ç‰‡æ‰“ä¸Šâ€œå‹ç¼©ç¼–ç â€â€”â€”ç´¢å¼•æ„å»º è¿™æ˜¯ç¦»çº¿å®Œæˆçš„å·¥ä½œï¼Œä¸ºæ•´ä¸ªæ•°æ®åº“å»ºç«‹ä¸€ä¸ªå¯ä»¥è¢«é—ªç”µæœç´¢çš„ç´¢å¼•ã€‚ æ“ä½œï¼š å¯¹äºæ•°æ®åº“ä¸­çš„æ¯ä¸€å¼ å›¾ç‰‡ï¼ˆå³æ¯ä¸€ä¸ªå‘é‡ oï¼‰ï¼Œæˆ‘ä»¬ï¼š ç”¨ä¹‹å‰ç”Ÿæˆçš„é‚£Mä¸ªæ—‹è½¬çŸ©é˜µï¼Œå»æ—‹è½¬ oã€‚ å°†Mä¸ªæ—‹è½¬åçš„ oï¼Œåˆ†åˆ«åœ¨Mä¸ªç æœ¬ä¸­æ‰¾åˆ°ç¦»å®ƒæœ€è¿‘çš„é‚£ä¸ªé¡¶ç‚¹ã€‚ å› ä¸ºè¶…ç«‹æ–¹ä½“çš„é¡¶ç‚¹åæ ‡åªæœ‰+1å’Œ-1ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨1ä¸ªæ¯”ç‰¹ï¼ˆ0æˆ–1ï¼‰æ¥è¡¨ç¤ºã€‚æ¯”å¦‚+1è®°ä¸º1ï¼Œ-1è®°ä¸º0ã€‚ è¿™æ ·ï¼Œæ¯ä¸ª o å°±è¢«è½¬æ¢æˆäº† Mä¸ªDç»´çš„äºŒè¿›åˆ¶ç ã€‚ ç»“æœï¼š ä¸€ä¸ªåŸæœ¬éœ€è¦æ•°åƒæ¯”ç‰¹å­˜å‚¨çš„æµ®ç‚¹æ•°å‘é‡ï¼Œç°åœ¨è¢«å‹ç¼©æˆäº†Mä¸ªDæ¯”ç‰¹çš„äºŒè¿›åˆ¶ç ã€‚å­˜å‚¨ç©ºé—´å¤§å¤§å‡å°‘ï¼Œè€Œä¸”ä¸ºåç»­çš„å¿«é€Ÿä½è¿ç®—æ¯”è¾ƒé“ºå¹³äº†é“è·¯ã€‚ å°ç™½ç†è§£ï¼š æˆ‘ä»¬ä¸ºå…¬å¸é‡Œçš„æ¯ä¸ªå‘˜å·¥ï¼Œéƒ½ä»Mä¸ªä¸åŒçš„è§’åº¦æ‹äº†ä¸€å¼ ç…§ç‰‡ï¼Œå¹¶æ ¹æ®ç…§ç‰‡ç”Ÿæˆäº†ä¸€ä¸ªæç®€çš„â€œç´ æç â€ï¼ˆäºŒè¿›åˆ¶ç ï¼‰ï¼Œå­˜å…¥ä»–çš„æ¡£æ¡ˆã€‚ ä¸“ä¸šè¯´æ˜ï¼š å¯¹äºæ¯ä¸ª oï¼Œæˆ‘ä»¬è®¡ç®— b_i = Quantize(R_i * o)ï¼Œå…¶ä¸­ i=1...Mã€‚Quantize å‡½æ•°æ‰¾åˆ°è¶…ç«‹æ–¹ä½“ä¸­æœ€è¿‘çš„é¡¶ç‚¹ï¼Œå¹¶å°†å…¶è¡¨ç¤ºä¸ºDæ¯”ç‰¹çš„äºŒè¿›åˆ¶ç  b_iã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿé¢„è®¡ç®—å¹¶å­˜å‚¨ \u003cÅ, o\u003eï¼Œå³é‡åŒ–è¯¯å·®é¡¹ï¼Œä¸ºåç»­çš„ç²¾ç¡®ä¼°ç®—åšå‡†å¤‡ã€‚ ç¬¬äº”æ­¥ï¼šé—ªç”µæœç´¢â€”â€”æŸ¥è¯¢ä¸ä¼°ç®— å½“ç”¨æˆ·ä¸Šä¼ æ–°å›¾ç‰‡ï¼ˆæŸ¥è¯¢å‘é‡ qï¼‰æ—¶ï¼Œå®","date":"2024-07-13","objectID":"/vector-search/:3:4","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"4. å¸¸è§çš„å‘é‡æ•°æ®åº“æå…¶ä¼˜åŠ£ ä»¥ä¸‹åˆ—ä¸¾äº†ä¸€äº›å¸¸è§çš„å‘é‡æ•°æ®åº“ï¼Œä»¥åŠä»–ä»¬çš„ä¼˜åŠ£åŠ¿, æœ‰äº›æ˜¯ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼Œæœ‰äº›æ˜¯å¯¹ç°æœ‰å…³ç³»å‹æ•°æ®åº“çš„æ‰©å±•ã€‚ ","date":"2024-07-13","objectID":"/vector-search/:4:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"4.1 Milvus Milvus æ˜¯ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„å¼€æºå‘é‡æ•°æ®åº“ï¼Œæ”¯æŒå¤šç§å‘é‡æœç´¢ç®—æ³•ï¼ŒåŒ…æ‹¬ HNSWï¼ŒDiskANNï¼ŒIVF ç­‰ã€‚ é™¤äº†å‘é‡æ£€ç´¢çš„åŸºæœ¬åŠŸèƒ½ï¼Œè¿˜æä¾› sharding, streaming data ingestion ä»¥åŠ hybrid search ç­‰åŠŸèƒ½ã€‚ Milvus é‡‡ç”¨çš„æ˜¯äº‘åŸç”Ÿçš„å­˜ç®—åˆ†ç¦»ï¼Œshared-everthing çš„æ¶æ„ï¼Œä¸”æ§åˆ¶é¢å’Œæ•°æ®é¢åˆ†ç¦»ã€‚å„ä¸ªç»„ä»¶éƒ½æ˜¯ç‹¬ç«‹ä¸”å¯æ¨ªå‘æ‹“å±•çš„ï¼Œåˆ†åˆ«ä¸ºï¼š æ¥å…¥å±‚(Access Layer)ï¼šç”±ä¸€ç»„æ— çŠ¶æ€ proxy ç»„æˆã€‚å®ƒå¯¹å¤–æä¾›ç”¨æˆ·è¿æ¥çš„ endpointï¼Œè´Ÿè´£éªŒè¯å®¢æˆ·ç«¯è¯·æ±‚å¹¶åˆå¹¶è¿”å›ç»“æœã€‚ å®ƒä½¿ç”¨Nginxã€Kubernetes Ingressã€NodePortã€LVS ç­‰è´Ÿè½½å‡è¡¡ç»„ä»¶æä¾›ç»Ÿä¸€çš„æœåŠ¡åœ°å€ã€‚ ç”±äº Milvus é‡‡ç”¨å¤§è§„æ¨¡å¹¶è¡Œå¤„ç† (MPP) æ¶æ„ï¼Œä»£ç†ä¼šèšåˆå¹¶åå¤„ç†ä¸­é—´ç»“æœï¼Œç„¶åå°†æœ€ç»ˆç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ åè°ƒæœåŠ¡(Coordinator Service)ï¼šè´Ÿè´£åˆ†é…ä»»åŠ¡ç»™æ‰§è¡ŒèŠ‚ç‚¹ï¼Œåˆ†åˆ«æœ‰ root coordã€data coordã€query coordã€‚ root coord: å¤„ç†æ•°æ®å®šä¹‰è¯­è¨€ (DDL) å’Œæ•°æ®æ§åˆ¶è¯­è¨€ (DCL) è¯·æ±‚ï¼Œä¾‹å¦‚åˆ›å»ºæˆ–åˆ é™¤é›†åˆã€åˆ†åŒºæˆ–ç´¢å¼•ï¼Œä»¥åŠç®¡ç† TSOï¼ˆæ—¶é—´æˆ³ Oracleï¼‰å’Œ time tickerã€‚ data coord: ç®¡ç† data ä»¥åŠ index èŠ‚ç‚¹æ‹“æ‰‘ï¼Œç»´æŠ¤å…ƒæ•°æ®ï¼Œè§¦å‘flushã€compactã€ç´¢å¼•æ„å»ºç­‰åå°æ•°æ®æ“ä½œã€‚ query coord: ç®¡ç†æŸ¥è¯¢èŠ‚ç‚¹ topology ï¼Œload balancing ä»¥åŠ growing segments åˆ° sealed segments è½¬æ¢. æ‰§è¡ŒèŠ‚ç‚¹(Worker Node)ï¼šæ‰§è¡Œä»åè°ƒæœåŠ¡åˆ†é…çš„ä»»åŠ¡ä»¥åŠ proxy DML å‘½ä»¤ã€‚ Query Nodeï¼šæ£€ç´¢å¢é‡æ—¥å¿—æ•°æ®ï¼Œå¹¶é€šè¿‡è®¢é˜… log broker å°†å…¶è½¬æ¢ä¸ºä¸æ–­å¢é•¿çš„æ®µï¼Œä»å¯¹è±¡å­˜å‚¨åŠ è½½å†å²æ•°æ®ï¼Œå¹¶åœ¨å‘é‡å’Œæ ‡é‡æ•°æ®ä¹‹é—´è¿è¡Œæ··åˆæœç´¢ã€‚ Data Nodeï¼šé€šè¿‡è®¢é˜… log broker æ¥è·å–å¢é‡æ—¥å¿—æ•°æ®ï¼Œå¤„ç†mutation è¯·æ±‚ï¼Œå¹¶å°†æ—¥å¿—æ•°æ®æ‰“åŒ…æˆæ—¥å¿—å¿«ç…§å¹¶å­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ä¸­ Index Nodeï¼šæ„å»ºç´¢å¼•ã€‚ç´¢å¼•èŠ‚ç‚¹ä¸éœ€è¦å¸¸é©»å†…å­˜ï¼Œå¯ä»¥é€šè¿‡Serverless æ¡†æ¶æ¥å®ç°ã€‚ å­˜å‚¨å±‚(Storage)ï¼šå¯¹è±¡å­˜å‚¨è´Ÿè´£å­˜å‚¨æ•°æ®ï¼Œå­˜å‚¨ Data files å’Œ Index filesã€‚ Meta Storage: å…ƒå­˜å‚¨å­˜å‚¨å…ƒæ•°æ®çš„å¿«ç…§ï¼Œä¾‹å¦‚ collection schema å’Œ message consumption checkpointsã€‚å­˜å‚¨å…ƒæ•°æ®éœ€è¦æé«˜çš„å¯ç”¨æ€§ã€å¼ºä¸€è‡´æ€§å’Œäº‹åŠ¡æ”¯æŒï¼Œå› æ­¤ Milvus é€‰æ‹©äº† etcd è¿›è¡Œå…ƒå­˜å‚¨ã€‚ Milvus è¿˜ä½¿ç”¨ etcd è¿›è¡ŒæœåŠ¡æ³¨å†Œå’Œå¥åº·æ£€æŸ¥ã€‚ Object Storage: å­˜å‚¨æ—¥å¿—çš„å¿«ç…§æ–‡ä»¶ã€æ ‡é‡å’Œå‘é‡æ•°æ®çš„ç´¢å¼•æ–‡ä»¶ä»¥åŠä¸­é—´æŸ¥è¯¢ç»“æœã€‚ Milvus ä½¿ç”¨ MinIO ä½œä¸ºå¯¹è±¡å­˜å‚¨ï¼Œå¯ä»¥è½»æ¾éƒ¨ç½²åœ¨ AWS S3 å’Œ Azure Blobã€‚ä½†å¯¹è±¡å­˜å‚¨çš„è®¿é—®å»¶è¿Ÿè¾ƒé«˜ï¼Œä¸”æŒ‰æŸ¥è¯¢æ¬¡æ•°æ”¶è´¹ã€‚ä¸ºäº†æé«˜æ€§èƒ½å¹¶é™ä½æˆæœ¬ï¼ŒMilvus è®¡åˆ’åœ¨åŸºäºå†…å­˜æˆ– SSD çš„ç¼“å­˜æ± ä¸Šå®ç°å†·çƒ­æ•°æ®åˆ†ç¦»ã€‚ Log Broker: å‘å¸ƒ-è®¢é˜…ç³»ç»Ÿï¼Œå®ƒè´Ÿè´£æµæ•°æ®æŒä¹…åŒ–å’Œäº‹ä»¶é€šçŸ¥ã€‚å½“å·¥ä½œèŠ‚ç‚¹ä»ç³»ç»Ÿæ•…éšœä¸­æ¢å¤æ—¶ï¼Œå®ƒè¿˜èƒ½ç¡®ä¿å¢é‡æ•°æ®çš„å®Œæ•´æ€§ã€‚ Milvus cluster ä½¿ç”¨ Pulsar ä½œä¸º log brokerï¼› Milvus standalone ä½¿ç”¨ RocksDB ä½œä¸º log brokerã€‚æ­¤å¤–ï¼Œlog broker å¯ä»¥å¾ˆå®¹æ˜“åœ°æ›¿æ¢ä¸ºKafkaç­‰æµæ•°æ®å­˜å‚¨å¹³å°ã€‚ Milvus çš„äº‘åŸç”Ÿæ¶æ„æ˜¯å…¶ä¼˜ç‚¹ï¼ŒåŒæ—¶ä¹Ÿç»™å¼€å‘è€…å¸¦æ¥äº†ä¸å°çš„æŒ‘æˆ˜ï¼Œä¾‹å¦‚æ–°æ¦‚å¿µçš„å­¦ä¹ ï¼Œä»¥åŠç›¸å…³ç»„ä»¶ Pulsar æˆ–è€… etcd å¸¦æ¥çš„è¿ç»´ç®¡ç†ä¸Šçš„æŒ‘æˆ˜ã€‚ ","date":"2024-07-13","objectID":"/vector-search/:4:1","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"4.4 Pinecone ","date":"2024-07-13","objectID":"/vector-search/:4:2","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"4.5 Qdrant ","date":"2024-07-13","objectID":"/vector-search/:4:3","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"4.6 Pgvector ","date":"2024-07-13","objectID":"/vector-search/:4:4","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"4.7 Pgvecto.rs ","date":"2024-07-13","objectID":"/vector-search/:4:5","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"4.8 VectorChord å¦‚ä½•é€‰å‹å‚è€ƒ å¤§æ¨¡å‹æ—¶ä»£å¦‚ä½•é€‰å‘é‡æ•°æ®åº“ï¼ŸMilvusï¼ˆZillizï¼‰ã€LanceDBã€Chromaã€Pineconeå››å¤§çƒ­é—¨æŠ€æœ¯å…¨è§£æï¼ã€‚ ","date":"2024-07-13","objectID":"/vector-search/:4:6","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"5. ä¼˜ç§€çš„å‘é‡æœç´¢åº“ä»¥åŠå‘é‡æ•°æ®åº“å¼€æºé¡¹ç›® ","date":"2024-07-13","objectID":"/vector-search/:5:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"6. å‘é‡æ•°æ®åº“å•†ä¸šåŒ–ä½ éœ€è¦çŸ¥é“ä»€ä¹ˆ ","date":"2024-07-13","objectID":"/vector-search/:6:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"7. æ€»ç»“ åœ¨è¿™é‡Œæˆ‘ä¹Ÿæ˜¯èµ°é©¬è§‚èŠ±çš„ä»‹ç»äº†ä¸€äº›å‘é‡æœç´¢çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥åŠä¸€äº›å¸¸è§çš„å‘é‡æœç´¢ç®—æ³•ï¼Œå‘é‡æœç´¢åº”ç”¨åœºæ™¯ï¼Œå‘é‡æœç´¢ç®—æ³•ä¼˜åŒ–ï¼Œå¸¸è§çš„å‘é‡æ•°æ®åº“æå…¶ä¼˜åŠ£åŠ¿ï¼Œä¼˜ç§€çš„å‘é‡æœç´¢åº“ä»¥åŠå‘é‡æ•°æ®åº“å¼€æºé¡¹ç›®ï¼Œåé¢è¿˜æ˜¯å¸Œæœ›å¯ä»¥åº”ç”¨åˆ°å®é™…çš„åœºæ™¯ä¸­ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½çš„äº†è§£å‘é‡æœç´¢ã€‚ ","date":"2024-07-13","objectID":"/vector-search/:7:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":["2024","vector search","Postgres"],"content":"8. å¼•ç”¨ éå¸¸æ„Ÿè°¢ Pinecone çš„æ–‡ç« ï¼Œè®©æˆ‘å¯¹å‘é‡æ•°æ®åº“æœ‰äº†æ›´æ·±çš„äº†è§£ã€‚ https://www.pinecone.io/learn/series/faiss/vector-indexes/ https://www.pinecone.io/learn/series/faiss/locality-sensitive-hashing/ https://zhuanlan.zhihu.com/p/379372268 https://songlinlife.github.io/2022/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%EF%BC%9ANSG/ https://www.xiemingzhao.com/posts/hnswAlgo.html https://whenever5225.github.io/2020/05/11/hnsw-heuristic/ Search Engine For AIï¼šé«˜ç»´æ•°æ®æ£€ç´¢å·¥ä¸šçº§è§£å†³æ–¹æ¡ˆ https://zhuanlan.zhihu.com/p/50143204 https://mp.weixin.qq.com/s/AelU5O52Ed0Zx7f9867UNw ","date":"2024-07-13","objectID":"/vector-search/:8:0","tags":["vector search","Postgres"],"title":"å‘é‡æ•°æ®åº“ä¸­çš„é—¨é—¨é“é“","uri":"/vector-search/"},{"categories":null,"content":"å…³äºè¿œä¸œ","date":"2022-12-29","objectID":"/about/","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"},{"categories":null,"content":"ğŸ“« æ‚¨å¦‚æœæƒ³è”ç³»æˆ‘ï¼Œå¯ä»¥ç›´æ¥å‘é€é‚®ä»¶ï¼Œé‚®ç®±åœ°å€ xieydd@gmail.com,æˆ–è€…æ‚¨å¯ä»¥åŠ æˆ‘çš„å¾®ä¿¡ echo -n 'eGlleWRkX2hhaGEK' | base64 -d. ğŸ’» æˆªæ­¢åˆ° 2024 å¹´ï¼Œæœ‰ç€è¶…è¿‡ 6 å¹´çš„ AI Infra çš„ç»éªŒï¼š ","date":"2022-12-29","objectID":"/about/:0:0","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"},{"categories":null,"content":"2018-2021.2ï¼ˆå«å®ä¹ ï¼‰Unisound åœ¨ AI ç®—æ³•å…¬å¸ Unisound è´Ÿè´£ Atlas è¶…ç®—å¹³å°çš„ç ”å‘å’Œè¿ç»´ï¼Œæ”¯æŒ NLP ä»¥åŠ CV æ¨¡å‹è®­ç»ƒã€‚ä¸»è¦å·¥ä½œå¦‚ä¸‹ï¼š å¼€å‘å¤§è§„æ¨¡æ™ºèƒ½è°ƒåº¦ç³»ç»Ÿä»¥ä¼˜åŒ–å¤šç§Ÿæˆ·èµ„æºåˆ†é… ä¼˜åŒ–é«˜æ€§èƒ½åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ Lustre çš„æ€§èƒ½ æ„å»ºå¤šå±‚ç¼“å­˜çš„äº‘åŸç”Ÿæ¶æ„ä»¥åŠ é€Ÿ AI æ¨¡å‹è®­ç»ƒ åœ¨ Unisound ä»äº‹ 8 Bit è®­ç»ƒåŠæ¨ç†ä¼˜åŒ–å·¥ä½œï¼Œè½åœ°æ¨¡å‹åœ¨ NPU ä»¥åŠ NVIDIA Edge Device çš„ä¼˜åŒ–å·¥ä½œã€‚ ","date":"2022-12-29","objectID":"/about/:0:1","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"},{"categories":null,"content":"2021.2-2023.5 Tencent Cloud æ„å»ºå…¬æœ‰äº‘å¤§è§„æ¨¡ AI å¹³å°ï¼š é€šè¿‡ EKS ï¼ˆElastic Kubernetes Serviceï¼‰ æ„å»ºé«˜æ€§èƒ½ã€å¯ä¼¸ç¼©çš„å¼¹æ€§ç¦»çº¿è®­ç»ƒå¹³å°ã€‚ ç»“åˆå…¬æœ‰äº‘å¯¹è±¡å­˜å‚¨ä»¥åŠåŠ é€Ÿå™¨ GooseFS, æ„å»ºäº‘ä¸Šé«˜æ€§èƒ½ç¼“å­˜è°ƒåº¦ç³»ç»Ÿ æ„å»º FinOps åŸºç¡€è®¾æ–½å¸®åŠ©å…¬å…±äº‘ä¸­çš„å®¢æˆ·æ›´è½»æ¾åœ°ç®¡ç†ä¼˜åŒ–äº‘æˆæœ¬ï¼Œæå‡äº‘èµ„æºåˆ©ç”¨ç‡ï¼š é€šè¿‡è°ƒåº¦æ—¶ä»¥åŠé‡è°ƒåº¦ä¼˜åŒ–ï¼Œé€šè¿‡é«˜ä½ä¼˜ä»»åŠ¡è¯†åˆ«ï¼Œæ™ºèƒ½å¼¹æ€§æ‰©ç¼©å®¹ã€‚ ç»“åˆè…¾è®¯å¦‚æ„å†…æ ¸è°ƒåº¦å™¨ä¼˜åŒ–ä»¥åŠå¯è§‚æµ‹æ€§ï¼Œåœ¨ä¿è¯æœåŠ¡è´¨é‡çš„åŒæ—¶è¿›è¡Œæˆæœ¬ä¼˜åŒ– åœ¨å†…éƒ¨äº‘ä¸­å¤§è§„æ¨¡æ¨å‡ºé™ä½æˆæœ¬è®¡åˆ’ï¼Œé€šè¿‡èµ„æºçš„åˆç†åˆ†é…ï¼Œæå‡èµ„æºåˆ©ç”¨ç‡ ","date":"2022-12-29","objectID":"/about/:0:2","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"},{"categories":null,"content":"2023.5-è‡³ä»Š Tensorchord è´Ÿè´£åœ¨ GCP ä¸Šæ„å»º Serverless Inference å¹³å° ModelZï¼Œ æä¾›æè‡´çš„å†·å¯åŠ¨ä¼˜åŒ–æ¨¡å‹æœåŠ¡æ¨ç†æœåŠ¡ï¼š é€šè¿‡æ„å»ºç¼“å­˜æ¨¡å‹æœåŠ¡ã€é•œåƒé¢„çƒ­ç­‰æ‰‹æ®µä¼˜åŒ–æ¨¡å‹æœåŠ¡çš„å†·å¯åŠ¨æ—¶é—´ å¼•å…¥ JuiceFS æ„å»ºé«˜æ€§èƒ½ç¼“å­˜è°ƒåº¦ç³»ç»Ÿï¼Œæå‡æ¨¡å‹æœåŠ¡çš„æ€§èƒ½ è´Ÿè´£æ•´ä¸ª Cloud Team, æ„å»ºå‘é‡æ•°æ®åº“ VectorChord çš„äº‘æœåŠ¡ä»¥åŠå®¢æˆ·æ”¯æŒ VectorChord Cloudï¼š åœ¨ AWS ä¸Šæ„å»ºåŸºäº Postgres çš„å‘é‡æ•°æ®åº“ï¼Œå®ç°æ§åˆ¶é¢ã€æ•°æ®é¢åˆ†ç¦»ï¼ŒBYOC(Bring Your Own Cloud)ã€BYOD(Bring Your Own Data) ç­‰åŠŸèƒ½ å¼•å…¥äº‘åŸç”Ÿæ¶æ„ï¼Œå®ç° Postgres å­˜ç®—åˆ†ç¦»ã€é«˜å¯ç”¨ã€Backupã€PITR(Point-In-Time Recovery)ã€In-Place Upgrade ç­‰åŠŸèƒ½ æŠ€èƒ½æ ˆï¼šKubernetes, GCP, AWS, Kubeflow, FinOps, RAG, Vector Database, Storage Accelerate, Tensorflow , Pytorch, Cloud Native, MLOps, AI Infra, etc. ","date":"2022-12-29","objectID":"/about/:0:3","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"},{"categories":null,"content":"å¼€æºé¡¹ç›® ğŸŒ± ç›®å‰ä¸“æ³¨åœ¨ MLOps ä»¥åŠ FinOps é¢†åŸŸ,è´¡çŒ®äº†ä¸€äº›å¼€æºé¡¹ç›®ï¼š fluid Fluid, elastic data abstraction and acceleration for BigData/AI applications in cloud. (Project under CNCF) crane Crane is a FinOps Platform for Cloud Resource Analytics and Economics in Kubernetes clusters. The goal is not only to help users to manage cloud cost easier but also ensure the quality of applications. crane-scheduler Crane scheduler is a Kubernetes scheduler which can schedule pod based on actual node load. creator Creator is the brain of crane project, contains crane core algorithm module and evaluation module. openmodelz One-click machine learning deployment (LLM, text-to-image and so on) at scale on any cluster (GCP, AWS, Lambda labs, your home lab, or even a single machine). clusternet [CNCF Sandbox Project] Managing your Kubernetes clusters (including public, private, edge, etc.) as easily as visiting the Internet vectorchord Scalable, fast, and disk-friendly vector search in Postgres, the successor of pgvecto.rs. ","date":"2022-12-29","objectID":"/about/:0:4","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"},{"categories":null,"content":"æ¨èåšå®¢ Type Author/Company Blog URL Infra Chris Riccomini https://materializedview.io/ Infra Jack Vanlightly https://jack-vanlightly.com/ Math and Science è‹å‰‘æ— https://kexue.fm/ AI Infra Colfax https://research.colfax-intl.com/blog/ Postgres Gabriele Bartolini https://www.gabrielebartolini.it/articles/ AI Sebastian Raschka https://magazine.sebastianraschka.com/archive?sort=new AI Algorithm Tom Yeh https://www.byhand.ai/ AI Infra Chip Huyen https://huyenchip.com/blog/ ","date":"2022-12-29","objectID":"/about/:0:5","tags":null,"title":"å…³äºè¿œä¸œ","uri":"/about/"}]